<?php if ( ! defined('BASEPATH')) exit('No direct script access allowed');

class Test extends CI_Controller {

	public function __construct(){
		parent::__construct();

		//$this->module->is_log_in();
	}
	
	public function enroll_classlist()
	{
		$section = $this->module->table_where('v_sy_section', array('sy_id' => $this->module->get_active_sy()));

		foreach($section->result() as $r){
			$sec_id = $r->sec_id;

			//echo $r->sec_name.'<br/>';
			
			$student = $this->module->get_query("SELECT * FROM v_student_enrollment_assessment WHERE stud_id NOT IN (SELECT stud_id FROM student_class_list) AND sec_id = ".$sec_id." ");

			foreach($student->result() as $s){
				$student_data = array(
					'stud_type' 		=> $s->se_stud_type,
					'stud_id' 			=> $s->stud_id,
					'stud_lastname' 	=> $s->stud_lastname,
					'stud_firstname' 	=> $s->stud_firstname,
					'stud_birthdate' 	=> $s->stud_birthdate,
					'lvl_id' 			=> $s->lvl_id,
					'sec_id' 			=> $s->sec_id,
					'sy_id' 			=> $s->sy_id,
					'cl_is_reserved' 	=> 'N',
					'cl_date_reserved' 	=> '0000-00-00',
					'cl_date_enrolled' 	=> date('Y-m-d', strtotime($s->se_date_enrolled)),
					'cl_status' 		=> $s->se_status
				);
				echo '<pre>';
				print_r($student_data);

				$this->module->insert('student_class_list', $student_data);
			}
		}
	}



	public function generate_assessment(){
		$section = $this->module->table_where('v_sy_section', array('sy_id' => $this->module->get_active_sy()));
	}


	public function update_fee_sched(){

		$get_table = $this->module->get_table('fee_sched');

		foreach($get_table->result() as $r){
			$fee_id = $r->fee_id;

			$fee_full_amount = $r->fee_amnt_to_pay + $r->fee_july + $r->fee_aug + $r->fee_sept + $r->fee_oct + $r->fee_nov + $r->fee_dec + $r->fee_jan + $r->fee_feb;

			$this->module->update('fee_sched', array('fee_full_amount' => $fee_full_amount), array('fee_id' => $fee_id));
		}

	}

	public function generate_balance(){

		$sy_id 	= $this->module->get_active_sy();
		$fees	= $this->module->table_where('v_student_fees', array('sy_id' => $sy_id));

		foreach($fees->result() as $r){

			$stud_name 		= $r->stud_lastname.', '.$r->stud_firstname;

			$stud_id 		= $r->stud_id;
			$sib_discount 	= $r->sad_has_sib_discount;
			$dept_name 		= $r->dept_name;
			$sa_is_scholar  = $r->sa_is_scholar;

			$lvl_section 	= $r->lvl_name.'-'.$r->sec_name;
			$sec_id 		= $r->sec_id; 

			//FEE TABLE
			$fee_type 			= $r->fee_type;
			$fee_tf 			= $r->fee_tf;
			$fee_other_schl_fee = $r->fee_other_schl_fee;
			$enrollment_payment = $r->sad_sub_total;

			//SCHOLAR 
			$scholar_tf 		= $r->sad_scholar_tuition_fee;
			$scholar_misc 		= $r->sad_scholar_miscellaneous_fee;
			
			//INITIALIZATION
			$inst_amnt 			= 0;
			$misc				= 0;
			$discount 			= 0.10; // 10% of Tuition Fee
			$monthly_misc 		= 300;
			$quarterly_misc 	= 800;
			$semestral_misc 	= 2400;
			$out_balance 		= 0;
			$multiplier 		= 0;

			$tuition_fee 		= 0;
			$miscelleneous_fee  = 0;


			switch ($fee_type) {
				case 'MONTHLY':
					$misc 		= $monthly_misc;
					$multiplier = 8;
					break;
				case 'QUARTERLY':
					$misc 		= $quarterly_misc;
					$multiplier = 3;
					break;
				case 'SEMESTRAL':
					$misc 		= $semestral_misc;
					$multiplier = 1;
					break;
				
				default:
					$misc 		= 0;
					$multiplier = 0;
					break;
			}


			// CASH PAYMENT
			if($fee_type <> 'CASH'){

				// CHECK IF SCHOLAR
				if($sa_is_scholar == 'N'){

					// CHECK IF HAS SIBLING DISCOUNT
					if($sib_discount == 'N'){
						if($dept_name == 'Pre-School'){
							$inst_amnt = $fee_tf;

							$tuition_fee 		= $fee_tf;
							$miscelleneous_fee 	= 0;
						}else{
							$inst_amnt = ($fee_tf + $misc) ;

							$tuition_fee 		= $fee_tf;
							$miscelleneous_fee 	= $misc;
						}
					}else{

						if($dept_name == 'Pre-School'){
							$inst_amnt = ($fee_tf  - ($fee_tf * $discount));

							$tuition_fee 		= $inst_amnt;
							$miscelleneous_fee 	= 0;

						}else{
							$inst_amnt = $fee_tf - ($fee_tf * $discount) + $misc ;

							$tuition_fee 		= $fee_tf - ($fee_tf * $discount);
							$miscelleneous_fee 	= $misc;
						}
						
					}

					$out_balance 	= $inst_amnt * $multiplier;
				}else{

					// FOR SCHOLARS
					$inst_amnt 		= $r->sad_scholar_sub_total;
					$out_balance 	= $inst_amnt * 10;

					$tuition_fee 		= $scholar_tf;
					$miscelleneous_fee 	= $scholar_misc / 10;
				}
				

			}else{
				$inst_amnt 		= 0;
				$out_balance 	= 0;

				$tuition_fee 		= $scholar_tf;
				$miscelleneous_fee 	= $scholar_misc;
				
			}


			$balance_data = array(
				'sy_id' 			=> $sy_id,
				'stud_id' 			=> $stud_id,
				'stb_fee_type' 		=> $fee_type,
				'stb_balance' 		=> $out_balance,
				'stb_tf' 			=> $tuition_fee,
				'stb_misc' 			=> $miscelleneous_fee,
				'stb_ins_amount' 	=> $inst_amnt

			);

			//echo '<pre>';
			//print_r($balance_data);


			$check = $this->module->table_where('student_tf_balance', array('sy_id' => $sy_id, 'stud_id' 	=> $stud_id) );

			//echo $check->num_rows();

			if($check->num_rows() <= 0 ){
				$this->module->insert('student_tf_balance', $balance_data);
				echo 'inserted<br/>';
			}else{
				echo 'record exist<br/>';
			}

			



			//echo $stud_id.'  '.$stud_name .' | Type '.$fee_type.' | Inst: '.$inst_amnt.' | Balance: '.$out_balance.' | TF: '.$tuition_fee.' | MS: '.$miscelleneous_fee.'<br/>';

			//$tf_payment  = $tf_payment->num_rows() < 1 ? 0 : $tf_payment->row('tf_paid');

			
		}

	}



	public function gen_mode_counter(){

		$mode = $this->module->table_where('v_student_mode_payment', array('sy_id' => $this->module->get_active_sy() )) ;


		$scholar 	= 0;
		$discounted = 0; 

		echo '<table class="table table-bordered" >';
		echo '<thead>';
		echo '<th>Level Name</th>';
		echo '<th>Mode of Payment</th>';
		echo '<th>Sibling Discount</th>';
		echo '<th>Schoalr</th>';
		echo '<th>Count</th>';
		echo '</thead>';

		echo '<tbody>';
		foreach ($mode->result() as $r) {
			echo '<tr>';
			echo '<td>'.$r->lvl_name.'</td>';
			echo '<td>'.$r->lvl_name.'</td>';
			echo '<td>'.$r->lvl_name.'</td>';
			echo '<td>'.$r->lvl_name.'</td>';
			echo '<td>'.$r->lvl_name.'</td>';
			echo '</tr>';

		}

		echo '</tbody>';
		echo '</table>';

	}

} /*End of file*/