<?php if ( ! defined('BASEPATH')) exit('No direct script access allowed');

class Auth extends CI_Controller {

	public function __construct(){
		parent::__construct();

		//$this->module->is_log_in();
	}
	
	public function index()
	{

		

		if(!$this->input->is_ajax_request())
			{
				$data['title'] 	=	"Login";
				$this->load->view('login',$data);
				
			}
		else
			{
				$username = $this->input->post('usr_name',true);
				$password = $this->input->post('usr_password',true);

				$chk = $this->module->table_where('user',array("usr_name"=> $username,"usr_password"=> $password));

				if($chk->num_rows < 1 )
					{
						$this->module->my_return(false,"Your username or password doesn't match in any account");
					}
				else
					{
						$u = $chk->row();
						$usr_type 						= $u->usr_type;
						$sess_data['usr_id'] 			= $u->usr_id;
						$sess_data['tch_id'] 			= $u->tch_id;
						$sess_data['usr_firstname'] 	= ucfirst($u->usr_firstname);
						$sess_data['usr_lastname'] 		= ucfirst($u->usr_lastname);
						$sess_data['usr_type'] 			= $usr_type;
						$sess_data['usr_name']			= $u->usr_name;
						$sess_data['usr_is_login']		= true;
						
						$landing = '';

						switch ($usr_type) {
							case 'Admin':
								$landing 	= 'admin';
							break;

							case 'Faculty':
								$landing 	= 'grading';
							break;

							default:
								$landing 	= 'admin';
								break;
						}

						$sess_data['landing'] 	=	$landing;

						$this->session->set_userdata($sess_data);
						
						switch ($usr_type) {
							case 'Admin':
								$this->module->my_return(true,"admin");
								//$landing 	= 'admin';
							break;

							case 'Faculty':
								$this->module->my_return(true,"grading");
								//$landing 	= 'grading';
							break;

							default:
								$this->module->my_return(true,"admin");
								//$landing 	= 'admin';
								break;
						}

						

						
					}
			}
	}

	public function logout(){
		delete_cookie("ci_session");
		$sess_data['usr_id'] 			= "";
		$sess_data['tch_id'] 			= "";
		$sess_data['usr_firstname'] 	= "";
		$sess_data['usr_lastname'] 		= "";
		$sess_data['usr_type'] 			= "";
		$sess_data['usr_name']			= "";
		$sess_data['landing']			= "";
		$sess_data['usr_is_login']		= false;
	
		
		$this->session->unset_userdata('usr_id');
		$this->session->unset_userdata('tch_id');
		$this->session->unset_userdata('usr_firstname');
		$this->session->unset_userdata('usr_lastname');
		$this->session->unset_userdata('usr_type');
		$this->session->unset_userdata('usr_name');
		$this->session->unset_userdata('usr_is_login');
		$this->session->unset_userdata('landing');

		$this->session->unset_userdata($sess_data);
		$this->session->sess_destroy();
		
		header("cache-Control: no-store, no-cache, must-revalidate");
		header("cache-Control: post-check=0, pre-check=0", false);
		header("Pragma: no-cache");
		header("Expires: Sat, 26 Jul 1997 05:00:00 GMT"); // Date in the past
		redirect('auth','refresh'); 
	}

}
