<?php if ( ! defined('BASEPATH')) exit('No direct script access allowed');

class Portal extends CI_Controller {

	function __construct(){

		parent::__construct();

		$is_login 	= $this->session->userdata('prtl_is_login');

		if($is_login){
			redirect('home');
		}

		//echo $is_login;
	}


	public function index()
	{
		$data['title'] = 'Log into Isidore Portal';
		$this->load->view('portal/login', $data);
	}


	public function auth(){

		if(!$this->input->is_ajax_request())
			{
				$data['title'] 	=	"Login to Isidore Portal";
				$this->load->view('portal/login',$data);
				
			}
		else
			{
				$username = $this->input->post('usr_name',true);
				$password = $this->input->post('usr_password',true);

				$chk = $this->module->table_where('portal_user',array("username"=> $username));

				if($chk->num_rows < 1 )
					{
						$this->module->my_return(false,"Your username doesn't match in any account");
					}
				else
					{
						$u 		= $chk->row();
						$hash 	= $u->password;

						if(!password_verify($password, $hash)){
							$this->module->my_return(false,"<strong>Invalid Email or Password</strong>. Try Again.");
						}else{
							$is_approve = $u->prtl_approve;
							$role 		= $u->prtl_role;


							if($is_approve == 'Y' ){
								$sess_data['prtl_id'] 		= $u->prtl_id;
								$sess_data['prtl_fname'] 	= ucfirst($u->prtl_fname);
								$sess_data['prtl_lname'] 	= ucfirst($u->prtl_lname);
								$sess_data['prtl_gender']	= $u->prtl_gender;
								$sess_data['username']		= $u->username;
								$sess_data['prtl_is_login']	= true;
								$sess_data['prtl_role']		= $role;

								$this->session->set_userdata($sess_data);

								if($role == 'A'){
									$this->module->my_return(true,"padmin");
								}else{
									$this->module->my_return(true,"home");
								}

								
								//$this->module->my_return(true,"parent");

							}else{
								$this->module->my_return(false,"Please check your email to confirm your registration or contact system administrator");
							}
						}
			
						
					}
			}

	}


	private function check_isvalidated(){
        if(! $this->session->userdata('usr_is_login')){
            redirect('auth');
        }
    }


	public function valid_password($password = '')
	{
		$password = trim($password);

		$regex_lowercase = '/[a-z]/';
		$regex_uppercase = '/[A-Z]/';
		$regex_number = '/[0-9]/';
		$regex_special = '/[!@#$%^&*()\-_=+{};:,<.>ยง~]/';

		if (empty($password))
		{
			$this->form_validation->set_message('valid_password', 'The password field is required.');

			return FALSE;
		}

		if (preg_match_all($regex_lowercase, $password) < 1)
		{
			$this->form_validation->set_message('valid_password', 'The password field must be at least one lowercase letter.');

			return FALSE;
		}

		if (preg_match_all($regex_uppercase, $password) < 1)
		{
			$this->form_validation->set_message('valid_password', 'The password field must be at least one uppercase letter.');

			return FALSE;
		}

		if (preg_match_all($regex_number, $password) < 1)
		{
			$this->form_validation->set_message('valid_password', 'The password field must have at least one number.');

			return FALSE;
		}

		if (preg_match_all($regex_special, $password) < 1)
		{
			$this->form_validation->set_message('valid_password', 'The password field must have at least one special character.' . ' ' . htmlentities('!@#$%^&*()\-_=+{};:,<.>ยง~'));

			return FALSE;
		}

		if (strlen($password) < 5)
		{
			$this->form_validation->set_message('valid_password', 'The password field must be at least 5 characters in length.');

			return FALSE;
		}

		if (strlen($password) > 32)
		{
			$this->form_validation->set_message('valid_password', 'The password field cannot exceed 32 characters in length.');

			return FALSE;
		}

		return TRUE;
	}

	public function create_account(){
		if(!$this->input->is_ajax_request())
			{
				$data['title'] 	=	"Sign up for Isidore Portal";
				$this->load->view('portal/create_account',$data);
				
			}
		else
			{
				$this->form_validation->set_message('is_unique', 'The %s is already taken.');

				$this->form_validation->set_rules('usr_name', 'Email Address', 'trim|required|valid_email|is_unique[portal_user.username]');
				$this->form_validation->set_rules('usr_password', 'Password', 'trim|required|callback_valid_password');
				$this->form_validation->set_rules('usr_confirm_password', 'Confirm Password', 'required|matches[usr_password]');
				//$this->form_validation->set_rules('prtl_contact', 'Contact Number ', 'required|regex_match[/^[0-9]{11}$/]');
				$this->form_validation->set_rules('prtl_gender', 'Gender ', 'required');

				if ($this->form_validation->run() == FALSE)
	                {
	                	$this->module->my_return(false, validation_errors());
	                }
	            else
	                {	
	                	$fname 		= $this->input->post('prtl_fname', true);
	                	$lname 		= $this->input->post('prtl_lname', true);
	                	$mname 		= $this->input->post('prtl_mname', true);
	                	$gender 	= $this->input->post('prtl_gender', true);
	                	//$contact 	= $this->input->post('prtl_contact', true);
	                	$email 		= $this->input->post('usr_name', true); /*username*/
	                	$password 	= $this->input->post('usr_password', true);


	                	$data = array(
	                		'prtl_fname' 		=> ucwords($fname),
	                		'prtl_lname' 		=> ucwords($lname),
	                		'prtl_gender' 		=> $gender,
	                		'username' 			=> $email,
	                		'password' 			=> password_hash($password, PASSWORD_DEFAULT),
	                		'prtl_approve'		=> 'N',
	                		'prtl_date_register'=> date('Y-m-d')
	                	);
	                	$this->module->insert('portal_user', $data);
	                	
	                	$prtl_id = $this->db->insert_id();

	                	/*$msg = '<div style="background-color:#f4f4f4;margin:0!important;padding:0!important">

							            <table border="0" cellpadding="0" cellspacing="0" width="100%">
							                
							                <tbody><tr bgcolor="#000421">
							                    <td align="center">
							                        <table border="0" cellpadding="0" cellspacing="0" width="552px">
							                            <tbody><tr>
							                                <td style="text-align: center">
							                                  <br><br><br>
							                                    <img src="http://portal.isidore.edu.ph/asset/images/logo_portal_email.png" alt="" width="70%">
							                                  <br><br><br>
							                                </td>
							                                
							                            </tr>
							                        </tbody></table>
							                    </td>
							                </tr>

							                
							                <tr>
							                    <td bgcolor="#000421" align="center" style="padding:0px 10px 0px 10px">
							                        <table border="0" cellpadding="0" cellspacing="0" width="552px">
							                            <tbody>
							                              <tr>
							                                <td bgcolor="#ffffff" align="center" valign="top" style="padding:40px 20px 20px 20px;border-radius:4px 4px 0px 0px;color:#111111;">
							                                    <h1 style="font-size:32px;font-weight:400;margin:0">Email Confirmation</h1>
							                                  </td>
							                              </tr>
							                          </tbody>
							                        </table>
							                    </td>
							                </tr>

							                
							                <tr>
							                    <td bgcolor="#f4f4f4" align="center" style="padding:0px 20px 0px 20px">
							                        <table border="0" cellpadding="0" cellspacing="0" width="552px">
							                          
							                          <tbody><tr>
							                            <td bgcolor="#ffffff" align="center" style="padding:20px 30px 40px 30px;color:#333;>
							                              <p style="margin:0;">Hello <strong>'.ucwords($fname).'!</strong></p>
							                            </td>
							                          </tr>
							                          <tr>
							                            <td bgcolor="#ffffff" align="center" style="padding:20px 50px 40px 50px;color:#333;">
							                              <p style="margin:0">Thank you for your registration! You can confirm your email account through the link below:</p>
							                            </td>
							                          </tr>
							                          
							                          <tr>
							                            <td bgcolor="#ffffff" align="left">
							                              <table width="100%" border="0" cellspacing="0" cellpadding="0">
							                                <tbody>
							                                  <tr>
							                                    <td bgcolor="#ffffff" align="center" style="padding:20px 30px 60px 30px">
							                                      <table border="0" cellspacing="0" cellpadding="0">
							                                          <tbody>
							                                            <tr>
							                                                <td align="center" bgcolor="#1f4495" style="border-radius:35px">
							                                                <a href="http://portal.isidore.edu.ph/portal/verify_email/'.$prtl_id.'" style="font-size:1em;color:#ffffff;text-decoration:none;color:#ffffff;text-decoration:none;padding:15px 45px;display:inline-block;text-align:center" target="_blank" data-saferedirecturl="http://portal.isidore.edu.ph/portal/verify_email/'.$prtl_id.'">Click here</a>
							                                              </td>
							                                            </tr>
							                                        </tbody>
							                                      </table>
							                                  </td>
							                                </tr>
							                              </tbody></table>
							                            </td>
							                          </tr>
							                        </tbody></table>
							                    </td>
							                </tr>

							                <tr>
							                    <td align="center" style="padding:0px 10px 0px 10px">
							                        <table border="0" cellpadding="0" cellspacing="0" width="552px">
							                            <tbody>
							                              <tr>
							                              <td bgcolor="#f4f4f4" align="left" style="padding:0px 90px 90px 90px;color:#666666;font-size:14px;font-weight:400;line-height:18px">
							                              </td>
							                            </tr>
							                          </tbody>
							                        </table>
							                    </td>
							                </tr>

							               
							            </tbody></table>';*/

						$msg 	= '<img src="http://portal.isidore.edu.ph/asset/images/logo_portal_dark.png" width="300px" >
									<br/><br/>

									<h2>Email Confirmation</h2>
									<h3>Hello <strong>'.ucwords($fname).'!</strong></h3>
							
									<p>Thank you for your registration! You can confirm your email account through the link below:</p>

								
									<a href="http://portal.isidore.edu.ph/portal/verify_email/'.$prtl_id.'" style="background-color:#1f4495;border:1px solid #1f4495;border-radius:3px;color:#ffffff;display:inline-block;font-family:sans-serif;font-size:14px;line-height:30px;text-align:center;text-decoration:none;width:150px;-webkit-text-size-adjust:none;mso-hide:all;">Confirm</a>

									<p>
										If there was a problem accessing the button, please click this link: http://portal.isidore.edu.ph/portal/verify_email/'.$prtl_id.'										
									</p>
									<p>NOTE: Do NOT forward this email or share this email to anyone.</p>';

						$subject = 'Isidore Portal - Email Confirmation';

	                	if($this->send_email($msg, $email, $subject )){
	                		$this->module->my_return(true, 'Success');
	                	}else{
	                		$this->module->delete('portal_user', array('prtl_id' => $prtl_id));
	                		$this->module->my_return(false, 'Something went wrong.');
	                	}

	                	

	                }

			}

	}

	public function verify_email(){
		$data['title'] 	= 'isidore Portal - Email Verification';
		$prtl_id 	 	= $this->uri->segment(3);

		$check_prtl = $this->module->table_where('portal_user', array('prtl_id' => $prtl_id));

		if($check_prtl->num_rows() > 0){
			if($this->module->update('portal_user', array('prtl_approve' => 'Y'), array('prtl_id' => $prtl_id))){
				$data['msg'] = 'success';
			}
			//$this->load->view('portal/verify_email', $data);
		}else{
			//$this->load->view('portal/verify_email', $data);
				$data['msg'] = 'Something went wrong please try again later.';
		}

		$this->load->view('portal/verify_email', $data);
		
	}



	public function send_email($msg, $email, $subject){
    
	    $config = array(

	      'protocol'    => 'smtp',
	      'smtp_host'   => 'ssl://smtp.webfaction.com',
	      'smtp_port'   => '465',
	      'smtp_user'   => 'admin_isidore',
	      'smtp_pass'   => 'idsis2016xyz',
	      'mailtype'    => 'html',
	      'charset'   => 'iso-8859-1',
	      'wordwrap'    => TRUE
	    );

	    $this->email->initialize($config);
	    $this->email->set_mailtype('html');

	    $this->email->from('admin@isidore.edu.ph', 'Isidore Admin');
	    $this->email->to($email);
	    $this->email->subject( $subject);/*'Isidore Portal - Email Verification'*/
	    $this->email->message($msg);

	    if($this->email->send()){
	      //echo 'email sent';
	      return true;
	    }else{
	      //echo $this->email->print_debugger();
	      return false;
	    }


	}

	public function send_itexmo($code){

		/*$number, $msg*/


		$number = '09177134016';
		//$number = '09210635953';
		//$msg 	= "Hi, this is your verification code for Parent Portal: ".$code.". Do not share this with anyone. If you did not request for a code, please call isidore's hotline. Don't reply.";
		$msg 	= "Hi, this is your verification code for Parent Portal:".$code;

		$api_code = 'TR-ISIDO134016_H7SNX';
		$api_pass = '7ftu)rt!(f';

		$result = $this->module->itexmo_local($number,$msg,$api_code, $api_pass);

		if ($result == ""){
		echo "iTexMo: No response from server!!!
		Please check the METHOD used (CURL or CURL-LESS). If you are using CURL then try CURL-LESS and vice versa.	
		Please CONTACT US for help. ";	

		}else if ($result == 0){
			return true;
		}
		else{	
			return false;  /*"Error Num ". $result . " was encountered!";*/
		}
	}


	public function globe(){
		/*$shortcode = "21581280 (Cross-telco: 225651280)";
		$passphrase = "idsis2016xyz";
		$app_id = "nn8AHgea8RfA7ixKy8ca6zfaznG9HLbM";
		$app_secret = "09efb0e728e5c00d250cf12bcd9f2ce5c72b868da00707bda20cfc571eb1f650";
		$address = "9210635953";
		$clientCorrelator = "21581280"; /*264801*/
		

		$shortcode = "21581280 (Cross-telco: 225651280)";
		$passphrase = "idsis2016xyz";
		$app_id = "nn8AHgea8RfA7ixKy8ca6zfaznG9HLbM";
		$app_secret = "09efb0e728e5c00d250cf12bcd9f2ce5c72b868da00707bda20cfc571eb1f650";
		$address = "9210635953";
		$clientCorrelator = "264801";
		$message = "PHP SMS Test";

		$curl = curl_init();
		curl_setopt_array($curl, array(
		  CURLOPT_URL => "https://devapi.globelabs.com.ph/smsmessaging/v1/outbound/".$shortcode."/requests?app_id=".$app_id."&app_secret=".$app_secret."&passphrase=".$passphrase ,
		  CURLOPT_RETURNTRANSFER => true,
		  CURLOPT_ENCODING => "",
		  CURLOPT_MAXREDIRS => 10,
		  CURLOPT_TIMEOUT => 30,
		  CURLOPT_HTTP_VERSION => CURL_HTTP_VERSION_1_1,
		  CURLOPT_CUSTOMREQUEST => "POST",
		  CURLOPT_POSTFIELDS => "{\"outboundSMSMessageRequest\": { \"clientCorrelator\": \"".$clientCorrelator."\", \"senderAddress\": \"".$shortcode."\", \"outboundSMSTextMessage\": {\"message\": \"".$message."\"}, \"address\": \"".$address."\" } }",
		  CURLOPT_HTTPHEADER => array(
		    "Content-Type: application/json"
		  ),
		));
		$response = curl_exec($curl);
		$err = curl_error($curl);
		curl_close($curl);
		if ($err) {
		  echo "cURL Error #:" . $err;
		} else {
		  echo $response;
		}

	}

	public function forgot_password(){
		if(!$this->input->is_ajax_request())
			{
				$data['title'] = 'Forgot Password';
				$this->load->view('portal/forgot_password', $data);
			}
		else
			{
				$username 	= $this->input->post('username', true);
            	$check 		= $this->module->table_where('portal_user', array('username' => $username)); 

            	if($check->num_rows() < 1){
            		$this->module->my_return(false, 'Check your email address and try again.');
            	}else{

            		$prtl_id 	= $check->row('prtl_id');
            		$hrs		= $check->row('prtl_request_date');
            		$hrs_now 	= date('Y-m-d H:i:s');

            		$fname 		= $check->row('prtl_fname');
            		$lname 		= $check->row('prtl_lname');

            		$hrs_diff 	= $this->module->date_diff($hrs, $hrs_now)['hrs'];

            		/*CHECK IF REQUEST IS LESS THAN 1 HOUR*/

            		$code 		= $this->module->gen_otp($cnt=6);
            		$date 		= date('Y-m-d H:i:s');
            		
            		$data_add = array(
            			'prtl_request_code'	=> $code,
            			'prtl_request_date'	=> $date
            		);


            		if(empty($hrs) || ($hrs_diff > 1)  ){
            			$update = $this->module->update('portal_user', $data_add, array('prtl_id' => $prtl_id));
		            	
		            	if($update){
		            		$this->module->my_return(true, 'We have sent an email to <strong>'.$username.'</strong> to reset password.<br/>Please click the reset password link to set your new password');

		            		//email sending

		            		$msg 	= '<img src="http://portal.isidore.edu.ph/asset/images/logo_portal_dark.png" width="300px" >
									<br/><br/>

									<h2>Verification Code</h2>
									<h3><small>Hi</small> <strong>'.$fname.' '.$lname.'</strong></h3>

									You are receiving this email because we received a password reset request for your account in Isidore Portal. <br/>
									Your verification code is <strong>'.$code.'</strong><br/><br/>

									Click the "Reset Password" button below to start:<br/>

									<a href="http://portal.isidore.edu.ph/portal/reset_password/'.$prtl_id.'" style="background-color:#1f4495;border:1px solid #1f4495;border-radius:3px;color:#ffffff;display:inline-block;font-family:sans-serif;font-size:14px;line-height:30px;text-align:center;text-decoration:none;width:150px;-webkit-text-size-adjust:none;mso-hide:all;">Reset Password</a>
									<br/><br/><br/>
									If there was a problem accessing the button, please click this link: http://portal.isidore.edu.ph/portal/reset_password/'.$prtl_id.'<br/>

									<p>Please click the reset password link to set your new password</p>

									NOTE: Do NOT forward this email or share this code to anyone.';

								$subject = 'Isidore Portal -  Reset Password';
		            		
		                	if(!$this->send_email($msg, $username, $subject )){
		                		$this->module->my_return(false, 'Something went wrong.');
		                	}

		            	}

            		}else{
            			$this->module->my_return(false, 'You requested less than an hour ago. Please try again later.');
            		}
            		
            	}
			}
	}

	public function reset_password(){
		if(!$this->input->is_ajax_request())
			{
				$data['title'] = 'Reset Password';
				$this->load->view('portal/reset_password', $data);
			}
		else
			{

				$this->form_validation->set_rules('prtl_request_code', '8 digit code', 'trim|required');
				$this->form_validation->set_rules('password', 'Password', 'trim|required|callback_valid_password');
				$this->form_validation->set_rules('confirm_password', 'Confirm Password', 'required|matches[password]');
				//$this->form_validation->set_rules('prtl_contact', 'Contact Number ', 'required|regex_match[/^[0-9]{11}$/]');

				if ($this->form_validation->run() == FALSE)
	                {
	                	$this->module->my_return(false, validation_errors());
	                }
	            else
	                {
	                	$prtl_request_code 	= $this->input->post('prtl_request_code', true);
	                	$prtl_id 			= $this->input->post('prtl_id', true);
	                	$password 			= $this->input->post('password', true);


                		$check = $this->module->table_where('portal_user', array('prtl_request_code' => $prtl_request_code, 'prtl_id' => $prtl_id)); 

		            	if($check->num_rows() < 1){
		            		$this->module->my_return(false, 'Your 8 digit code is invalid.');
		            	}else{

		            		$hrs		= $check->row('prtl_request_date');
		            		$hrs_now 	= date('Y-m-d H:i:s');
		            		$hrs_diff 	= $this->module->date_diff($hrs, $hrs_now)['hrs'];

		            		if(empty($hrs) || ($hrs_diff > 1)  ){
		            			$this->module->my_return(false, 'You requested less than an hour ago. Please try again later.');
		            		}else{

		            			$new_password = password_hash($password, PASSWORD_DEFAULT);
		            			$update = $this->module->update('portal_user', array('password' => $new_password), array('prtl_id' => $prtl_id));
		            			$this->module->my_return(true, 'You have successfully changed your password.');
		            		}
		            	}



	                }

			}
	}



	public function populate_due_date(){

		$semestral  = array(
                  '10/30/19' => '2nd Semester [October]');

      	$quarterly  = array(
                  '08/30/19' => '2nd Quarter [August]', 
                  '10/30/19' => '3rd Quarter [October]', 
                  '01/30/20' => '4th Quarter [January]');

      	$monthly    = array( 
                  '07/20/19' => 'July', 
                  '08/20/19' => 'August', 
                  '09/20/19' => 'September', 
                  '10/20/19' => 'October', 
                  '11/20/19' => 'November', 
                  '12/20/19' => 'December', 
                  '01/20/20' => 'January', 
                  '02/20/20' => 'February');  

       	$scholar    = array( 
                  '07/20/19' => 'July', 
                  '08/20/19' => 'August', 
                  '09/20/19' => 'September', 
                  '10/20/19' => 'October', 
                  '11/20/19' => 'November', 
                  '12/20/19' => 'December', 
                  '01/20/20' => 'January', 
                  '02/20/20' => 'February', 
                  '03/20/20' => 'March'); 


       	foreach($scholar as $r => $p){
       		$data = array(
       			'sy_id' 		=> 2,
       			'dd_mode'		=> 'M',
       			'dd_is_scholar' => 'Y',
       			'dd_date_due'	=> date('Y-m-d', strtotime($r)),
       			'dd_date_name'	=> $p
       		);
       		$this->module->insert('due_date', $data);

       	}

       	print_r($data);

	}

	public function test_email(){
		$prtl_id = 1;
		$msg 	= '<img src="http://portal.isidore.edu.ph/asset/images/logo_portal_dark.png" width="300px" >
									<br/><br/>

									<h2>Verification Code</h2>
									<h3><small>Hi</small> <strong>Jei</strong></h3>

									You are receiving this email because we received a password reset request for your account in Isidore Portal. <br/>
									Your verification code is <strong>xxxxx</strong><br/><br/>

									Click the "Reset Password" button below to start:<br/><br/>

									<a href="http://portal.isidore.edu.ph/portal/reset_password/'.$prtl_id.'" style="background-color:#1f4495;border:1px solid #1f4495;border-radius:3px;color:#ffffff;display:inline-block;font-family:sans-serif;font-size:14px;line-height:30px;text-align:center;text-decoration:none;width:150px;-webkit-text-size-adjust:none;mso-hide:all;">Reset Password</a>
									<br/><br/><br/>
									If there was a problem accessing the button, please click this link: http://portal.isidore.edu.ph/portal/reset_password/'.$prtl_id.'<br/>

									<p>Please click the reset password link to set your new password</p>

									NOTE: Do NOT forward this email or share this code to anyone.';

								$subject = 'Isidore Portal -  Reset Password';
		$email 	= 'it.isidore@gmail.com';
		            		
    	if($this->send_email($msg, $email, $subject )){
    		$this->module->my_return(true, 'Success');
    	}else{
    		//$this->module->delete('portal_user', array('prtl_id' => $prtl_id));
    		$this->module->my_return(false, 'Something went wrong.');
    	}
	}
}

/* End of file welcome.php */
/* Location: ./application/controllers/welcome.php */