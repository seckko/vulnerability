<?php if ( ! defined('BASEPATH')) exit('No direct script access allowed');

class Base extends CI_Controller {

	public function __construct(){
		parent::__construct();	

		//$this->module->is_log_in();
	}


	public function register()
	{
		if(!$this->input->is_ajax_request())
			{
				$data['title']		= "Isidore de Seville";
				$data['level'] 		= $this->module->get_query("SELECT dp.`dept_name`, lvl.* FROM department AS dp, grade_level AS lvl WHERE dp.`dept_id` = lvl.`dept_id`");
				$data['sy']			= $this->module->get_query("SELECT * FROM school_year WHERE sy_is_active ='Y' ");
				$this->load->view('registration', $data);
			}
		else
		{
			$stud_type 					= $this->input->post('stud_type', true);
			$stud_no 					= $this->input->post('stud_no', true);
			$stud_lrn 					= $this->input->post('stud_lrn', true);
			$stud_lastname				= ucwords(strtolower($this->input->post('stud_lastname', true)));
			$stud_firstname				= ucwords(strtolower($this->input->post('stud_firstname', true)));
			$stud_middlename			= ucwords(strtolower($this->input->post('stud_middlename', true)));
			$stud_suffix				= ucwords(strtolower($this->input->post('stud_suffix', true)));
			$stud_nickname				= ucwords(strtolower($this->input->post('stud_nickname', true)));
			$stud_birthdate				= $this->input->post('stud_birthdate', true);
			$stud_gender				= $this->input->post('stud_gender', true);
			$stud_address 				= ucwords(strtolower($this->input->post('stud_address', true)));
			$stud_handedness 			= $this->input->post('stud_handedness', true);
			$stud_religion				= $this->input->post('stud_religion', true);
			$stud_father_name			= ucwords(strtolower($this->input->post('stud_father_name', true)));
			$stud_father_occupation		= ucwords(strtolower($this->input->post('stud_father_occupation', true)));
			$stud_father_education		= ucwords(strtolower($this->input->post('stud_father_education', true)));
			$stud_father_address		= ucwords(strtolower($this->input->post('stud_father_address', true)));
			$stud_father_contact		= $this->input->post('stud_father_contact', true);
			$stud_father_email			= $this->input->post('stud_father_email', true);
			$stud_mother_name			= ucwords(strtolower($this->input->post('stud_mother_name', true)));
			$stud_mother_occupation		= ucwords(strtolower($this->input->post('stud_mother_occupation', true)));
			$stud_mother_education		= ucwords(strtolower($this->input->post('stud_mother_education', true)));
			$stud_mother_address		= ucwords(strtolower($this->input->post('stud_mother_address', true)));
			$stud_mother_contact		= $this->input->post('stud_mother_contact', true);
			$stud_mother_email			= $this->input->post('stud_mother_email', true);
			$stud_emergency_name		= ucwords(strtolower($this->input->post('stud_emergency_name', true)));
			$stud_emergency_contact		= $this->input->post('stud_emergency_contact', true);
			$stud_relationship			= ucwords(strtolower($this->input->post('stud_relationship', true)));
			$stud_guardian_name			= ucwords(strtolower($this->input->post('stud_guardian_name', true)));
			$stud_guardian_contact		= $this->input->post('stud_guardian_contact', true);
			$stud_guar_name				= ucwords(strtolower($this->input->post('stud_guar_name', true)));
			$stud_guar_relation			= ucwords(strtolower($this->input->post('stud_guar_relation', true)));
			$stud_guar_address			= ucwords(strtolower($this->input->post('stud_guar_address', true)));
			$stud_guar_contact			= $this->input->post('stud_guar_contact', true);
			$stud_prev_schl_name		= ucwords(strtolower($this->input->post('stud_prev_schl_name', true)));
			$stud_prev_level			= ucwords(strtolower($this->input->post('stud_prev_level', true)));
			$stud_prev_date				= $this->input->post('stud_prev_date', true);


			$this->form_validation->set_rules('stud_lrn', 'Student LRN', 'trim|is_unique[student.stud_lrn]');


				if ($this->form_validation->run() == FALSE)
	                {
	                	$this->module->my_return(false, validation_errors());
	                }
	            else
	                {
	                	$check = $this->module->get_query("SELECT * FROM student WHERE stud_lastname = '".$stud_lastname."' AND stud_firstname = '".$stud_firstname."' AND stud_middlename = '".$stud_middlename."' AND stud_suffix = '".$stud_suffix."' ");

	                	if($check->num_rows() < 1 ){
	                		$active_sy 		= $this->module->get_active_sy();
		                	$cnt_stud_no 	= $this->module->get_query('SELECT COUNT(*) AS cnt FROM v_student_assessment WHERE stud_type = "New Student" AND sy_id = '.$active_sy.' ')->row('cnt');
		                	$gen_stud_no 	= '';

		                	if($stud_type == 'New Student'){
		                		$gen_stud_no = $this->module->gen_stud_no($cnt_stud_no+1);

		                		$data = array (
			                		'stud_no' 					=> $gen_stud_no,
			                		'stud_type' 				=> $stud_type,
									'stud_lrn' 					=> $stud_lrn,
									'stud_lastname' 			=> $stud_lastname,
									'stud_firstname' 			=> $stud_firstname,
									'stud_middlename' 			=> $stud_middlename,
									'stud_suffix' 				=> $stud_suffix,
									'stud_nickname' 			=> $stud_nickname,
									'stud_birthdate' 			=> date("Y-m-d", strtotime($stud_birthdate)),
									'stud_gender' 				=> $stud_gender,
									'stud_address' 				=> $stud_address,
									'stud_handedness' 			=> $stud_handedness,
									'stud_religion' 			=> $stud_religion,
									'stud_father_name' 			=> $stud_father_name,
									'stud_father_occupation' 	=> $stud_father_occupation,
									'stud_father_education'		=> $stud_father_education,
									'stud_father_address' 		=> $stud_father_address,
									'stud_father_contact' 		=> $stud_father_contact,
									'stud_father_email' 		=> $stud_father_email,
									'stud_mother_name' 			=> $stud_mother_name,
									'stud_mother_occupation' 	=> $stud_mother_occupation,
									'stud_mother_education'		=> $stud_mother_education,
									'stud_mother_address' 		=> $stud_mother_address,
									'stud_mother_contact'		=> $stud_mother_contact,
									'stud_mother_email' 		=> $stud_mother_email,
									'stud_emergency_name' 		=> $stud_emergency_name,
									'stud_emergency_contact' 	=> $stud_emergency_contact,
									'stud_relationship' 		=> $stud_relationship,
									'stud_guardian_name' 		=> $stud_guardian_name,
									'stud_guardian_contact' 	=> $stud_guardian_contact,
									'stud_guar_name' 			=> $stud_guar_name,
									'stud_guar_relation' 		=> $stud_guar_relation,
									'stud_guar_address' 		=> $stud_guar_address,
									'stud_guar_contact' 		=> $stud_guar_contact,
									'stud_prev_schl_name' 		=> $stud_prev_schl_name,
									'stud_prev_level' 			=> $stud_prev_level,
									'stud_prev_date' 			=> $stud_prev_date,
									'stud_reg_date'				=> date('Y-m-d')

			                	); 
		                	}else{


		                		$data = array (
		                			'stud_no' 					=> (empty($stud_no) ? '' : $stud_no),
			                		'stud_type' 				=> $stud_type,
									'stud_lrn' 					=> $stud_lrn,
									'stud_lastname' 			=> $stud_lastname,
									'stud_firstname' 			=> $stud_firstname,
									'stud_middlename' 			=> $stud_middlename,
									'stud_suffix' 				=> $stud_suffix,
									'stud_nickname' 			=> $stud_nickname,
									'stud_birthdate' 			=> date("Y-m-d", strtotime($stud_birthdate)),
									'stud_gender' 				=> $stud_gender,
									'stud_address' 				=> $stud_address,
									'stud_handedness' 			=> $stud_handedness,
									'stud_religion' 			=> $stud_religion,
									'stud_father_name' 			=> $stud_father_name,
									'stud_father_occupation' 	=> $stud_father_occupation,
									'stud_father_education'		=> $stud_father_education,
									'stud_father_address' 		=> $stud_father_address,
									'stud_father_contact' 		=> $stud_father_contact,
									'stud_father_email' 		=> $stud_father_email,
									'stud_mother_name' 			=> $stud_mother_name,
									'stud_mother_occupation' 	=> $stud_mother_occupation,
									'stud_mother_education'		=> $stud_mother_education,
									'stud_mother_address' 		=> $stud_mother_address,
									'stud_mother_contact'		=> $stud_mother_contact,
									'stud_mother_email' 		=> $stud_mother_email,
									'stud_emergency_name' 		=> $stud_emergency_name,
									'stud_emergency_contact' 	=> $stud_emergency_contact,
									'stud_relationship' 		=> $stud_relationship,
									'stud_guardian_name' 		=> $stud_guardian_name,
									'stud_guardian_contact' 	=> $stud_guardian_contact,
									'stud_guar_name' 			=> $stud_guar_name,
									'stud_guar_relation' 		=> $stud_guar_relation,
									'stud_guar_address' 		=> $stud_guar_address,
									'stud_guar_contact' 		=> $stud_guar_contact,
									'stud_prev_schl_name' 		=> $stud_prev_schl_name,
									'stud_prev_level' 			=> $stud_prev_level,
									'stud_prev_date' 			=> $stud_prev_date,
									'stud_reg_date'				=> date('Y-m-d')
			                	); 
		                	}

							if($this->module->insert('student', $data)){
								$stud_id  = $this->db->insert_id();

								$data 	= $this->input->post(null,true);
						        foreach($data as $d => $k){

									if(strpos($d, 'sib')!== FALSE){
										$sib_name 	= empty($k["sib_name"])?'': $k["sib_name"];
										$sib_level 	= empty($k["sib_level"])?'': $k["sib_level"];
										$sib_age 	= empty($k["sib_age"])?'': $k["sib_age"];
										$sib_gender = empty($k["sib_gender"])?'': $k["sib_gender"];
										$sib_school = empty($k["sib_school"])?'': $k["sib_school"];

										if(!empty($sib_name) ){
											$siblings = array(
												"stud_id" 		=>$stud_id,
												"sib_name"		=>ucwords(strtolower($sib_name)),
												"sib_age"		=>$sib_age,
												"sib_gender"	=>$sib_gender,
												"sib_level"		=>$sib_level,
												"sib_school"	=>ucwords(strtolower($sib_school))
											);

											if (!empty($siblings)){
												$this->module->insert('sibling', $siblings);
											}
										}
									}//end day_out
								}

								$ass_data = array(
									'stud_id' 	=> $stud_id,
									'stud_type' => $stud_type,
									'lvl_id' 	=> $this->input->post('lvl_id',true),
									'sy_id' 	=> $this->input->post('sy_id', true),
									'as_mode'	=> $this->input->post('as_mode', true),
									'as_stat'	=> 'PENDING'
								);

								$this->module->insert('assessment',$ass_data);
								$this->module->update('student', array('stud_queue' => $this->module->gen_queue_no($stud_id) ), array('stud_id' => $stud_id) );
								$this->module->cust_return(true,'<strong>Successfully registered.</strong><br/> Go to CASHIER for the next step, Thank you!', $stud_id);
							}else{
								$this->module->my_return(false, 'Please check your input data.');
							}
	                	}else{
	                		$this->module->my_return(false, 'Already exist in the database.');
	                	}

	                	
	                }
		}
	}

	public function print_student(){
		$stud_id = $this->uri->segment(3);

		$data['title'] 			= 'Student Profile';
		$data['student'] 		= $this->module->table_where('student', array('stud_id' => $stud_id));
		$data['sibling'] 		= $this->module->table_where('sibling', array('stud_id' => $stud_id));
		$data['assessment'] 	= $this->module->table_where('assessment', array('stud_id' => $stud_id));
		$this->load->view('print_student', $data);
	}

	public function prints(){
		$this->load->view('print');
	}

	

	
}