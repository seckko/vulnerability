<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <title><?= $title;?></title>

    <?= $this->load->view('inc/css')?>

</head>
<body class="page-body gray">

<div class="page-container"><!-- add class "sidebar-collapsed" to close sidebar by default, "chat-visible" to make chat appear always -->
    
    <div class="sidebar-menu">

        <div class="sidebar-menu-inner">
            <?= $this->load->view('inc/sidebar')?>
        </div>

    </div>

    <div class="main-content"> <!---START MAIN CONTENT -->
        <h1><?= $title;?></h1>
        <hr/>
        
        <div class="row">
            <div class="col-md-9">
                <div class="panel panel-primary panel-shadow" data-collapsed="0"><!-- to apply shadow add class "panel-shadow" -->
                    <!-- panel head -->
                    <div class="panel-heading">
                        <div class="panel-title">Create New <?=$title?></div>
                    </div>
                    
                    <!-- panel body -->
                    <div class="panel-body">

                        <ul class="nav nav-tabs"><!-- available classes "bordered", "right-aligned" -->
                          <li class="active">
                            <a href="#create" data-toggle="tab">
                              <span class="visible-xs"><i class="entypo-home"></i></span>
                              <span class="hidden-xs">Create Subject</span>
                            </a>
                          </li>

                          <li>
                            <a href="#subject" data-toggle="tab">
                              <span class="visible-xs"><i class="entypo-home"></i></span>
                              <span class="hidden-xs">Subject Details</span>
                            </a>
                          </li>

                          <li>
                            <a href="#assign" data-toggle="tab">
                              <span class="visible-xs"><i class="entypo-user"></i></span>
                              <span class="hidden-xs">Subject Assignment</span>
                            </a>
                          </li>
                        </ul>

                        <div class="tab-content">
                            <div class="tab-pane active" id="create">
                                <form method="post" id="frmSubmit" action="<?=base_url()?>admin/subject" class="form-horizontal form-groups-bordered">
                            
                                    <div class="form-group">
                                        <label class="col-sm-3 control-label">Subject Name</label>
                                        
                                        <div class="col-sm-5">
                                            <input class="form-control" type="text" name="sub_name" autofocus="" required="">
                                        </div>
                                    </div>

                                    <div class="form-group">
                                        <label class="col-sm-3 control-label">Subject Sort Order</label>
                                        
                                        <div class="col-sm-5">
                                            <input class="form-control" type="text" name="sub_sort" autofocus="" required="">
                                        </div>
                                    </div>

                                    <div class="form-group">
                                        <div class="col-sm-offset-3 col-sm-5">
                                            <button type="submit" class="btn btn-success"> <i class="fa fa-check"></i> Create</button>
                                            <button type="reset" class="btn btn-default"> Clear</button>
                                        </div>
                                    </div>
                                </form>
                                
                                <hr/>
                                <h3 class="bold"> Subject Record</h3>
                               

                                <table class="table table-bordered table-hover datatable">
                                    <thead>
                                        <tr>
                                            <th class="width-5">No.</th>
                                            <th>Subject</th>
                                            <th>Sort Order</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    
                                    <tbody>
                                        
                                        <?php 
                                        $cnt = 1;
                                        foreach($subject->result() as $r):?>

                                        <tr>
                                            <td><?=$cnt++?></td>
                                            <td><?=$r->sub_name?></td>
                                            <td><?=$r->sub_sort?></td>
                                            <td class="width-10">
                                                <a href="<?=base_url()?>admin/edit_subject/<?=$r->sub_id?>" class="btn btn-info btn-xs edit" >Edit</a>
                                                <button class="btn btn-danger btn-xs delete" data-id="<?=$r->sub_id?>">Delete</button>
                                            </td>
                                        </tr>

                                        <?php endforeach;?>
                                        
                                    </tbody>
                                </table>

                            </div>

                            <div class="tab-pane" id="subject">
                                <form method="post" id="frmSubmit3" action="<?=base_url()?>admin/subject_detail" class="form-horizontal form-groups-bordered">
                                    <div class="msg"></div>
                                    <div class="form-group">
                                        <label class="col-sm-2 control-label ">School Year</label>
                                        
                                        <div class="col-sm-5">
                                            <select class="form-control" name="sub_id" required="">
                                                <option value="" disabled="" selected="">Parent Subject</option>

                                                <?php 
                                                        $sub_id = $this->module->getTableSort('subject', 'sub_sort');
                                                        foreach ($sub_id->result() as $k):
                                                ?>
                                                            <option value="<?=$k->sub_id?>"><?=$k->sub_name?></option>

                                                <?php endforeach; ?>
                                            </select>
                                        </div>

                                        <div class="col-sm-5 text-right">
                                            <button class="btn btn-success" type="submit"> <i class="fa fa-check"></i> Create</button>
                                            <button class="btn btn-default" type="reset"> Clear</button>
                                        </div>
                                    </div> 
                                    
                                    <br/>

                                    <table class="table table-condensed table-bordered">
                                        <thead>
                                            <th class="width-5">No</th>
                                            <th>Name</th>
                                            <th>Percentage (%)</th>
                                        </thead>

                                        <tbody>
                                            
                                            <?php for($x=1; $x <= 10; $x ++):?>
                                            <tr>
                                                <td class="text-center vmiddle"><?=$x?></td>
                                                <td>
                                                    <input class="form-control" type="text" name="subject<?=$x?>[subj_det_name]" autofocus="" placeholder="Name">
                                                </td>
                                                <td>
                                                    <input class="form-control digit" type="text" name="subject<?=$x?>[subj_det_percentage]" autofocus="" placeholder="0.00">
                                                </td>
                                            </tr>
                                            <?php endfor; ?>
                                        </tbody>
                                    </table>

                                </form>

                                <hr/>
                                <h3 class="bold"> Subject Assignment</h3>

                                <table class="table table-bordered datatable">
                                    <thead>
                                        <tr>
                                            <th class="width-5">No.</th>
                                            <th>Parent Subject</th>
                                            <th>Name</th>
                                            <th>Percentage (%)</th>
                                            <th class="width-5"></th>
                                        </tr>
                                    </thead>
                                    
                                    <tbody>
                                        
                                        <?php 
                                        $cnt = 1;
                                        $ps = $this->module->get_table('v_subject_detail');
                                        foreach($ps->result() as $r):?>

                                        <tr>
                                            <td><?=$cnt++?></td>
                                            <td><?=$r->sub_name?></td>
                                            <td><?=$r->subj_det_name?></td>
                                            <td><?=$r->subj_det_percentage?></td>
                                            <td><button class="btn btn-danger btn-xs subj_det_delete" data-id="<?=$r->subj_det_id?>">Delete</button> </td>
                                        </tr>

                                        <?php endforeach;?>
                                        
                                    </tbody>
                                </table>

                            </div>

                            <div class="tab-pane" id="assign">
                                    
                                    <form method="post" id="frmSubmit2" action="<?=base_url()?>admin/subject_assignment" class="form-horizontal form-groups-bordered">
                                        <div class="msg"></div>
                                        <div class="form-group">
                                            <label class="col-sm-2 control-label ">School Year</label>
                                            
                                            <div class="col-sm-5">
                                                <select class="form-control" name="sy_id" required="">
                                                    <option value="" disabled="" selected="">SELECT</option>

                                                    <?php 
                                                            $sy_id      = $this->module->get_table('school_year');
                                                            foreach ($sy_id->result() as $k):
                                                    ?>
                                                                <option value="<?=$k->sy_id?>" ><?=$k->sy_name?></option>

                                                    <?php endforeach; ?>
                                                </select>
                                            </div>
                                        </div>

                                         <div class="form-group">
                                            <label class="col-sm-2 control-label ">Teacher</label>
                                            
                                            <div class="col-sm-5">
                                                <select class="form-control" name="tch_id" required="">
                                                    <option value="" disabled="" selected="">SELECT</option>

                                                    <?php 
                                                            $tch_id = $this->module->get_query("SELECT * FROM teacher WHERE tch_has_subj = 'Y' ORDER BY tch_lastname");
                                                            foreach ($tch_id->result() as $k):
                                                    ?>
                                                                <option value="<?=$k->tch_id?>"><?=$k->tch_lastname.', '.$k->tch_firstname?></option>

                                                    <?php endforeach; ?>
                                                </select>
                                            </div>
                                        </div>

                                        <div class="form-group">
                                            <label class="col-sm-2 control-label ">Grade Level</label>
                                            
                                            <div class="col-sm-5">
                                                <select class="form-control lvl_id" name="lvl_id" required="">
                                                    <option value="" disabled="" selected="">SELECT</option>

                                                    <?php 
                                                            $lvl_id = $this->module->get_table('grade_level');
                                                            foreach ($lvl_id->result() as $k):
                                                    ?>
                                                                <option value="<?=$k->lvl_id?>"><?=$k->lvl_name?></option>

                                                    <?php endforeach; ?>
                                                </select>
                                            </div>
                                        </div>

                                        <div class="form-group">
                                            <label class="col-sm-2 control-label ">Section</label>
                                            
                                            <div class="col-sm-5">
                                                <select class="form-control sec_id" name="sec_id" required="">
                                                    <option value="" disabled="" selected="">SELECT</option>
                                                </select>
                                            </div>
                                        </div>

                                        

                                        <div class="form-group">
                                            <label class="col-sm-2 control-label ">Subject</label>
                                            
                                            <div class="col-sm-5">
                                                <select class="form-control sub_id" name="sub_id" required="">
                                                    <option value="" disabled="" selected="">SELECT</option>

                                                    <?php 
                                                            $sub_id = $this->module->getTableSort('subject', 'sub_sort');
                                                            foreach ($sub_id->result() as $k):
                                                    ?>
                                                                <option value="<?=$k->sub_id?>"><?=$k->sub_name?></option>

                                                    <?php endforeach; ?>
                                                </select>
                                            </div>
                                        </div>

                                        <div class="form-group">
                                            <label class="col-sm-2 control-label "> </label>
                                            
                                            <div class="col-sm-5">
                                                <select class="form-control subj_det_id" name="subj_det_id">

                                                </select>
                                            </div>
                                        </div>

                                        
                                        <div class="form-group">
                                            <div class="col-sm-offset-3 col-sm-5">
                                                <button type="submit" class="btn btn-success"> <i class="fa fa-check"></i> Create</button>
                                                <button type="reset" class="btn btn-default"> Clear</button>
                                            </div>
                                        </div>
                                    </form>    


                                <hr/>
                                <h3 class="bold"> Subject Assignment</h3>

                                <table class="table table-bordered datatable">
                                    <thead>
                                        <tr>
                                            <th class="width-5">No.</th>
                                            <th>Subject</th>
                                            <th>Teacher</th>
                                            <th>Grade & Section</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    
                                    <tbody id="tbl_subject_assignment">
                                        
                                        <?php 
                                        $cnt = 1;
                                        foreach($subject_assign->result() as $r):

                                            $subject_detail = $this->module->get_query("SELECT * FROM subject_detail WHERE subj_det_id = ".$r->subj_det_id." ");

                                        ?>

                                        <tr>
                                            <td><?=$cnt++?></td>
                                            <td><?=$r->sub_name.($subject_detail->num_rows() <1 ? '': ' - '.$subject_detail->row('subj_det_name') )?></td>
                                            <td><?=$r->tch_lastname.', '.$r->tch_firstname?></td>
                                            <td><?=$r->lvl_name.' - '.$r->sec_name?></td>
                                            <td class="width-10">
                                                <!-- <a href="<?=base_url()?>admin/edit_section/<?=$r->sec_id?>" class="btn btn-info btn-xs edit" >Edit</a>-->
                                                <button class="btn btn-danger btn-xs subj_delete" data-id="<?=$r->subj_id?>">Delete</button> 
                                            </td>
                                        </tr>

                                        <?php endforeach;?>
                                        
                                    </tbody>
                                </table>

                            </div>
                        </div>
                       
                    </div>
                    
                </div>
            </div> 

            <div class="col-md-3 msg"></div> 
        </div>

    </div><!---END MAIN CONTENT -->
</div> <!-- end of body container -->

<?= $this->load->view('inc/js')?>
<script type="text/javascript" charset="utf-8">
  $(document).ready(function() {
        $('#frmSubmit').crud_refresh();
        $('#frmSubmit2').crud();

       

        //DELETE function
        $(document.body).on("click",".delete",function(e){
            var tr = $(this).closest('tr');
            var id = tr.find('.delete').attr('data-id');

            if (confirm('Are you sure you want to delete this record?')) {
                $.ajax({url: base_url+'admin/delete_subject/'+id, success: function(result){
                    tr.fadeOut(1000);
                    //window.setTimeout(function(){location.reload()},1000);
                }});
            }
        });

        //DELETE function
        $(document.body).on("click",".subj_delete",function(e){
            var tr = $(this).closest('tr');
            var id = tr.find('.subj_delete').attr('data-id');

            if (confirm('Are you sure you want to delete this record?')) {
                $.ajax({url: base_url+'admin/delete_subject_assignment/'+id, success: function(result){
                    tr.fadeOut(1000);
                    //window.setTimeout(function(){location.reload()},1000);
                }});
            }
        });


         //DELETE function
        $(document.body).on("click",".subj_det_delete",function(e){
            var tr = $(this).closest('tr');
            var id = tr.find('.subj_det_delete').attr('data-id');

            if (confirm('Are you sure you want to delete this record?')) {
                $.ajax({url: base_url+'admin/delete_subject_details/'+id, success: function(result){
                    tr.fadeOut(1000);
                    //window.setTimeout(function(){location.reload()},1000);
                }});
            }
        });


        $('.lvl_id').on('change', function(){
            var txt_lvl = $(this).val();
              $('.sec_id').load(base_url+'admin/get_section/'+txt_lvl);
        });

        $('.sub_id').on('change', function(){
            var sub_id = $(this).val();
              $('.subj_det_id').load(base_url+'admin/get_subject_detail/'+sub_id);
        });

        $(document.body).on('blur','.digit',function(){
            $(this).val(accounting.format($(this).val(),2));
        });


        $(document.body).on("submit", "#frmSubmit3",function(e){
            e.preventDefault(); 

            var base  = $(this);
            var msg   = $(".msg");
            var btn   = base.find("button");

             var sum = 0;
            $('.digit').each(function() {
                sum += Number($(this).val());
            });

            if(sum < 100){
                $('.msg').html(alert_error('Sum of all percentage must be a <strong>total of 100 %</strong>'));
            }else{

                 $.ajax({
                  type:base.attr("method"),//get/post
                  data:base.serialize(),
                  url:base.attr("action"),//location for the url
                  beforeSend:function(){
                    msg.empty().html(alert_minimal('Processing . . .'));
                    btn.prop("disabled",true);
                  },
                  success:function(rrdata){

                    btn.prop("disabled",false);
                    var rdata = $.parseJSON(rrdata);
                    if(rdata.stat){
                      msg.empty().html(alert_success(rdata.msg)).show();
                      //$('#tbl_subject_assignment').empty(); //.load(admin+'admin/get_tbL_subject_assignment');
                    //location.reload();
                      /*window.setTimeout(function(){
                        window.location = base_url + 'admin/print_assessment/'+rdata.id;
                      },500)*/
                    }
                    else{
                      msg.empty().html(alert_error(rdata.msg));
                    }
                    
                  },
                  error:function(rdata){
                    btn.prop("disabled",false);
                    msg.empty().html(alert_error('An error occured, please try again later'));
                  }
                });

            }
        });
       
  });
</script>
</body>
</html>