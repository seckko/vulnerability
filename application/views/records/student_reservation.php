<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <title><?= $title;?></title>

    <?= $this->load->view('inc/css')?>

</head>
<body class="page-body">

<div class="page-container"><!-- add class "sidebar-collapsed" to close sidebar by default, "chat-visible" to make chat appear always -->
    
    <div class="sidebar-menu">

        <div class="sidebar-menu-inner">
            <?= $this->load->view('inc/sidebar')?>
        </div>

    </div>

    <div class="main-content"> <!---START MAIN CONTENT -->
        <h1><?=$title?></h1>
        <hr/>
        
        <div class="row">
            <div class="col-md-6 col-sm-12 col-xs-12">
              <div class="panel panel-default panel-shadow">
                <div class="panel-heading">
                  <div class="panel-title"> Create Reservation </div>
                </div>
                <div class="panel-body">
                    <form method="post" id="frmSubmit" action="<?=base_url()?>admin/student_reservation" class="form-horizontal form-groups-bordered">
                      <div class="col-md-12 msg"></div>

                      <div class="form-group">
                          <label class="col-sm-3 control-label">Student Type </label>
                          
                          <div class="col-sm-3">
                            <input class="icheck stud_type" type="radio" value="N" name="stud_type" required="" >
                                <label>New Student</label>
                          </div>

                          <div class="col-sm-3">
                            <input class="icheck stud_type" type="radio" value="O" name="stud_type" required="" >
                                <label>Old Student</label>
                          </div>
                      </div>

                      <div class="form-group">
                          <label class="col-sm-3 control-label">Student Name</label>
                          
                          <div class="col-sm-8">

                              <select class="form-control select2 stud_id" name="stud_id" required="" disabled="">
                                      <option selected="" disabled="">Select</option>
                                  <?php foreach ($student->result() as $k):?>
                                      <option value="<?=$k->stud_id?>" data-birthdate = "<?=date('m/d/Y', strtotime($k->stud_birthdate))?>" ><?=ucwords($k->stud_lastname.', '.$k->stud_firstname)?></option>
                                  <?php endforeach; ?>
                              </select>
                          </div>
                      </div>


                      <div class="form-group">
                          <label class="col-sm-3 control-label"> Firstname </label>
                          
                          <div class="col-sm-8">
                              <input class="form-control stud_firstname" type="text" name="stud_firstname" autofocus="" autocomplete="off" required="" >
                          </div>
                      </div>

                      <div class="form-group">
                          <label class="col-sm-3 control-label"> Lastname </label>
                          
                          <div class="col-sm-8">
                              <input class="form-control stud_lastname" type="text" name="stud_lastname" autofocus="" autocomplete="off" required="" >
                          </div>
                      </div>

                      <div class="form-group">
                          <label class="col-sm-3 control-label">Birthdate</label>


                          <div class="col-sm-8">
                            <input type="text" class="form-control stud_birthdate" name="stud_birthdate" required="">
                            <div class="date_msg text-danger bold pt-5"></div>
                          </div>
                      </div>

                      <div class="form-group">
                          <label class="col-sm-3 control-label">Grade & Section</label>
                          
                          <div class="col-sm-4">

                              <select class="form-control " name="lvl_id" id="lvl_id" required="">
                                      <option selected="" disabled="">Select</option>
                                  <?php foreach ($grade_level->result() as $g):?>
                                      <option value="<?=$g->lvl_id?>"><?=$g->lvl_name?></option>
                                  <?php endforeach; ?>
                              </select>
                          </div>

                          <div class="col-sm-4">
                               <select class="form-control " name="sec_id" id="sec_id" required="">
                                      <option selected="" disabled="">Select</option>
                              </select>
                          </div>
                      </div>

                      <div class="form-group">
                          <label class="col-sm-3 control-label"> Remarks </label>
                          
                          <div class="col-sm-8">
                              <textarea class="form-control" name="cl_remarks"></textarea>
                          </div>
                      </div>



                      <div class="form-group">
                          <label class="col-sm-3 control-label">School Year</label>
                          
                          <div class="col-sm-8">

                              <select class="form-control " name="sy_id" required="">
                                      <option selected="" disabled="">Select</option>
                                  <?php foreach ($school_year->result() as $s):?>
                                      <option <?=($s->sy_selected == 'Y' ? 'selected' : '')?> value="<?=$s->sy_id?>"><?=$s->sy_name.' '.($s->sy_is_active == 'N' ? '' : '(Active)')?></option>
                                  <?php endforeach; ?>
                              </select>
                          </div>
                      </div>

                      <div class="form-group">
                          <label class="col-sm-3 control-label">Date Reserve</label>
                          
                          <div class="col-sm-8">
                              <input type="text" class="form-control date" name="res_date" required="" value="<?=date('Y-m-d')?>" autocomplete="off">
                          </div>
                      </div>

                      <div class="form-group">
                          <div class="col-sm-offset-3 col-sm-5">
                              <button type="submit" class="btn btn-success"> <i class="fa fa-check"></i> Create Reservation</button>
                              <button type="reset" class="btn btn-default"> Clear</button>
                          </div>
                      </div>

                    </form>
                </div>
              </div>

                
            </div>

            <div class="col-md-6 col-sm-12 col-xs-12">
                <h3 class="bold">RESERVATION RECORD <small>(SY <?=$this->module->get_active_sy_name()?>)</small></h3>
                <hr/>
                <table  class="table table-bordered table-primary table-striped table-hover table-condensed datatable">
                    <thead>
                      <th class="width-5 text-center">No.</th>
                      <th class="text-center">Learners Name</th>
                      <th class="text-center">Birthdate</th>
                      <th class="text-center">Grade & Section</th>
                      <th class="text-center">Date Reserved</th>
                    </thead>

                    <tbody>
                      <?php 
                          $cnt = 1;
                          foreach($reservation->result() as $r):
                            $fullname = $r->stud_lastname.', '.$r->stud_firstname;
                      ?>
                        <tr>
                          <td class="text-center"><?=$cnt++?></td>
                          <td><?=$fullname?></td>
                          <td><?= $r->stud_birthdate?></td>
                          <td><?=$r->lvl_name.'-'.$r->sec_name?></td>
                          <td><?=$r->cl_date_reserved?></td>
                        </tr>

                      <?php endforeach;?>
                    </tbody>
                </table>

            </div>
        </div>


    </div><!---END MAIN CONTENT -->
</div> <!-- end of body container -->

<?= $this->load->view('inc/js')?>
<script type="text/javascript" charset="utf-8">
  $(document).ready(function() {
        //$('#frmSubmit, #frmSubmitNew').crud_refresh();
    
      $('.stud_birthdate').mask('00/00/0000', {placeholder: "mm/dd/yyyy"});

      $('.stud_birthdate').on('change', function(){
        var birthdate = $(this).val();
        var date_now  = $('#date_now').val();

        if (Date.parse(birthdate) > Date.parse(date_now)) {
          $(this).val('');
          $('.date_msg').html('Invalid date format (mm/dd/yyyy)');
        }else{
          if(validate_date(birthdate) == true ){
            $('.date_msg').html('');
          }else{
            $(this).val('');
            $('.date_msg').html('Invalid date format (mm/dd/yyyy)');
          }
        }
        
      });
        
      $('#lvl_id').on('change', function(){
        var lvl_id = $(this).val();
          $('#sec_id').load(base_url+'assessment/get_section/'+lvl_id);
      });

      $('#frmSubmit').crud_refresh();

      /*$('.frmSubmit').submit(function(e){
          e.preventDefault(); 

          var base    = $(this);
          var msg     = $(".msg");
          var btn     = base.find("button");
          
          $.ajax({
                type:base.attr("method"),//get/post
                data:base.serialize(),
                url:base.attr("action"),//location for the url
                beforeSend:function(){
                  msg.empty().html(alert_minimal('Processing . . .'));
                  btn.prop("disabled",true);
                },
                success:function(rrdata){

                  btn.prop("disabled",false);
                  var rdata = $.parseJSON(rrdata);
                  if(rdata.stat){
                  msg.empty().html(alert_success(rdata.msg));
                  self.location = base_url+'admin/reservation';
                   //$('.frmSubmit')[0].reset();
                   //location.reload();
                  }
                  else{   
                    msg.empty().html(alert_error(rdata.msg));
                  }
                  
                },
                error:function(rdata){
                  btn.prop("disabled",false);
                  msg.empty().html(alert_error('An error occured, please try again later'));
                }
          });

      });*/


       

        //DELETE function
        $(document.body).on("click",".delete",function(e){
            var tr = $(this).closest('tr');
            var id = tr.find('.delete').attr('data-id');

            $.ajax({url: base_url+'admin/delete_reservation/'+id, success: function(result){
                tr.fadeOut(1000);
                window.setTimeout(function(){location.reload()},500);
            }});
        });

        $('.date').mask('0000-00-00', {placeholder: "yyyy-mm-dd"});

        $('.stud_type').on('change', function(){
            me = $(this).val();

            if(me == 'O'){
              $('.stud_id').prop('disabled', false);
            }else{
              $('.stud_id').prop('disabled', true);
            }
        });


         $('.stud_id').on('change', function(){
            me        = $(this).val();
            stud_name = $('.stud_id option:selected').text();
            student   = stud_name.split(', ');
            birthdate = $('.stud_id option:selected').data('birthdate'); 

            stud_lastname   = student[0];
            stud_firstname  = student[1];

            $('.stud_lastname').val(stud_lastname);
            $('.stud_firstname').val(stud_firstname);
            $('.stud_birthdate').val(birthdate);

         });


        function validate_date(birthdate){
          var bdate = birthdate;
          var comp = bdate.split('/');
          var m = parseInt(comp[0], 10);
          var d = parseInt(comp[1], 10);
          var y = parseInt(comp[2], 10);
          var date = new Date(y,m-1,d);
          if (date.getFullYear() == y && date.getMonth() + 1 == m && date.getDate() == d) {
            return true;
          } else {
            return false;
          }
        }


  });
</script>
</body>
</html>