<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <title><?= $title;?></title>

    <?= $this->load->view('inc/css')?>

</head>
<body class="page-body">

<div class="page-container"><!-- add class "sidebar-collapsed" to close sidebar by default, "chat-visible" to make chat appear always -->
    
    <div class="sidebar-menu">

        <div class="sidebar-menu-inner">
            <?= $this->load->view('inc/portal_sidebar')?>
        </div>

    </div>

    <div class="main-content"> <!---START MAIN CONTENT -->
    <div class="row">
            <div class="col-md-6">
                <h3 > <?=$title?></h3>
            </div>
            <div class="col-md-3">
                
            </div>
        </div>
    <hr/>

   
  
  <div class="row">
    <div class="col-lg-6 col-md-6 col-sm-12 col-xs-12">
      <div class="panel panel-primary">
       <div class="panel-heading">
         <h3 class="panel-title"> <?=$students->row('lvl_name').'-'.$students->row('sec_name')?></h3>
       </div>

       <form id="form_upload" action="<?php echo base_url()?>padmin/upload_grade" enctype="multipart/form-data" method="POST">
          
         <div class="panel-body">
              <span class="upload_msg"></span>

              <div class="row">

                <input type="hidden" name="sec_id" value="<?= $this->uri->segment(3)?>">
                
                <div class="col-lg-6 col-md-6 col-sm-12 col-xs-12">
                  <label>School Year</label>
                    <select class="form-control  has-success sy_id" name="sy_id"  >  <!--  onchange= "location = this.value" -->
                    <option disabled="" selected="">Select School year</option>             
                    <?php 
                      $ksy_id = $this->module->get_active_sy();
                        foreach ($ps_school_year->result() as $l):
                          $sy_id   = $l->sy_id;
                          $sy_name = $l->sy_name;
                    ?>
                        <option value="<?=$sy_id?>" <?=($sy_id == $ksy_id ? 'selected="" ' : ''  )?> > <?= $sy_name?> <?= $l->sy_is_active == 'Y' ? '(Active)' : '' ?></option>
                    <?php endforeach; ?>
                  </select>
                </div>

                <div class="col-lg-6 col-md-6 col-sm-12 col-xs-12">
                  <label>Quarter</label>
                    <select class="form-control  has-success qtr_code" name="qtr_code"  >  <!--  onchange= "location = this.value" -->
                      <option disabled="" selected="">Select Quarter</option>             
                      <option value="1Q" > First Quarter</option>
                      <option value="2Q" > Second Quarter</option>
                      <option value="3Q" > Third Quarter</option>
                      <option value="4Q" > Fourth Quarter</option>
                  </select>
                </div>

                <div class="col-lg-6 col-md-6 col-sm-12 col-xs-12">
                  <label>Select files</label>
                  <input class="img" type="file" name="files[]" accept="image/*" multiple="" required/>  
                </div>


              </div>
              <hr/>

                <h4  id="prog_percent">0%</h4>
                <div class="progress progress-striped mb-0" style="height:7px;">
                    <div id="prog_bar" aria-valuemax="100" aria-valuemin="0" role="progressbar" class="progress-bar progress-bar-success">
                    </div>
                </div>     
         </div>

         <div class="panel-footer">
           <button class="btn btn-blue submit2" name="upload" type="submit">Upload Grade</button>
         </div>

       </form>
     </div>

        <form id="frmSubmit" action="<?php echo base_url()?>padmin/save_ps_grade"  method="POST">

          <div class="tbl_section"></div>

          <button class="btn btn-blue submit hidden" type="submit">Upload Grade</button>
          <br/><br/>
          <div class="msg"></div>
        </form>


    </div>

    <div class="col-lg-6 col-md-6 col-sm-12 col-xs-12">
      <table class="table table-condensed table-bordered">
        <thead>
          <th class="text-center vmiddle width-2">No.</th>
          <th class="vmiddle">Name</th>
          <th >Filename</th>
        </thead>
        <tbody>

          <?php 
            $cnt = 1;
            $qtr_code   = $this->module->get_active_qtr_code();
            foreach($students->result() as $r):
              $stud_name  = $r->stud_lastname.', '.$r->stud_firstname;
              $stud_id    = $r->stud_id; 
            ?>

            <tr>
              <td class="text-center vmiddle"><?=$cnt++?></td>
              <td class="vmiddle"> <?=$stud_id.' '.$stud_name?></td>
              <td class="vmiddle">
                <?php 
                  foreach($ps_grade->result() as $p){
                    $pstud_id = $p->stud_id;
                    $psg_id   = $p->psg_id;
                    $psec_id  = $p->sec_id;

                    if($stud_id == $pstud_id){
                      echo '<button class="btn btn-xs btn-default btn_delete" data-id="'.$psg_id.'"><i class="fa fa-times"></i></button>';
                      echo '&nbsp&nbsp&nbsp <a href="'.base_url().'asset/uploads/PS Grades/'.$sy_id.'/'.$qtr_code.'/'.$psec_id.'/'. $p->psg_grade.'" target="_blank"> '.$p->psg_grade.'</a>';
                    }
                  }
                    
                ?>
              </td>
              
              
            </tr>

          <?php endforeach;?>

        </tbody>
      </table>
    </div>
  </div>

  
   
  
    

  
        
       

        
    </div><!---END MAIN CONTENT -->
</div> <!-- end of body container -->

<?= $this->load->view('inc/js')?>
<script type="text/javascript" charset="utf-8">
  $(document).ready(function() {

  bar      = $('#prog_bar');
  percent  = $('#prog_percent');
  msg      = $('.upload_msg');
  btn      = $('.submit2');

  $('#form_upload').ajaxForm({
        data:$(this).serialize(),
            beforeSend: function() {
                var percentVal = '0%';
                bar.empty().width(percentVal);
                percent.html(percentVal);
            },
            uploadProgress: function(event, position, total, percentComplete,e){
                var percentVal = percentComplete + '%';
                bar.empty().width(percentVal);
                percent.html(percentVal);
                btn.prop('disabled', true);
                
            },
            success: function() {
                var percentVal = '100%';
                bar.width(percentVal)
                percent.html(percentVal);

            },
            complete: function(xhr){
                var rdata = $.parseJSON(xhr.responseText);
                $(".upload").prop("disabled",false);
                if(rdata){
                    if(rdata.stat){
                        msg.html(alert_success(rdata.msg));
                        //location.reload();

                        sec_id = rdata.id;
                        $('.tbl_section').load(base_url+'padmin/load_ps_section/'+sec_id);
                        $('.submit').removeClass('hidden');

                        btn.prop('disabled', true);
                        $('#form_upload')[0].reset();
                    }
                    else{
                        bar.empty().width(0);
                        percent.html('0%');
                        msg.html(alert_error(rdata.msg));
                        btn.prop('disabled', false);
                    }
                }
                else{
                    msg.html(alert_error("Oooops! An error occured upon uploading."));
                    btn.prop('disabled', false);
                }
            },
            error:function(){
                msg.html(alert_error("Oooops! An error occured upon uploading."));
                btn.prop('disabled', false);
            }
   });//END AJAX UPLOAD

  $('#frmSubmit').crud_refresh();

  $(document.body).on('click','.clear',function(e){
    e.preventDefault();

    tr      = $(this).closest('tr');
    //select  = tr.find('.stud_img').val('');

    //tr.find(".stud_img option:selected").prop("selected", false).val('');
    tr.find('.stud_img').prop('selectedIndex',0);

  });

  $('.btn_delete').click(function(e){
    e.preventDefault();

    id = $(this).data('id');

    console.log(id);

      $.ajax({url: base_url+'padmin/delete_ps_grade/'+id, 
            success: function(result){

              //console.log(result);
            window.setTimeout(function(){location.reload()},500);
      }
    });


  });


    /*$(document.body).on('change','.stud_img',function(e){
      e.preventDefault();

      $('option option:selected').each(function() {
        !this.selected ? $(this).attr('disabled', true) : "";
      });

     //$(".stud_img option:selected").attr('disabled','disabled').siblings().removeAttr('disabled');
    });*/
       
  });

</script>
</body>
</html>