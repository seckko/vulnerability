<?php 

    
  $usr_name         = $this->session->userdata('usr_name');
  $prtl_fname       = $this->session->userdata('prtl_fname');
  $prtl_lname       = $this->session->userdata('prtl_lname');
  $usr_is_login     = $this->session->userdata('usr_is_login');
  $sy_id            = $this->module->get_active_sy();

  $uri_sy           = $this->uri->segment(3);
  if(empty($uri_sy)){
    $sy_id = $sy_id;
  }else{
    $sy_id = $uri_sy;
  }

  /*$where           = 'tch_id = "'.$tch_id.'"  AND sy_id = "'.$sy_id.'" ';

  if( ($usr_type <> 'Faculty') || empty($tch_id) ){
    header('Location: '.base_url());
  }*/

?>


<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <title><?= $title;?></title>

    <?= $this->load->view('inc/css')?>

</head>
<body class="page-body " >

<div class="page-container">

    <div class="sidebar-menu">

        <div class="sidebar-menu-inner">
            <?= $this->load->view('inc/portal_sidebar')?>
        </div>

    </div>

    <div class="main-content">
        <div class="row">
            <div class="col-md-8 col-xs-6">
                <h3 class="m-0">Due Accounts</h4>
            </div>

            <div class="col-md-4 col-xs-6">
                <label>School Year</label>
                <select class="form-control selectboxit has-success sy_id" name=""  >  <!--  onchange= "location = this.value" -->
                  <option disabled="" selected="">Select School Year</option>             
                  <?php 
                      foreach ($school_year->result() as $k):
                        $ksy_id = $k->sy_id;
                  ?>
                      <option value="<?=$k->sy_id?>" <?=($sy_id == $ksy_id ? 'selected="" ' : ''  )?> > S Y. <?= $k->sy_name?></option>
                  <?php endforeach; ?>
              </select>
            </div>
        </div>
        
        <hr/>

          <?php if($my_learners->num_rows() > 0):?>
              <div class="row">
                <?php 
                    $all_balance = 0;
                    foreach($my_learners->result() as $r):
                    $student_name  = $r->stud_lastname.', '. $r->stud_firstname.' '.$r->stud_suffix;
                    $gr_section    = $r->lvl_name.'-'.$r->sec_name;
                    $stud_id       = $r->stud_id;
                    $balance       = $this->module->get_out_balance($stud_id, $sy_id);

                    $all_balance += $balance['total'];
                ?>
                <!-- <a href="#" class="stud_payment" data-id="<?=$stud_id?>"> -->
                  <div class="col-md-3 col-xs-12">
                    <div class="member-entry p-10 mb-0">
                        
                        <h4><?=$student_name?></h4>
                        <table class="table table-condensed  mb-0">
                          <tbody>
                           
                            <tr>
                              <td>
                                <small class="title-header">Outstanding Balance</small>
                                <h2 class="m-0 bold"><?=number_format($balance['total'],2)?></h2>
                              </td>

                              <td class="text-right">
                                <small class="title-header">Mode of Payment</small>
                                <h5 class="m-0 ">
                                  <?php
                                    switch($balance['payment_mode']){
                                      case 'C':
                                        echo 'ANNUALLY';
                                        break;
                                      case 'Q':
                                        echo 'QUARTERLY';
                                        break;
                                      case 'S':
                                        echo 'SEMESTRAL';
                                        break;
                                      case 'M':
                                        echo 'MONTHLY';
                                        break;
                                      default:
                                        echo '---';
                                        break;

                                    }
                                  ?>
                                </h5>
                                <span class="bold"><?=number_format($balance['student_tf'])?></span>
                              </td>

                            </tr>

                            <tr>
                              <td>
                                <small>
                                  <i class="fa fa-calendar"></i> Payment Schedule
                                </small>
                              </td>
                              <td class="text-right">
                                <small>
                                <?php
                                  switch($balance['payment_mode']){
                                    case 'C':
                                      echo '---';
                                      break;
                                    case 'Q':
                                      echo 'Aug, Oct, Jan - 15';
                                      break;
                                    case 'S':
                                      echo 'October 15';
                                      break;
                                    case 'M':
                                      echo 'Every 15 of the month';
                                      break;
                                    default:
                                      echo '---';
                                      break;
                                  }
                                ?>
                                </small>
                              </td>
                            </tr>
                          </tbody>
                        </table>

                    </div>
                  </div>
                <!-- </a> -->
                <?php endforeach; ?>

                <!-- <div class="col-md-3 mt-15">
                  <h3 class=" m-0 text-danger">Total Balance</h3>
                  <small class="text-danger">To view your grades, we advice to settle your accounts.</small>
                  
                  <table class="table table-condensed  mb-0 mt-10">
                      <tbody>
                       
                        <tr>
                          <td colspan="2" class="text-right">
                            <h1 class="m-0 bold text-danger"><?=number_format($all_balance,2)?></h1>                                
                          </td>
                        </tr>
                      </tbody>
                    </table>
                </div> -->

              </div>

              <!-- <hr/>
              
              <div class="row">
                
              </div> -->

              <hr/>


              <?php if($my_learners->num_rows() > 0):?>

                <div class="row">
                  <div class="col-md-10">
                    <h4 class="bold">Payment History</h4>

                    <div class="panel-group joined" id="accordion-test-2">
          
                      
                      <?php 

                        foreach($my_learners->result() as $r):
                          $student_name  = $r->stud_lastname.', '. $r->stud_firstname.' '.$r->stud_suffix;
                          $gr_section    = $r->lvl_name.'-'.$r->sec_name;
                          $stud_id       = $r->stud_id;
                          $balance       = $this->module->get_out_balance($stud_id, $sy_id);

                          /*ENROLLMENT DATA*/
                          $enrollment_data = $this->module->get_query("SELECT * FROM v_student_payment WHERE  stud_id = ".$stud_id." AND sy_id = ".$sy_id." and se_status = 'Enrolled' ");

                          /*PAYMENT RECORD - TUITION FEE*/
                          $payment_record  = $this->module->get_query("SELECT *, ROUND(tf_sub_total,2) AS tf_paid, ROUND( ( (tf_amount_due + tf_fine_amount) - tf_sub_total ) ,2) AS balance FROM v_student_payment_record_tf WHERE stud_id = ".$stud_id." AND sy_id = ".$sy_id."  ORDER BY tf_payment_date ASC ");

                      ?>
                        
                        <div class="panel panel-default" style="">
                          <div class="panel-heading" style="background-color: #f9f9f9;">
                            <h4 class="panel-title">
                              <a data-toggle="collapse" data-parent="#accordion-test-2" href="#collapseTwo-<?=$stud_id?>" class="collapsed">
                                <i class="fa fa-caret-right"></i> <?=$student_name.' <small>- '.$gr_section.'</small>'?>
                              </a>
                            </h4>
                          </div>
                          <div id="collapseTwo-<?=$stud_id?>" class="panel-collapse collapse bg-white">
                            <div class="panel-body">
                              <?php if($enrollment_data->num_rows() > 0): ?>
                                  <table class="table table-condensed table-hover responsive">
                                      <thead>
                                        <th class="bold">No.</th>
                                        <th class="bold">Period</th>
                                        <th class="bold">Remarks</th>
                                        <th class="bold">Type</th>
                                        <th class="text-right bold">Amount Due</th>
                                        <th class="text-right bold">Fines</th>
                                        <th class="text-right bold">Amount Paid</th>
                                        <th class="text-right bold">Date</th>
                                      </thead>

                                      <tbody>
                                        <?php 

                                            foreach($enrollment_data->result() as $e):

                                            $sap_total_payment  = $e->sap_total_payment;
                                            $sap_other_fee      = $e->sap_other_fee;
                                            $e_tf_amount_due    = $sap_total_payment - $sap_other_fee;

                                        ?>
                                        <tr>
                                          <td>1</td>
                                          <td>Upon Enrollment</td>
                                          <td><?=$e->lvl_name.' - '.$e->sec_name?></td>
                                          <td></td>
                                          <td class="text-right"><?=number_format($e_tf_amount_due,2)?></td>
                                          <td class="text-right">(0%) 0.00</td>
                                          <td class="text-right"><?=number_format($e_tf_amount_due,2)?></td>
                                          <td class="text-right">
                                            <?= date('m/d/y',strtotime($e->sap_payment_date)) ?>
                                          </td>
                                        </tr>
                                        <?php endforeach;?>

                                        <?php 
                                          $cnt = 2;

                                          if($payment_record->num_rows() > 0):

                                          foreach($payment_record->result() as $r):
                                            $tf_payment_type    = $r->tf_payment_type;
                                            $tf_bank_name       = $r->tf_bank_name;
                                            $tf_account_number  = $r->tf_account_number;

                                            $tf_amount_due      = $r->tf_amount_due;
                                            $tf_fine            = $r->tf_fine_percentage;
                                            $tf_fine_amount     = $r->tf_fine_amount;
                                            $tf_sub_total       = $r->tf_sub_total;

                                        ?>
                                          <tr>
                                            <td><?=$cnt++?></td>
                                            <td><?=$r->tf_months?></td>
                                            <td><?=$r->tf_remarks?></td>
                                            <td>
                                              <?=$tf_payment_type == 'Cash' ? $tf_payment_type : $tf_payment_type . ' - ('.$tf_bank_name.' : '.$tf_account_number.')'?>
                                            </td>
                                            <td class="text-right"><?=number_format($tf_amount_due,2)?></td>
                                            <td class="text-right"><?= '('.$tf_fine.'%) ' .number_format($tf_fine_amount,2)?></td>
                                            <td class="text-right"><?=number_format($tf_sub_total,2)?></td>
                                            <td class="text-right"><?=date('m/d/y', strtotime($r->tf_payment_date))?></td>
                                          </tr>

                                        <?php endforeach;?>
                                        
                                        <?php endif; ?>

                                      </tbody>
                                  </table> 
                              <?php else:?>
                                <h2>No record found</h2>
                              <?php endif;?>
                            </div>
                          </div>
                        </div>

                      <?php endforeach;?>

                    </div>

                   
                  </div>
                </div>

              <?php endif; ?>



          <?php else:?>
            <h3>No record found</h3>
          <?php endif;?>

    </div><!-- end of main-container -->

        
        

    

    
</div> <!-- end of body container -->


<?= $this->load->view('inc/js')?>
<script type="text/javascript" charset="utf-8">
  $(document).ready(function() {
       
       $('.sy_id').change(function(){
          val = $(this).val();
          window.location = base_url+'portal/view_due_accounts/'+val;
       });

  });
</script>
</body>
</html>