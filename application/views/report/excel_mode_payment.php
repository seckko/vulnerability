<?php 

/*header('Content-Description: File Transfer');
header('Content-Type: application/octet-stream');
header('Content-Disposition: attachment; filename="MasterListModePayment.xls', date( 'd m Y' ));
header('Content-Transfer-Encoding: binary');
header('Expires: 0');
header('Cache-Control: must-revalidate, post-check=0, pre-check=0');
header('Pragma: public');
echo "\xEF\xBB\xBF"; // UTF-8 BOM*/

?>

<style type="text/css">
  .text-center{
    text-align: center !important;
  }

  .text-danger{
    color: #ff6c60;
  }

  table {
    border-collapse: collapse;
  }


  table, th, td {
    border: thin solid #373e4a;
    padding:2px 10px;
  }

  td{
    text-align: left !important;
  }

  th{
    background:#dbdbdd !important;
  }

  td.green{
    color: white !important;
      background-color: #109618 !important;
  }

  td.orange{
    color: white !important;
      background-color: #FF9900 !important;
  }

  .text-left{
    text-align: left !important;
  }

  .text-right{
    text-align: right !important;
  }

  .text-center{
    text-align: center !important;
  }

</style>

<h1 style="margin-bottom: 5px;"> <?=$title;?> </h1>
<br/>

<table>
    <thead>
        <th class="width-5 text-center" style="background: #dbdbdd;">No.</th>
        <th class="text-center" style="background: #dbdbdd;">Student Name</th>
        <th class="text-center">Mode of Payment</th>
        <th class="text-center">Sibling Discount</th> 
        <th class="text-center">Payment</th>
        <th class="text-center">JUL</th>
        <th class="text-center">AUG</th>
        <th class="text-center">SEP</th>
        <th class="text-center">OCT</th>
        <th class="text-center">NOV</th>
        <th class="text-center">DEC</th>
        <th class="text-center">JAN</th>
        <th class="text-center">FEB</th>
    </thead>

    <tbody>
      <?php foreach($section->result() as $r): ?>
        <!-- <tr>
          <td style="border: none !important;"></td>
        </tr> -->
      <tr>
        <td colspan="2" class="bold" style="font-size:16px; font-weight: 900; border: none !important;" ><?= strtoupper($r->lvl_name).' - '.strtoupper($r->sec_name)  ?></td>
        <td  style="font-size:16px; font-weight: 900; border: none !important;"></td>
      </tr>

      <?php 
            //$get_student   = $this->module->get_query("SELECT * FROM v_section_students WHERE sy_id = ".$sy_id." AND sec_id = ".$r->sec_id." ORDER BY stud_lastname ASC ");
            $mode          = $this->module->get_query("SELECT * FROM v_student_mode_payment WHERE sy_id = ".$sy_id." AND sec_id = ".$r->sec_id." ORDER BY stud_lastname ASC ");

        ?>

        <?php 
            $cnt = 1; 
            foreach($mode->result() as $k): 

              $has_discount = ($k->sad_has_sib_discount == 'Y' ? 'Yes' : '');

              $mode_payment = ucfirst(strtolower($k->se_mode_payment));
              $payment      = $this->module->get_query("SELECT * FROM v_new_fee_schedule WHERE fee_type = '".$mode_payment."' AND dept_id = ".$k->dept_id." ");
              
        ?>


        <tr>
            <td class="text-center"><small><?= $cnt++; ?></small></td>
            <td>
                <?php 
                    
                    $stud_name = $k->stud_lastname.', '.$k->stud_firstname.' '.substr($k->stud_middlename, 0,1).(empty($k->stud_middlename) ? '' : '. ').$k->stud_suffix;
                    echo ucwords($stud_name);
                ?>
            </td>
            <td><?=$mode_payment?></td>
             <td class="text-center"><?=$has_discount?></td> 
            <td class="text-right">
            <?php 
                $amount         = 0;
                $discount       = 0.10;
                $msc_mo         = 300;
                $msc_quar       = 800;
                $msc_sem        = 2400;
                $sa_is_scholar  = $k->sa_is_scholar;

                if($sa_is_scholar == 'N'){
                    $department = $k->dept_name;

                    foreach($payment->result() as $r){

                        $rmode = $r->fee_type;

                        $amount_paid  = $k->sad_sub_total - $k->sad_sib_discount_amount;
                        $original_tf  = ($r->fee_full_amount) - $amount_paid ;
                       

                        if($rmode == 'Monthly'){
                          if($has_discount == 'Yes'){
                            $amount       = $k->sad_tuition_fee - ($k->sad_tuition_fee * $discount) ;
                          }else{
                            $amount = $original_tf / 8;
                          }
                          
                        }else if($rmode == 'Quarterly'){
                          if($has_discount == 'Yes'){
                            $amount       = $k->sad_tuition_fee - ($k->sad_tuition_fee * $discount) ;
                          }else{
                            $amount = $original_tf / 3;
                          }
                        }else if($rmode == 'Semestral'){
                          if($has_discount == 'Yes'){
                            $amount       = $k->sad_tuition_fee - ($k->sad_tuition_fee * $discount) ;
                          }else{
                            $amount = $original_tf / 1;
                          }
                        }else{
                          $amount = $amount;
                        }

                        $new_amount = 0;
                        if($department <> 'Pre-School' && $has_discount == 'Yes'){
                          if($rmode == 'Monthly'){
                            $new_amount = $amount + $msc_mo;
                          }else if($rmode == 'Quarterly'){
                            $new_amount = $amount + $msc_quar;
                          }else if($rmode == 'Semestral'){
                            $new_amount = $amount + $msc_sem;
                          }else{
                            $new_amount = $amount;
                          }
                        }else{
                          $new_amount = $amount;
                        }

                        if($new_amount <=0){
                          echo '----';
                        }else{
                          echo number_format($new_amount);
                        }
                    
                    }
                }else{

                  if($k->se_mode_payment == 'CASH'){
                    echo '----';
                  }else{
                    echo number_format($k->sad_total_school_fees);
                  }
                  
                }

              ?>
               
           
            </td>

            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
        </tr>

    <?php endforeach; ?>

      <?php endforeach; ?>
      
    </tbody>

</table>
<?php 

//header('Content-Type:application/xls');
//header("Content-Disposition:attachment; filename=MasterList.xls");
?>
