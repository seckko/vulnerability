<?php 

/*header('Content-Description: File Transfer');
header('Content-Type: application/octet-stream');
header('Content-Disposition: attachment; filename="MasterList.csv', date( 'd m Y' ));
header('Content-Transfer-Encoding: binary');
header('Expires: 0');
header('Cache-Control: must-revalidate, post-check=0, pre-check=0');
header('Pragma: public');
echo "\xEF\xBB\xBF"; // UTF-8 BOM*/

?>

<style type="text/css">
  .text-center{
    text-align: center !important;
  }

  .text-danger{
    color: #ff6c60;
  }

  table {
    border-collapse: collapse;
  }


  table, th, td {
    border: thin solid #373e4a;
    padding:2px 10px;
  }

  td{
    text-align: left !important;
  }

  th{
    background:#dbdbdd !important;
  }

  td.green{
    color: white !important;
      background-color: #109618 !important;
  }

  td.orange{
    color: white !important;
      background-color: #FF9900 !important;
  }

  .text-left{
    text-align: left !important;
  }

  .text-right{
    text-align: right !important;
  }

  .text-center{
    text-align: center !important;
  }

</style>

</style>

<h2 class="bold"><?=strtoupper($title)?></h2>
<h4>SY <?=$this->module->get_active_sy_name()?></h4>
<hr/>


<?php 
                                    
$ot_jul = 0; 
$ot_aug = 0; 
$ot_sep = 0; 
$ot_oct = 0; 
$ot_nov = 0; 
$ot_dec = 0; 
$ot_jan = 0; 
$ot_feb = 0; 
$ot_mar = 0; 

$cnt     = 1;
$tjul    = 0;
$taug    = 0;
$tsep    = 0;
$toct    = 0;
$tnov    = 0;
$tdec    = 0;
$tjan    = 0;
$tfeb    = 0;
$tmar    = 0;

$overall_total  = 0;
$mo             = array( 'jul', 'aug', 'sep', 'oct', 'nov', 'dec', 'jan', 'feb', 'mar');  ?>

<?php foreach($level->result() as $r): 
    $lvl_name  = preg_replace('/\s+/', '', $r->lvl_name); 
?>

<table class="table table-bordered table-condensed table-responsive table-hover ">
    <thead>
        
        <th class="width-5 text-center">No.</th>
        <th class="text-center">Student Name</th>
        <th class="text-center">Section</th>
        <th class="text-center vmiddle width-5">Mode</th>
        <th class="text-center vmiddle width-5">Discount</th>
        
        <?php for($x=0; $x < count($mo); $x++ ):?>
        <th class="text-center vmiddle width-5"><?= ucfirst($mo[$x])?></th>
        <?php endfor;?>
        <th class="text-center vmiddle width-10"> TOTAL</th>
    </thead>

    <tbody>

        <?php 
           $sy             = $this->module->get_active_sy();
           $student_list   = $this->module->get_query("SELECT * FROM v_student_fees WHERE sy_id = ".$sy." AND lvl_id = ".$r->lvl_id." ORDER BY stud_lastname ASC ");
        ?>

        <?php 
            

            $mf      = 0;
            $mo_mf   = 300;
            $qua_mf  = 800;
            $sem_mf  = 2400;
            $base_tf = 0;

            $njul          = 0;
            $naug          = 0;
            $nsep          = 0;
            $noct          = 0; 
            $nnov          = 0; 
            $ndec          = 0; 
            $njan          = 0; 
            $nfeb          = 0; 
            $nmar          = 0; 

            $nQ2           = 0; 
            $nQ3           = 0; 
            $nQ4           = 0; 

            $nS2           = 0;

            
            

            $total_monthly   = 0;
            $total_quarterly = 0;
            $total_semestral = 0;

            $grand_total   = 0;
            $fee_tf        = 0;


            foreach($student_list->result() as $k): 


                $kstud_id               = $k->stud_id;
                $sa_is_scholar          = $k->sa_is_scholar;
                $sad_has_sib_discount   = $k->sad_has_sib_discount;
                $mode                   = substr($k->se_mode_payment,0,1);
                $dept_id                = $k->dept_id;
                $dept_name              = $k->dept_name;

                $fee_type               = '';
               

                foreach ($active_tf->result() as $a) {
                    $adept_id    = $a->dept_id;
                    $fee_type    = substr($a->fee_type,0,1);

                    if( ($adept_id == $dept_id) && ($fee_type == $mode) ){
                        
                        $fee_tf      = $a->fee_tf;

                        if($fee_type == 'M'){
                            $mf     = $mo_mf;
                        }else if($fee_type == 'Q'){
                            $mf  = $qua_mf;
                        }else if($fee_type == 'S'){
                            $mf  = $sem_mf;
                        }else if($fee_type == 'C'){
                            $mf  = 0;
                        }

                    }
                }

                /*COMPUTATION MONTHLY*/
                $ten_percent  = ($fee_tf * 0.10);
                
                if($sa_is_scholar == 'N'){
                    if($dept_name <> 'Pre-School'){
                        if($sad_has_sib_discount == 'N'){
                            $base_tf = $fee_tf + $mf;
                        }else{
                            $base_tf = ($fee_tf - $ten_percent) + $mf;
                        }
                    }else{
                        if($sad_has_sib_discount == 'N'){
                            $base_tf = $fee_tf;
                        }else{
                            $base_tf = ($fee_tf - $ten_percent);
                        }
                    }
                }else{
                    //if not preschool and scholar
                    $base_tf = 0;
                }

                $jul           = 0;
                $aug           = 0;
                $sep           = 0;
                $oct           = 0;
                $nov           = 0;
                $dec           = 0;
                $jan           = 0;
                $feb           = 0;
                $mar           = 0;

                $Q2            = 0;
                $Q3            = 0;
                $Q4            = 0;
                $S2            = 0;



                if($payment_data->num_rows() <= 0){
                    $jul           = 0;
                    $aug           = 0;
                    $sep           = 0;
                    $oct           = 0;
                    $nov           = 0;
                    $dec           = 0;
                    $jan           = 0;
                    $feb           = 0;
                    $mar           = 0;

                    $Q2            = 0;
                    $Q3            = 0;
                    $Q4            = 0;
                    $S2            = 0;

                }else{
                    foreach($payment_data->result() as $p){
                        $pstud_id = $p->stud_id;

                        if($pstud_id == $kstud_id){

                            //echo $pstud_id . ' - '. $kstud_id.' > '.$p->stud_lastname.', '.$p->stud_firstname.'<br/>';

                            $months     = $p->tf_months; 
                            $tf_amount  = $p->tf;



                            switch ($months) {
                                case 'July':
                                    $jul    =  empty($tf_amount) ? 0 : $tf_amount;
                                    //echo $p->stud_firstname.' > Jul : '.$jul.'<br/>';
                                    //$tjul   += $jul;
                                    break;

                                case 'August':
                                    $aug    =  $tf_amount;
                                    //$taug   += $aug;
                                    break;

                                case 'September':
                                    $sep    =  $tf_amount;
                                    //$tsep   += $sep;
                                    break;

                                case 'October':
                                    $oct    =  $tf_amount;
                                    //$toct   += $oct;
                                    break;

                                case 'November':
                                    $nov    =  $tf_amount;
                                    //$tnov   += $nov;
                                    break;

                                case 'December':
                                    $dec    =  $tf_amount;
                                    //$tdec   += $dec;
                                    break;

                                case 'January':
                                    $jan    =  $tf_amount;
                                    //$tjan   += $jan;
                                    break;

                                case 'February':
                                    $feb    =  $tf_amount;
                                    //$tfeb   += $feb;
                                    break;

                                case 'March':
                                    $mar    =  $tf_amount;
                                    //$tmar   += $mar;
                                    break;


                                case '2nd Quarter':
                                    $Q2     =  $tf_amount;
                                    //$taug   += $Q2;
                                    break;

                                case '3rd Quarter':
                                    $Q3     =  $tf_amount;
                                    //$toct   += $Q3;
                                    break;

                                case '4th Quarter':
                                    $Q4     =  $tf_amount;
                                    //$tjan   += $Q4;
                                    break;

                                case '2nd Semester':
                                    $S2     =  $tf_amount;
                                    //$toct   += $S2;
                                    break;
                                
                                default:
                                    # code...
                                    break;
                            }

                        }
                        
                    }

                    $njul = $base_tf >= $jul ? $base_tf - $jul : 0; 
                    $naug = $base_tf >= $aug ? $base_tf - $aug : 0; 
                    $nsep = $base_tf >= $sep ? $base_tf - $sep : 0;  
                    $noct = $base_tf >= $oct ? $base_tf - $oct : 0; 
                    $nnov = $base_tf >= $nov ? $base_tf - $nov : 0;  
                    $ndec = $base_tf >= $dec ? $base_tf - $dec : 0;  
                    $njan = $base_tf >= $jan ? $base_tf - $jan : 0; 
                    $nfeb = $base_tf >= $feb ? $base_tf - $feb : 0; 
                    $nmar = $base_tf >= $mar ? $base_tf - $mar : 0; 

                    $nQ2  = $base_tf >= $Q2 ? $base_tf - $Q2 : 0; 
                    $nQ3  = $base_tf >= $Q4 ? $base_tf - $Q4 : 0; 
                    $nQ4  = $base_tf >= $Q4 ? $base_tf - $Q4 : 0; 

                    $nS2  = $base_tf >= $Q2 ? $base_tf - $Q2 : 0; 
                }
        
                
                    
                    

                    $total_monthly      =  $njul + $naug + $nsep + $noct + $nnov + $ndec + $njan + $nfeb ;
                    $total_quarterly    =  $nQ2 + $nQ3 + $nQ4;
                    $total_semestral    =  $nS2 ;    

                                                                                          
                ?>
            <tr>
                <td class="text-center width-5"><?= $cnt++; ?></td>
                <td >
                    <?php 
                        
                        $suffix     = $k->stud_suffix;
                        $middlename = $k->stud_middlename;


                        if(empty($suffix)){
                            if(empty($middlename)){
                                    $fullname = $k->stud_lastname.', '.$k->stud_firstname;
                                }else{
                                    $fullname = $k->stud_lastname.', '.$k->stud_firstname.' '. substr($k->stud_middlename,0,1).'.';
                                }
                            echo ucwords($fullname);
                        }else{
                            if(empty($middlename)){
                                $fullname = $k->stud_lastname.', '.$k->stud_firstname.' '.$k->stud_suffix;
                            }else{
                                $fullname = $k->stud_lastname.', '.$k->stud_firstname.' '.$k->stud_suffix .' '. substr($k->stud_middlename,0,1).'.';
                            }

                            echo ucwords($fullname);
                        }
                    ?>
                </td>

                <td><?= $k->sec_name ?></td>
                <td class="text-center "><?= $mode ?></td>
                <td class="text-center "><?=$sad_has_sib_discount?></td>
                <?php if($mode == 'M'):?>
                    <td class="text-right"><?=number_format($njul, 2)?></td>
                    <td class="text-right"><?=number_format($naug, 2)?></td>
                    <td class="text-right"><?=number_format($nsep, 2)?></td>
                    <td class="text-right"><?=number_format($noct, 2)?></td>
                    <td class="text-right"><?=number_format($nnov, 2)?></td>
                    <td class="text-right"><?=number_format($ndec, 2)?></td>
                    <td class="text-right"><?=number_format($njan, 2)?></td>
                    <td class="text-right"><?=number_format($nfeb, 2)?></td>
                    <td class="text-right"><?= $sa_is_scholar == 'N' ? '======' :  number_format($nmar, 2)?></td>
                    <td class="text-right bold"><?=number_format( $total_monthly, 2)?></td>
                <?php endif;?>

                <?php if($mode == 'Q'):?>
                    <td class="text-right">======</td>
                    <td class="text-right"><?=number_format($nQ2, 2)?></td> <!-- august -->
                    <td class="text-right">======</td>
                    <td class="text-right"><?=number_format($nQ3, 2)?></td> <!-- october -->
                    <td class="text-right">======</td>
                    <td class="text-right">======</td>
                    <td class="text-right"><?=number_format($nQ4, 2)?></td> <!-- january -->
                    <td class="text-right">======</td>
                    <td class="text-right">======</td>
                    <td class="text-right bold"><?=number_format( $total_quarterly , 2)?></td>
                <?php endif;?>

                <?php if($mode == 'S'):?>
                    <td class="text-right">======</td>
                    <td class="text-right">======</td>
                    <td class="text-right">======</td>
                    <td class="text-right"><?=number_format($nS2, 2)?></td> <!-- october -->
                    <td class="text-right">======</td>
                    <td class="text-right">======</td>
                    <td class="text-right">======</td>
                    <td class="text-right">======</td>
                    <td class="text-right">======</td>
                    <td class="text-right bold"><?=number_format( $total_semestral, 2)?></td>
                <?php endif;?>

                <?php if($mode == 'C'):?>
                    <td class="text-right">======</td>
                    <td class="text-right">======</td>
                    <td class="text-right">======</td>
                    <td class="text-right">======</td>
                    <td class="text-right">======</td>
                    <td class="text-right">======</td>
                    <td class="text-right">======</td>
                    <td class="text-right">======</td>
                    <td class="text-right">======</td>
                    <td class="text-right bold"><?=number_format(0,2)?></td>
                <?php endif;?>

            </tr>
        <?php endforeach; ?>

    </tbody>
    <tfoot>
        <tr>
            <td colspan="5" class="text-right bold">Total</td>
            <td class="text-right bold"><?=number_format($tjul,2)?></td>
            <td class="text-right bold"><?=number_format($taug,2)?></td>
            <td class="text-right bold"><?=number_format($tsep,2)?></td>
            <td class="text-right bold"><?=number_format($toct,2)?></td>
            <td class="text-right bold"><?=number_format($tnov,2)?></td>
            <td class="text-right bold"><?=number_format($tdec,2)?></td>
            <td class="text-right bold"><?=number_format($tjan,2)?></td>
            <td class="text-right bold"><?=number_format($tfeb,2)?></td>
            <td class="text-right bold"><?=number_format($tmar,2)?></td>
            <td class="text-right bold"><?=number_format($grand_total,2)?></td>
        </tr>
    </tfoot>
</table>

<br/>
<br/>

<?php endforeach;?>


    
<?php 

header('Content-Type:application/xls');
header("Content-Disposition:attachment; filename=Receivables.xls");
?>
