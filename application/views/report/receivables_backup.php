<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <title><?= $title;?></title>

    <?= $this->load->view('inc/css')?>

</head>
<body class="page-body gray">

<div class="page-container"><!-- add class "sidebar-collapsed" to close sidebar by default, "chat-visible" to make chat appear always -->
    
    <div class="sidebar-menu">

        <div class="sidebar-menu-inner">
            <?= $this->load->view('inc/sidebar')?>
        </div>

    </div>

    <div class="main-content"> <!---START MAIN CONTENT -->
         

        <div class="row">
            <div class="col-md-12">
                <div class="panel panel-primary panel-table">

                    <div class="panel-body">
                        
                        <div class="row">
                            <div class="col-md-12">

                                <div class="row">
                                    <div class="col-md-8">
                                        <h2 class="bold"><?=strtoupper($title)?></h2>
                                        <h4>SY <?=$this->module->get_active_sy_name()?></h4>
                                    </div>

                                    <div class="col-md-4 text-right">
                                        <a href="<?=base_url()?>report/print_receivables" class="btn btn-primary"><i class="fa fa-print"></i> Print</a>
                                    </div>

                                </div>

                                <hr/>

                                <ul class="nav nav-tabs bordered"><!-- available classes "bordered", "right-aligned" -->

                                    <?php foreach($level->result() as $r): 
                                        $lvl_name  =  preg_replace('/\s+/', '', $r->lvl_name); 
                                    ?>
            
                                    <li class=" <?= ($lvl_name == 'Nursery' ? 'active' : '' ) ?> ">
                                        <a href="#<?=$lvl_name?>" data-toggle="tab">
                                            <span class="hidden-xs"><?=$r->lvl_name?></span>
                                        </a>
                                    </li>

                                    <?php endforeach; ?>
                                </ul>

                                <div class="tab-content">

                                    <?php 

                                        
                                        /*$ot_jul = 0; 
                                        $ot_aug = 0; 
                                        $ot_sep = 0; 
                                        $ot_oct = 0; 
                                        $ot_nov = 0; 
                                        $ot_dec = 0; 
                                        $ot_jan = 0; 
                                        $ot_feb = 0; 
                                        $ot_mar = 0;*/ 

                                        $tjul    = 0;
                                        $taug    = 0;
                                        $tsep    = 0;
                                        $toct    = 0;
                                        $tnov    = 0;
                                        $tdec    = 0;
                                        $tjan    = 0;
                                        $tfeb    = 0;
                                        $tmar    = 0;

                                        $cnt     = 1;
                                        $mf      = 0;
                                        $mo_mf   = 300;
                                        $qua_mf  = 800;
                                        $sem_mf  = 2400;
                                        $base_tf = 0;

                                        $sy      = $this->module->get_active_sy();

                                    
                                        

                                        $overall_total  = 0;
                                        $mo             = array( 'jul', 'aug', 'sep', 'oct', 'nov', 'dec', 'jan', 'feb', 'mar');  ?>


                                    <?php foreach($level->result() as $r): 
                                        $lvl_name  = preg_replace('/\s+/', '', $r->lvl_name); 
                                    ?>

                                    <div class="tab-pane <?= ($lvl_name == 'Nursery' ? 'active' : '' ) ?> " id="<?=$lvl_name?>">
                                        <h3 class="bold"><?=$r->lvl_name?></h3>

                                        <div class="row">
                                                <div class="col-md-12">
                                                    <table class="table table-bordered table-condensed table-responsive table-hover ">
                                                        <thead>
                                                            
                                                            <th class="width-5 text-center">No.</th>
                                                            <th class="text-center">Student Name</th>
                                                            <th class="text-center">Section</th>
                                                            <th class="text-center vmiddle width-5">Mode</th>
                                                            <th class="text-center vmiddle width-5">Discount</th>
                                                            
                                                            <?php for($x=0; $x < count($mo); $x++ ):?>
                                                            <th class="text-center vmiddle width-5"><?= ucfirst($mo[$x])?></th>
                                                            <?php endfor;?>
                                                            <th class="text-center vmiddle width-10"> TOTAL</th>
                                                        </thead>
                                                    
                                                        <tbody>

                                                            <?php 
                                                            $student_list   = $this->module->get_query("SELECT * FROM v_student_fees WHERE sy_id = ".$sy." AND lvl_id = ".$r->lvl_id." ORDER BY stud_lastname ASC ");

                                                                foreach($student_list->result() as $k): 

                                                                    

                                                                    $njul          = 0;
                                                                    $naug          = 0;
                                                                    $nsep          = 0;
                                                                    $noct          = 0; 
                                                                    $nnov          = 0; 
                                                                    $ndec          = 0; 
                                                                    $njan          = 0; 
                                                                    $nfeb          = 0; 
                                                                    $nmar          = 0; 

                                                                    $nQ2           = 0; 
                                                                    $nQ3           = 0; 
                                                                    $nQ4           = 0; 

                                                                    $nS2           = 0;

                                                                    $total_monthly   = 0;
                                                                    $total_quarterly = 0;
                                                                    $total_semestral = 0;

                                                                    $grand_total   = 0;
                                                                    $fee_tf        = 0;


                                                                    $kstud_id               = $k->stud_id;
                                                                    $sa_is_scholar          = $k->sa_is_scholar;
                                                                    $sad_has_sib_discount   = $k->sad_has_sib_discount;
                                                                    $mode                   = substr($k->se_mode_payment,0,1);
                                                                    $dept_id                = $k->dept_id;
                                                                    $dept_name              = $k->dept_name;

                                                                    $fee_type               = '';


                                                                   

                                                                    foreach ($active_tf->result() as $a) {
                                                                        $adept_id    = $a->dept_id;
                                                                        $fee_type    = substr($a->fee_type,0,1);

                                                                        if( ($adept_id == $dept_id) && ($fee_type == $mode) ){
                                                                            
                                                                            $fee_tf      = $a->fee_tf;

                                                                            if($fee_type == 'M'){
                                                                                $mf     = $mo_mf;
                                                                            }else if($fee_type == 'Q'){
                                                                                $mf     = $qua_mf;
                                                                            }else if($fee_type == 'S'){
                                                                                $mf     = $sem_mf;
                                                                            }else if($fee_type == 'C'){
                                                                                $mf      = 0;
                                                                            }

                                                                        }
                                                                    }

                                                                    /*COMPUTATION MONTHLY*/
                                                                    $ten_percent  = ($fee_tf * 0.10);
                                                                    
                                                                    if($sa_is_scholar == 'N'){
                                                                        if($dept_name <> 'Pre-School'){
                                                                            if($sad_has_sib_discount == 'N'){
                                                                                $base_tf = $fee_tf + $mf;
                                                                            }else{
                                                                                $base_tf = ($fee_tf - $ten_percent) + $mf;
                                                                            }
                                                                        }else{
                                                                            if($sad_has_sib_discount == 'N'){
                                                                                $base_tf = $fee_tf;
                                                                            }else{
                                                                                $base_tf = ($fee_tf - $ten_percent);
                                                                            }
                                                                        }
                                                                    }else{
                                                                        //if not preschool and scholar
                                                                        $base_tf = 0;
                                                                    }

                                                                    $jul           = 0;
                                                                    $aug           = 0;
                                                                    $sep           = 0;
                                                                    $oct           = 0;
                                                                    $nov           = 0;
                                                                    $dec           = 0;
                                                                    $jan           = 0;
                                                                    $feb           = 0;
                                                                    $mar           = 0;
                                                                    $Q2            = 0;
                                                                    $Q3            = 0;
                                                                    $Q4            = 0;
                                                                    $S2            = 0;



                                                                    if($payment_data->num_rows() <= 0){
                                                                        $jul           = 0;
                                                                        $aug           = 0;
                                                                        $sep           = 0;
                                                                        $oct           = 0;
                                                                        $nov           = 0;
                                                                        $dec           = 0;
                                                                        $jan           = 0;
                                                                        $feb           = 0;
                                                                        $mar           = 0;
                                                                        $Q2            = 0;
                                                                        $Q3            = 0;
                                                                        $Q4            = 0;
                                                                        $S2            = 0;

                                                                    }else{
                                                                        foreach($payment_data->result() as $p){
                                                                            $pstud_id = $p->stud_id;

                                                                            if($pstud_id == $kstud_id){


                                                                                $months     = $p->tf_months; 
                                                                                $tf_amount  = $p->tf;

                                                                                switch ($months) {
                                                                                    case 'July':
                                                                                        $jul    =  empty($tf_amount) ? 0 : $tf_amount;
                                                                                        break;

                                                                                    case 'August':
                                                                                        $aug    =  empty($tf_amount) ? 0 : $tf_amount;
                                                                                        break;

                                                                                    case 'September':
                                                                                        $sep    =  empty($tf_amount) ? 0 : $tf_amount;
                                                                                        break;

                                                                                    case 'October':
                                                                                        $oct    =  empty($tf_amount) ? 0 : $tf_amount;
                                                                                        break;

                                                                                    case 'November':
                                                                                        $nov    =  empty($tf_amount) ? 0 : $tf_amount;
                                                                                        break;

                                                                                    case 'December':
                                                                                        $dec    =  empty($tf_amount) ? 0 : $tf_amount;
                                                                                        break;

                                                                                    case 'January':
                                                                                        $jan    =  empty($tf_amount) ? 0 : $tf_amount;
                                                                                        break;

                                                                                    case 'February':
                                                                                        $feb    =  empty($tf_amount) ? 0 : $tf_amount;
                                                                                        break;

                                                                                    case 'March':
                                                                                        $mar    =  empty($tf_amount) ? 0 : $tf_amount;
                                                                                        break;


                                                                                    case '2nd Quarter [August]':
                                                                                        $Q2     =  empty($tf_amount) ? 0 : $tf_amount;
                                                                                        $aug    =  empty($tf_amount) ? 0 : $tf_amount;
                                                                                        break;


                                                                                    case '3rd Quarter [October]':
                                                                                        $Q3     =  empty($tf_amount) ? 0 : $tf_amount;
                                                                                        $oct    =  empty($tf_amount) ? 0 : $tf_amount;
                                                                                        break;


                                                                                    case '4th Quarter [January]':
                                                                                        $Q4     =  empty($tf_amount) ? 0 : $tf_amount;
                                                                                        $jan    =  empty($tf_amount) ? 0 : $tf_amount;
                                                                                        break;

                                                                                    case '2nd Semester [October]':
                                                                                        $S2     =  empty($tf_amount) ? 0 : $tf_amount;
                                                                                        $oct    =  empty($tf_amount) ? 0 : $tf_amount;
                                                                                        break;
                                                                                    
                                                                                    default:
                                                                                        $jul = 0;
                                                                                        $aug = 0;
                                                                                        $sep = 0;
                                                                                        $oct = 0;
                                                                                        $nov = 0;
                                                                                        $dec = 0;
                                                                                        $jan = 0;
                                                                                        $feb = 0;
                                                                                        $mar = 0;
                                                                                        break;



                                                                                }



                                                                                
                                                                                $njul = $base_tf >= $jul ? $base_tf - $jul : 0; 
                                                                                $naug = $base_tf >= $aug ? $base_tf - $aug : 0; 
                                                                                $nsep = $base_tf >= $sep ? $base_tf - $sep : 0;  
                                                                                $noct = $base_tf >= $oct ? $base_tf - $oct : 0; 
                                                                                $nnov = $base_tf >= $nov ? $base_tf - $nov : 0;  
                                                                                $ndec = $base_tf >= $dec ? $base_tf - $dec : 0;  
                                                                                $njan = $base_tf >= $jan ? $base_tf - $jan : 0; 
                                                                                $nfeb = $base_tf >= $feb ? $base_tf - $feb : 0; 
                                                                                $nmar = $base_tf >= $mar ? $base_tf - $mar : 0; 

                                                                                $nQ2  = $base_tf >= $Q2 ? $base_tf - $Q2 : 0; 
                                                                                $nQ3  = $base_tf >= $Q3 ? $base_tf - $Q3 : 0; 
                                                                                $nQ4  = $base_tf >= $Q4 ? $base_tf - $Q4 : 0; 
                                                                                $nS2  = $base_tf >= $S2 ? $base_tf - $S2 : 0; 

                                                                                //echo $p->stud_id .' : '.$base_tf.' - '.$jul.'<br/>';
                                                                            }


                                                                            
                                                                        }

                                                                        //echo $njul.'<br/>';

                                                                                $tjul += $njul;
                                                                                $taug += $naug;    
                                                                                $tsep += $nsep;
                                                                                $toct += $noct;
                                                                                $tnov += $nnov;
                                                                                $tdec += $ndec;
                                                                                $tjan += $njan;
                                                                                $tfeb += $nfeb;
                                                                                $tmar += $nmar;


                                                                        
                                                                    }
                                                            
                                                                        $total_monthly      =  $njul + $naug + $nsep + $noct + $nnov + $ndec + $njan + $nfeb ;
                                                                        $total_quarterly    =  $nQ2 + $nQ3 + $nQ4;
                                                                        $total_semestral    =  $nS2; 


                                                                    ?>
                                                                <tr>
                                                                    <td class="text-center width-5"><?= $cnt++; ?></td>
                                                                    <td >
                                                                        <?php 
                                                                            
                                                                            $suffix     = $k->stud_suffix;
                                                                            $middlename = $k->stud_middlename;


                                                                            if(empty($suffix)){
                                                                                if(empty($middlename)){
                                                                                        $fullname = $k->stud_lastname.', '.$k->stud_firstname;
                                                                                    }else{
                                                                                        $fullname = $k->stud_lastname.', '.$k->stud_firstname.' '. substr($k->stud_middlename,0,1).'.';
                                                                                    }
                                                                                echo ucwords($fullname);
                                                                            }else{
                                                                                if(empty($middlename)){
                                                                                    $fullname = $k->stud_lastname.', '.$k->stud_firstname.' '.$k->stud_suffix;
                                                                                }else{
                                                                                    $fullname = $k->stud_lastname.', '.$k->stud_firstname.' '.$k->stud_suffix .' '. substr($k->stud_middlename,0,1).'.';
                                                                                }

                                                                                echo ucwords($fullname);
                                                                            }
                                                                        ?>
                                                                    </td>

                                                                    <td><?= $k->sec_name ?></td>
                                                                    <td class="text-center "><?= $mode ?></td>
                                                                    <td class="text-center "><?=$sad_has_sib_discount?></td>

                                                                   

                                                                    <?php if($mode == 'M'):?>
                                                                        <td class="text-right"><?=number_format($njul, 2)?></td> 
                                                                        <td class="text-right"><?=number_format($naug, 2)?></td>
                                                                        <td class="text-right"><?=number_format($nsep, 2)?></td>
                                                                        <td class="text-right"><?=number_format($noct, 2)?></td>
                                                                        <td class="text-right"><?=number_format($nnov, 2)?></td>
                                                                        <td class="text-right"><?=number_format($ndec, 2)?></td>
                                                                        <td class="text-right"><?=number_format($njan, 2)?></td> 
                                                                        <td class="text-right"><?=number_format($nfeb, 2)?></td>
                                                                        <td class="text-right"><?= $sa_is_scholar == 'N' ? '======' :  number_format($nmar, 2)?></td>
                                                                        <td class="text-right bold"><?=number_format( $total_monthly, 2)?></td>
                                                                    <?php endif;?>

                                                                    <?php if($mode == 'Q'):?>
                                                                        <td class="text-right">======</td> 
                                                                        <td class="text-right"><?=number_format($nQ2, 2)?></td> <!-- august -->
                                                                        <td class="text-right">======</td>
                                                                        <td class="text-right"><?=number_format($nQ3, 2)?></td> <!-- october -->
                                                                        <td class="text-right">======</td>
                                                                        <td class="text-right">======</td>
                                                                        <td class="text-right"><?=number_format($nQ4, 2)?></td> <!-- january --> 
                                                                        <td class="text-right">======</td>
                                                                        <td class="text-right">======</td>
                                                                        <td class="text-right bold"><?=number_format( $total_quarterly , 2)?></td>
                                                                    <?php endif;?>

                                                                    <?php if($mode == 'S'):?>
                                                                        <td class="text-right">======</td>
                                                                        <td class="text-right">======</td>
                                                                        <td class="text-right">======</td>
                                                                        <td class="text-right"><?=number_format($nS2, 2)?></td> <!-- october -->
                                                                        <td class="text-right">======</td>
                                                                        <td class="text-right">======</td>
                                                                        <td class="text-right">======</td>
                                                                        <td class="text-right">======</td>
                                                                        <td class="text-right">======</td>
                                                                        <td class="text-right bold"><?=number_format( $total_semestral, 2)?></td>
                                                                    <?php endif;?>

                                                                    <?php if($mode == 'C'):?>
                                                                        <td class="text-right">======</td>
                                                                        <td class="text-right">======</td>
                                                                        <td class="text-right">======</td>
                                                                        <td class="text-right">======</td>
                                                                        <td class="text-right">======</td>
                                                                        <td class="text-right">======</td>
                                                                        <td class="text-right">======</td>
                                                                        <td class="text-right">======</td>
                                                                        <td class="text-right">======</td>
                                                                        <td class="text-right bold"><?=number_format(0,2)?></td>
                                                                    <?php endif;?>

                                                                </tr>

                                                            <?php endforeach; ?>

                                                        </tbody>
                                                        <tfoot>
                                                            <tr>
                                                                <td colspan="5" class="text-right bold">Total</td>
                                                                <td class="text-right bold"><?=number_format($tjul,2)?></td>
                                                                <td class="text-right bold"><?=number_format($taug,2)?></td>
                                                                <td class="text-right bold"><?=number_format($tsep,2)?></td>
                                                                <td class="text-right bold"><?=number_format($toct,2)?></td>
                                                                <td class="text-right bold"><?=number_format($tnov,2)?></td>
                                                                <td class="text-right bold"><?=number_format($tdec,2)?></td>
                                                                <td class="text-right bold"><?=number_format($tjan,2)?></td>
                                                                <td class="text-right bold"><?=number_format($tfeb,2)?></td>
                                                                <td class="text-right bold"><?=number_format($tmar,2)?></td>
                                                                <td class="text-right bold"><?=number_format($grand_total,2)?></td>
                                                            </tr>
                                                        </tfoot>
                                                    </table>
                                                </div>
                                            </div>
                                    </div>

                                    <?php endforeach;?>
                                </div>
                            </div>
                        </div>

    
                    </div>
                </div>
            </div>
        </div>
        
    </div><!---END MAIN CONTENT -->

    
    
</div> <!-- end of body container -->

<?= $this->load->view('inc/js')?>
<script type="text/javascript" charset="utf-8">
  $(document).ready(function() {
     
       
  });
</script>
</body>
</html>