<?php 
  
  $usr_name     = $this->session->userdata('usr_name');
  $usr_type     = $this->session->userdata('usr_type');
  $usr_firstname  = $this->session->userdata('usr_firstname');
  $usr_lastname   = $this->session->userdata('usr_lastname');
  $usr_is_login   = $this->session->userdata('usr_is_login');


  if(!$usr_is_login && ($usr_type <> 'Admin' || $usr_type <> 'System Admin' )  ){
    header('Location: '.base_url());
  }

?>


<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <title><?= $title;?></title>

    <?= $this->load->view('inc/css')?>

</head>
<body class="page-body" id="my-body">

<div class="page-container"><!-- add class "sidebar-collapsed" to close sidebar by default, "chat-visible" to make chat appear always -->
    
    <div class="sidebar-menu">

        <div class="sidebar-menu-inner">
            <?= $this->load->view('inc/sidebar')?>
        </div>

    </div>

    <div class="main-content"> <!---START MAIN CONTENT -->
         <h1><?=$title?></h1>
        <hr/>

        <div class="row">
          <div class="col-md-12">
              <div class="panel panel-primary panel-table">
                <div class="panel-heading">
                  
                </div>
                <div class="panel-body">  

                <form method="post" id="frmSubmit" action="<?=base_url()?>admin/create_payment">
                  
                    <div class="form-group">
                        <table class="table table-bordered table-responsive table-condensed">
                          <thead>
                            <tr>
                              <th></th>
                              <th colspan="7">
                                <label class=" control-label text-info bold">Choose Learner's Name</label>
                                <select class="form-control select2 stud_id has-success select_stud_id" name="stud_id" >
                                      <option  selected="">SELECT STUDENT</option>
                                    <?php  $grade_level = $this->module->get_table('grade_level');

                                        foreach ($grade_level->result() as $k): ?>
                                          <optgroup label="<?=$k->lvl_name?>">
                                            
                                            <?php 
                                                /*AND sy_id = ".$sy_id."*/
                                                $payment = $this->module->get_query("SELECT * FROM v_student_assessment WHERE as_mode <> 'Cash'  AND lvl_id = ".$k->lvl_id."  ORDER BY fullname");
                                                foreach($payment->result() as $r): ?>
                                              <option value="<?=$r->as_id?>" ><?=strtoupper($r->shortname)?></option>
                                            <?php endforeach; ?>

                                          </optgroup>
                                    <?php  endforeach; ?>  
                                </select>
                                <br/>
                              </th>
                              <th></th>
                            </tr>
                            <tr>
                              <th colspan="10"><br/><h5 class="bold">LEARNERS' ACCOUNT DETAILS</h5></th>
                            </tr>
                            <tr>
                              <th></th>
                              <th class="bold">Month</th>
                              <th class="">Date</th>
                              <th class="bold text-center">Percentage(%)</th>
                              <th class="bold text-right">Fine</th>
                              <th class="text-right bold">Amount to Pay</th>
                              <th class="text-right bold">Partial Payment</th>
                              <th class="text-right bold">Payment</th>
                              <th></th>
                            </tr>
                          </thead>
                          
                          <tbody id="tbl_create_payment">
                            <tr>
                              <td>1</td>
                              <td>
                              
                                 <input type="text" name="inst_det_month" class="form-control month input-sm" required="" readonly="">
                              </td>

                               <td class="width-15">
                                <input type="text" name="inst_det_date" class="form-control date datepicker" data-format="yyyy-mm-dd" value="<?=date('Y-m-d')?>">
                              </td>

                              <td>
                                <select name="inst_det_percentage" class="form-control percentage">
                                   <option value="0">0%</option>
                                    <?php for ($x = 3; $x <= 30; $x+=3) : ?>
                                      <option value="<?= $x ?>"><?= $x?>% </option>
                                    <?php endfor; ?>
                                </select>
                              </td>

                             

                              <td class="text-right">
                                <input type="text" name="inst_det_fine" class="fine form-control text-right" value="0.00">
                              </td>

                              <td class="text-right vmiddle">
                                <input type="text" class="form-control to_pay text-danger text-right"  value="0.00">
                              </td>

                              <td class="text-right vmiddle">
                                <input type="text" class="form-control partial text-danger text-right"  value="0.00">
                              </td>

                              <td class="text-right" style="width:30%">
                                <input type="text" name="inst_det_amount" class="form-control amount text-right" value="0.00">
                              </td>
                              <td><button class="btn btn-info check" type="button"> <i class="fa fa-download"></i></button></td>

                              

                            </tr>

                           
                          </tbody>
                          
                        </table>

                        <div class="msg"></div>

                    </div>
                  </form>
                </div>
              </div>
          </div>

        </div>


         
    </div><!---END MAIN CONTENT -->
    
</div> <!-- end of body container -->

<?= $this->load->view('inc/js')?>

<script type="text/javascript" charset="utf-8">
  $(document).ready(function() {

      $(document.body).on('change','.stud_id',function(){
        var as_id   = $(this).val();

        $('#tbl_create_payment').load(base_url + 'admin/get_soa/'+as_id);

        $('.datepicker').datepicker();

        accounting.format($('.amount'),2);

      });

      $(document.body).on('change','.percentage',function(){
            var base    = $(this);
            var tr      = base.closest('tr');
            var amount  = tr.find('.payment').val();  
            var percent = tr.find('.percentage').val(); 

            var total   = parseFloat(amount) * (parseFloat(percent)/100);
            var fine    = tr.find('.fine').val(accounting.format(total,2));

            var total_amount = parseFloat(amount) + parseFloat(total);
            tr.find('.amount').val(accounting.format(total_amount,2));

            console.log(total_amount);

      });

      $(document.body).on('blur','.amount, .partial',function(){
        $(this).val(accounting.format($(this).val(),2));
      });

      //$('#frmSubmit').crud();

      $(document.body).on('click','.check',function(e){
        e.preventDefault();

          var base    = $(this);
          var tr      = base.closest('tr');
          var payment = tr.find('.to_pay').val();
          var parse   = parseFloat(payment.replace(/,/g, ''));
          var amount_to_pay = Math.abs(parse);

          tr.find('.amount').val(accounting.format(amount_to_pay,2));

      });


      $('#frmSubmit').submit(function(e){

        e.preventDefault(); 

        var base  = $(this);
        var msg   = base.find(".msg");
        var btn   = base.find("button");
        var tr    = base.closest('tr');

          $.ajax({
          type:base.attr("method"),//get/post
          data:base.serialize(),
          url:base.attr("action"),//location for the url
          beforeSend:function(){
            msg.empty().html(alert_minimal('Processing . . .'));
            btn.prop("disabled",true);
          },
          success:function(rrdata){

            btn.prop("disabled",false);

            var rdata = $.parseJSON(rrdata);
            if(rdata.stat){
              msg.empty().html(alert_success(rdata.msg)).show();

              $('#tbl_create_payment').load(base_url + 'admin/get_soa/'+rdata.id);

              //tr.find('.stat').empty();
              //$('.tbl_account_details').load(base_url+'admin/update_account_details/'+rdata.id);

            }
            else{
              msg.empty().html(alert_error(rdata.msg));
            }

            
            
          },
          error:function(rdata){
            btn.prop("disabled",false);
            msg.empty().html(alert_error('An error occured, please try again later'));
          }
        });
      });

    $(document.body).on('click','.edit',function(e){
          var base    = $(this);
          var tr      = base.closest('tr');
          var text    = $(e.target).text();

          if( text == 'EDIT' ){
              tr.find('.date, .fine, .amount, .percentage, .partial').prop('readonly', false);
              //tr.find('.percentage').prop('disabled', false);
              base.html('OK');
          }else{
              tr.find('.date, .fine, .amount, .percentage, .partial').prop('readonly', true);
              //tr.find('.percentage').prop('disabled', true);
              base.html('EDIT');
          }

           e.preventDefault();
         

      });
       
  });



</script>
</body>
</html>