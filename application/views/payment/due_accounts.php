<?php 
  
  $usr_name     = $this->session->userdata('usr_name');
  $usr_type     = $this->session->userdata('usr_type');
  $usr_firstname  = $this->session->userdata('usr_firstname');
  $usr_lastname   = $this->session->userdata('usr_lastname');
  $usr_is_login   = $this->session->userdata('usr_is_login');


  if(!$usr_is_login && ($usr_type <> 'Admin' || $usr_type <> 'System Admin' )  ){
    header('Location: '.base_url());
  }

?>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <title><?= $title;?></title>

    <?= $this->load->view('inc/css')?>

</head>
<body class="page-body gray" id="my-body">

<div class="page-container"><!-- add class "sidebar-collapsed" to close sidebar by default, "chat-visible" to make chat appear always -->
    
    <div class="sidebar-menu">

        <div class="sidebar-menu-inner">
            <?= $this->load->view('inc/sidebar')?>
        </div>

    </div>

    <div class="main-content"> <!---START MAIN CONTENT -->
      <h1><?=$title?></h1>
        <hr/> 

        <div class="row">
          <div class="col-md-12">
              <div class="panel panel-primary panel-table">
                
                <div class="panel-body">  
                   <ul class="nav nav-tabs "><!-- available classes "bordered", "right-aligned" -->
                    
                    <li class="active">
                      <a href="#summary" data-toggle="tab"> SUMMARY</a>
                    </li>

                    <li>
                      <a href="#all" data-toggle="tab"> ALL</a>
                    </li>

                    <li>
                      <a href="#july" data-toggle="tab"> JULY</a>
                    </li>
                    <li>
                      <a href="#august" data-toggle="tab">AUGUST</a>
                    </li>
                    <li>
                      <a href="#september" data-toggle="tab">SEPTEMBER</a>
                    </li>
                    <li>
                      <a href="#october" data-toggle="tab">OCTOBER</a>
                    </li>
                    <li>
                      <a href="#november" data-toggle="tab">NOVEMBER</a>
                    </li>
                    <li>
                      <a href="#december" data-toggle="tab">DECEMBER</a>
                    </li>
                    <li>
                      <a href="#january" data-toggle="tab">JANUARY</a>
                    </li>
                    <li>
                      <a href="#february" data-toggle="tab">FEBRUARY</a>
                    </li>
                    
                  </ul>

                  <div class="tab-content">

                      <div class="tab-pane active"  id="summary"> 

                        <?php $months = array('july','august','september','october','november','december','january','february');?>

                        <table class="table table-bordered datatable table-striped table-hover table-condensed">
                          <thead>
                            <th class="text-center width-5">No</th>
                            <th class="width-15">Student Name</th>
                            <?php foreach($months as $v): ?>
                            
                            <th class="text-center">
                              <?php 
                                  echo '<strong>'.strtoupper($v).'</strong><br/>';
                              foreach ($per_month->result() as $p){
                                   $month = $p->inst_det_month;

                                  if($month == $v){
                                    echo '<h5 class="m-0 bold">'.number_format($p->amount,2).'</h5>';
                                  }
                                }

                              ?>
                                
                            </th>
                            <?php endforeach; ?>
                            <th class="text-center">TOTAL<br/>RECEIVABLE</th>
                          </thead>
                          <tbody>

                          <?php 
                            $cnt                = 1;
                            $total_receivables  = 0; 
                            
                            foreach ($student->result() as $k):
                              $stud_id      = $k->stud_id;
                              $stud_amount  = $k->amount;

                          ?>
                              
                            <tr class="me">
                              <td><?=$cnt++?></td>
                              <td><h5 class="m-0"><strong><?=$k->stud_lastname.'</strong>, '.$k->stud_firstname?></h5></td>

                              <?php 

                                foreach($months as $v):

                              ?>

                              <td class="text-right width-10">
                              <?php 
                                  
                                  foreach ($due_account->result() as $d){
                                    $sstud_id         = $d->stud_id;
                                    $inst_det_month   = $d->inst_det_month;
                                    $inst_det_amount  = $d->inst_det_amount - $d->inst_det_partial;

                                    $inst_det_partial = $d->inst_det_partial;


                                    if( $inst_det_month == $v && $stud_id == $sstud_id){
                                      if($inst_det_partial > 0){
                                        echo '<small class="text-danger">(-'.number_format($inst_det_partial) .')</small> ';
                                      }
                                      echo number_format($inst_det_amount ,2);
                                      $total_receivables += $inst_det_amount;
                                      
                                    }

                                  }

                                ?>
                              </td>

                              <?php endforeach; ?>
                              <td class="text-right text-danger"><?=number_format($stud_amount,2)?></td>
                            </tr>
                          <?php endforeach; ?>
                          </tbody>
                        </table>

                        <div class="row">
                          <div class="col-md-12 text-right">
                            <h2 class="m-0 text-danger"><small>Total Receivable</small> <br/>
                              <strong><?=number_format($total_receivables,2)?></strong>
                            </h2>
                          </div>
                          <br/>
                        </div>

                      </div>
                      
                      <div class="tab-pane"  id="all"> 
                        <?php

                          $sy_id = $this->module->get_active_sy();

                          //$due_receivables = $this->module->get_query(" SELECT SUM(det.`inst_det_amount` - det.`inst_det_partial`) as sum FROM installment_hdr AS hdr, installment_details AS det, student AS stud WHERE hdr.`inst_id` = det.`inst_id` AND hdr.`stud_id` = stud.`stud_id` AND inst_det_payment <= 0 AND hdr.`sy_id` = ". $sy_id ." ")->row('sum');
                        ?>

                        <!-- <div class="row">
                          <div class="col-md-12 text-right">
                            <h3 class="m-0"><small>Total Receivables</small> <br/>
                              <strong><?=number_format($due_receivables,2)?></strong>
                            </h3>
                          </div>
                          <br/>
                        </div> -->

                        <table class="table table-border datatable table-hover table-condensed student">
                          <thead>
                            <th class="text-center width-5">No</th>
                            <th>Student Name</th>
                            <th class="text-right">Monthly Payment</th>
                            <th class="width-5"></th>
                          </thead>
                          <tbody>
                            <?php 
                              $cnt = 1;
                              $due = $this->module->get_query("SELECT CONCAT(stud.`stud_lastname`,', ' , stud.`stud_firstname`) as fullname, hdr.*, det.*, ass.`as_mode` FROM installment_hdr AS hdr, installment_details AS det, student AS stud, assessment AS ass WHERE hdr.`inst_id` = det.`inst_id` AND hdr.`stud_id` = stud.`stud_id` AND ass.`stud_id` = stud.`stud_id` AND hdr.`sy_id` = ". $sy_id ." GROUP BY fullname ");

                              foreach($due->result() as $r): ?>
                             <tr>
                               <td class="text-center"><?=$cnt++?></td>
                               <td><?= '<strong>'.$r->fullname.'</strong>'?></td>
                               <td class="text-right"><?=number_format($r->inst_det_amount,2)?></td>
                               <td class="text-center">
                                 <button class="btn btn-success  stud_id" data-id="<?=$r->as_id?>" data-name="<?= $r->fullname ?>"> <i class="fa fa-arrow-down"></i> </button>
                               </td>
                             </tr> 
                            <?php endforeach; ?>
                          </tbody>
                        </table>
                    </div>


                    <?php 

                      $month = array('july', 'august', 'september', 'october', 'november', 'december', 'january', 'february');
                      $month_active = strtolower(date('F'));

                      foreach($month as $v):

                      $due = $this->module->get_query("SELECT CONCAT(stud.`stud_lastname`,', ' , stud.`stud_firstname`) as fullname, hdr.*, det.* FROM installment_hdr AS hdr, installment_details AS det, student AS stud WHERE hdr.`inst_id` = det.`inst_id` AND hdr.`stud_id` = stud.`stud_id` AND inst_det_payment <= 0 AND det.`inst_det_month` = '".$v."' AND hdr.`sy_id` = ". $sy_id ." GROUP BY fullname ");

                      $due_receivables = $this->module->get_query(" SELECT SUM(det.`inst_det_amount`) as sum FROM installment_hdr AS hdr, installment_details AS det, student AS stud WHERE hdr.`inst_id` = det.`inst_id` AND hdr.`stud_id` = stud.`stud_id` AND inst_det_payment <= 0 AND det.`inst_det_month` = '".$v."' AND hdr.`sy_id` = ". $sy_id ." ")->row('sum');
                    ?>
                    <div class="tab-pane "  id="<?=$v?>"> 

                      <!-- <div class="row">
                          <div class="col-md-12 text-right">
                            <h3 class="m-0"><small>Total Receivables</small> <br/>
                              <strong><?=number_format($due_receivables,2)?></strong>
                            </h3>
                          </div>
                          <br/>
                        </div> -->

                      
                        <table class="table table-border datatable table-hover table-condensed student">
                          <thead>
                            <th class="text-center width-5">No</th>
                            <th>Student Name</th>
                            <th class="text-right">Monthly Payment</th>
                            <th class="width-5"></th>
                          </thead>
                          <tbody>
                            <?php 
                              $cnt = 1;
                              foreach($due->result() as $r): ?>
                             <tr>
                               <td class="text-center"><?=$cnt++?></td>
                               <td><?= '<strong>'.$r->fullname.'</strong> '?></td>
                               <td class="text-right"><?=number_format($r->inst_det_amount,2)?></td>
                               <td class="text-center">
                                 <button class="btn btn-success  stud_id" data-id="<?=$r->as_id?>" data-name="<?= $r->fullname ?>"> <i class="fa fa-arrow-down"></i> </button>
                               </td>
                             </tr> 
                            <?php endforeach; ?>
                          </tbody>
                        </table>
                    </div>

                    <?php endforeach; ?>

                  
                  </div>
                </div>
              </div>
          </div>

        </div>

        <div  class="row">
          <div class="col-md-12">
             <div class="panel panel-primary">
              <div class="panel-body">
                <h2 class="bold stud_name"></h2>
                <form method="post" id="frmSubmit" action="<?=base_url()?>admin/create_payment">
                  <input type="hidden" name="stud_id" class="stud_id form-control">
                  
                  <table class="table table-bordered" >
                      <thead>
                        <tr>
                          <th colspan="10"><br/><h5 class="bold">LEARNERS' ACCOUNT DETAILS</h5></th>
                        </tr>
                        <tr>
                          <th></th>
                          <th class="bold width-15">Month</th>
                          <th >Date</th>
                          <th class="bold text-center width-10 ">%<br/><small>Fine</small></th>
                          <th class="bold text-right width-15">Fine</th>
                          <th class="text-right bold width-15">Amount to Pay</th>
                          <th class="text-right bold width-15">Partial Payment</th>
                          <th class="text-right bold ">Payment</th>
                          <th></th>
                        </tr>
                      </thead>
                      <tbody id="tbl_create_payment">
                      </tbody>
                  </table>
                  <div class="msg"></div>
                </form>
              </div>
            </div>
          </div>
        </div>


         
    </div><!---END MAIN CONTENT -->
    
</div> <!-- end of body container -->

<?= $this->load->view('inc/js')?>

<script type="text/javascript" charset="utf-8">
  $(document).ready(function() {





      $(document.body).on('click','.stud_id',function(){
        var as_id   = $(this).attr('data-id');
        $('.stud_id').val(as_id);
        $('.stud_name').html($(this).attr('data-name'));
        $('#tbl_create_payment').load(base_url + 'admin/get_soa/'+as_id);
        $('.datepicker').datepicker();
        accounting.format($('.amount'),2);

        var tr = $(this).closest('tr');

        var selected = tr.hasClass("highlight");
        $('.student tr td').removeClass("highlight");

        if(!selected)
                tr.find('td').addClass("highlight");


      });

      $(document.body).on('change','.percentage',function(){
            var base    = $(this);
            var tr      = base.closest('tr');
            var amount  = tr.find('.payment').val();  
            var percent = tr.find('.percentage').val(); 

            var total   = parseFloat(amount) * (parseFloat(percent)/100);
            var fine    = tr.find('.fine').val(accounting.format(total,2));

            var total_amount = parseFloat(amount) + parseFloat(total);
            tr.find('.amount').val(accounting.format(total_amount,2));

            console.log(total_amount);

      });

      $(document.body).on('blur','.amount, .partial',function(){
        $(this).val(accounting.format($(this).val(),2));
      });

      //$('#frmSubmit').crud();

      $(document.body).on('click','.check',function(e){
        e.preventDefault();

          var base    = $(this);
          var tr      = base.closest('tr');
          var payment = tr.find('.to_pay').val();
          var parse   = parseFloat(payment.replace(/,/g, ''));
          var amount_to_pay = Math.abs(parse);

          tr.find('.amount').val(accounting.format(amount_to_pay,2));

      });


      $('#frmSubmit').submit(function(e){

        e.preventDefault(); 

        var base  = $(this);
        var msg   = base.find(".msg");
        var btn   = base.find("button");
        var tr    = base.closest('tr');

          $.ajax({
          type:base.attr("method"),//get/post
          data:base.serialize(),
          url:base.attr("action"),//location for the url
          beforeSend:function(){
            msg.empty().html(alert_minimal('Processing . . .'));
            btn.prop("disabled",true);
          },
          success:function(rrdata){

            btn.prop("disabled",false);

            var rdata = $.parseJSON(rrdata);
            if(rdata.stat){
              msg.empty().html(alert_success(rdata.msg)).show();

              $('#tbl_create_payment').load(base_url + 'admin/get_soa/'+rdata.id);
              //location.reload();

              //tr.find('.stat').empty();
              //$('.tbl_account_details').load(base_url+'admin/update_account_details/'+rdata.id);

            }
            else{
              msg.empty().html(alert_error(rdata.msg));
            }

            
            
          },
          error:function(rdata){
            btn.prop("disabled",false);
            msg.empty().html(alert_error('An error occured, please try again later'));
          }
        });
      });

    $(document.body).on('click','.edit',function(e){
          var base    = $(this);
          var tr      = base.closest('tr');
          var text    = $(e.target).text();

          if( text == 'EDIT' ){
              tr.find('.date, .fine, .amount').prop('readonly', false);
              tr.find('.percentage').prop('disabled', false);
              base.html('OK');
          }else{
              tr.find('.date, .fine, .amount').prop('readonly', true);
              tr.find('.percentage').prop('disabled', true);
              base.html('EDIT');
          }

           e.preventDefault();
         

      });
      
 
       
  });



</script>
</body>
</html>