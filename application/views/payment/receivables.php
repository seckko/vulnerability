<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <title><?= $title;?></title>

    <?= $this->load->view('inc/css')?>

</head>
<body class="page-body gray" id="my-body">

<div class="page-container"><!-- add class "sidebar-collapsed" to close sidebar by default, "chat-visible" to make chat appear always -->
    
    <div class="sidebar-menu">

        <div class="sidebar-menu-inner">
            <?= $this->load->view('inc/sidebar')?>
        </div>

    </div>

    <div class="main-content"> <!---START MAIN CONTENT -->
      <h1><?=$title?></h1>
        <hr/> 

        <div class="row">
          <div class="col-md-12">
              <div class="panel panel-primary panel-table">
                
                <div class="panel-body">  
                    <div class="row">
                      <div class="col-md-3">
                        <table class="table  table-primary table-hover datatable dataTable no-footer" id="student">
                          <thead>
                            <th></th>
                            <th>Student Name</th>
                            <th class="width-5"></th>
                          </thead>
                          <tbody>
                            <?php 
                              $cnt      = 1;
                              foreach($receivables->result() as $r):
                            ?>
                            <tr>
                              <td><?= $cnt++?></td>
                              <td>
                                <div class="row">
                                  <div class="col-md-8">
                                    <span class="bold"><?= $r->stud_lastname?></span><br/>
                                    <?= $r->stud_firstname.' '.$r->stud_suffix?>
                                  </div>
                                  <div class="col-md-4 text-right bold">
                                    P <?=number_format($r->inst_balance,2)?>
                                  </div>
                                </div>
                                
                                
                              </td>
                              <td><button class="btn btn-success  stud_id" data-id="<?=$r->as_id?>"> <i class="fa fa-arrow-right"></i> </button></td>
                            </tr>
                            <?php endforeach; ?>
                          </tbody>
                        </table>
                        <hr/>
                        <div class="col-md-12">
                            <div class="tile-stats tile-blue">
                              <div class="icon"><i class="fa fa-money"></i></div>
                              <div class="num"><?= number_format($total,2)?></div>
                              
                              <h3>Total Receivables</h3>
                            </div>
                        </div>
                        
                      </div>

                      <div class="col-md-9">

                        <form method="post" id="frmSubmit" action="<?=base_url()?>admin/create_payment">
                          <input type="hidden" name="stud_id" class="stud_id form-control">
                          <table class="table table-bordered" >
                              <thead>
                                <tr>
                                  <th colspan="10"><br/><h5 class="bold">LEARNERS' ACCOUNT DETAILS</h5></th>
                                </tr>
                                <tr>
                                  <th></th>
                                  <th class="bold">Month</th>
                                  <th class="">Date</th>
                                  <th class="bold text-center">Percentage(%)</th>
                                  <th class="bold text-right">Fine</th>
                                  <th class="text-right bold">Amount to Pay</th>
                                  <th class="text-right bold">Partial Payment</th>
                                  <th class="text-right bold">Payment</th>
                                  <th></th>
                                </tr>
                              </thead>
                              <tbody id="tbl_create_payment">
                              </tbody>
                          </table>
                          <div class="msg"></div>
                        </form>

                      </div>

                    </div>
                </div>
              </div>
          </div>

        </div>


         
    </div><!---END MAIN CONTENT -->
    
</div> <!-- end of body container -->

<?= $this->load->view('inc/js')?>

<script type="text/javascript" charset="utf-8">
  $(document).ready(function() {



      $(document.body).on('click','.stud_id',function(){
        var as_id   = $(this).attr('data-id');
        $('.stud_id').val(as_id);
        $('#tbl_create_payment').load(base_url + 'admin/get_soa/'+as_id);
        $('.datepicker').datepicker();
        accounting.format($('.amount'),2);

        var tr = $(this).closest('tr');

        var selected = tr.hasClass("highlight");
        $('#student tr td').removeClass("highlight");

        if(!selected)
                tr.find('td').addClass("highlight");


      });

      $(document.body).on('change','.percentage',function(){
            var base    = $(this);
            var tr      = base.closest('tr');
            var amount  = tr.find('.payment').val();  
            var percent = tr.find('.percentage').val(); 

            var total   = parseFloat(amount) * (parseFloat(percent)/100);
            var fine    = tr.find('.fine').val(accounting.format(total,2));

            var total_amount = parseFloat(amount) + parseFloat(total);
            tr.find('.amount').val(accounting.format(total_amount,2));

            console.log(total_amount);

      });

      $(document.body).on('blur','.amount, .partial',function(){
        $(this).val(accounting.format($(this).val(),2));
      });

      //$('#frmSubmit').crud();

      $(document.body).on('click','.check',function(e){
        e.preventDefault();

          var base    = $(this);
          var tr      = base.closest('tr');
          var payment = tr.find('.to_pay').val();
          var parse   = parseFloat(payment.replace(/,/g, ''));
          var amount_to_pay = Math.abs(parse);

          tr.find('.amount').val(accounting.format(amount_to_pay,2));

      });


      $('#frmSubmit').submit(function(e){

        e.preventDefault(); 

        var base  = $(this);
        var msg   = base.find(".msg");
        var btn   = base.find("button");
        var tr    = base.closest('tr');

          $.ajax({
          type:base.attr("method"),//get/post
          data:base.serialize(),
          url:base.attr("action"),//location for the url
          beforeSend:function(){
            msg.empty().html(alert_minimal('Processing . . .'));
            btn.prop("disabled",true);
          },
          success:function(rrdata){

            btn.prop("disabled",false);

            var rdata = $.parseJSON(rrdata);
            if(rdata.stat){
              msg.empty().html(alert_success(rdata.msg)).show();

              $('#tbl_create_payment').load(base_url + 'admin/get_soa/'+rdata.id);
              location.reload();

              //tr.find('.stat').empty();
              //$('.tbl_account_details').load(base_url+'admin/update_account_details/'+rdata.id);

            }
            else{
              msg.empty().html(alert_error(rdata.msg));
            }

            
            
          },
          error:function(rdata){
            btn.prop("disabled",false);
            msg.empty().html(alert_error('An error occured, please try again later'));
          }
        });
      });

    $(document.body).on('click','.edit',function(e){
          var base    = $(this);
          var tr      = base.closest('tr');
          var text    = $(e.target).text();

          if( text == 'EDIT' ){
              tr.find('.date, .fine, .amount').prop('readonly', false);
              tr.find('.percentage').prop('disabled', false);
              base.html('OK');
          }else{
              tr.find('.date, .fine, .amount').prop('readonly', true);
              tr.find('.percentage').prop('disabled', true);
              base.html('EDIT');
          }

           e.preventDefault();
         

      });
 
       
  });



</script>
</body>
</html>