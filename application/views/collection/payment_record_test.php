<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title><?= $title;?></title>
    <?= $this->load->view('inc/css')?>

</head>
<body class="page-body">

<div class="page-container"><!-- add class "sidebar-collapsed" to close sidebar by default, "chat-visible" to make chat appear always -->
    

    <div class="main-content">

		<?php 
		foreach($fees->result() as $r){


			$stud_id 		= $r->stud_id;
			$sib_discount 	= $r->sad_has_sib_discount;
			$dept_name 		= $r->dept_name;
			$sa_is_scholar  = $r->sa_is_scholar;

			$lvl_section 	= $r->lvl_name.'-'.$r->sec_name;
			$sec_id 		= $r->sec_id; 

			//FEE TABLE
			$fee_type 			= $r->fee_type;
			$fee_tf 			= $r->fee_tf;
			$fee_other_schl_fee = $r->fee_other_schl_fee;
			$enrollment_payment = $r->sad_sub_total;

			//SCHOLAR 
			$scholar_tf 		= $r->sad_scholar_tuition_fee;
			$scholar_misc 		= $r->sad_scholar_miscellaneous_fee;
			
			//INITIALIZATION
			$inst_amnt 			= 0;
			$misc				= 0;
			$discount 			= 0.10; // 10% of Tuition Fee
			$monthly_misc 		= 300;
			$quarterly_misc 	= 800;
			$semestral_misc 	= 2400;
			$out_balance 		= 0;
			$multiplier 		= 0;

			$tuition_fee 		= 0;
			$miscelleneous_fee  = 0;


			switch ($fee_type) {
				case 'MONTHLY':
					$misc 		= $monthly_misc;
					$multiplier = 8;
					break;
				case 'QUARTERLY':
					$misc 		= $quarterly_misc;
					$multiplier = 3;
					break;
				case 'SEMESTRAL':
					$misc 		= $semestral_misc;
					$multiplier = 1;
					break;
				
				default:
					$misc 		= 0;
					$multiplier = 0;
					break;
			}


			// CASH PAYMENT
			if($fee_type <> 'CASH'){

				// CHECK IF SCHOLAR
				if($sa_is_scholar == 'N'){

					// CHECK IF HAS SIBLING DISCOUNT
					if($sib_discount == 'N'){
						if($dept_name == 'Pre-School'){
							$inst_amnt = $fee_tf;

							$tuition_fee 		= $fee_tf;
							$miscelleneous_fee 	= 0;
						}else{
							$inst_amnt = ($fee_tf + $misc) ;

							$tuition_fee 		= $fee_tf;
							$miscelleneous_fee 	= $misc;
						}
					}else{

						if($dept_name == 'Pre-School'){
							$inst_amnt = ($fee_tf  - ($fee_tf * $discount));

							$tuition_fee 		= $inst_amnt;
							$miscelleneous_fee 	= 0;

						}else{
							$inst_amnt = $fee_tf - ($fee_tf * $discount) + $misc ;

							$tuition_fee 		= $fee_tf - ($fee_tf * $discount);
							$miscelleneous_fee 	= $misc;
						}
						
					}

					$out_balance 	= $inst_amnt * $multiplier;
				}else{

					// FOR SCHOLARS
					$inst_amnt 		= $r->sad_scholar_sub_total;
					$out_balance 	= $inst_amnt * 10;

					$tuition_fee 		= $scholar_tf;
					$miscelleneous_fee 	= $scholar_misc / 10;
				}
				

			}else{
				$inst_amnt 		= 0;
				$out_balance 	= 0;

				$tuition_fee 		= $scholar_tf;
				$miscelleneous_fee 	= $scholar_misc;
				
			}

			//$tf_payment  = $tf_payment->num_rows() < 1 ? 0 : $tf_payment->row('tf_paid');

			$unpaid 		= $this->module->get_query("SELECT ROUND(tf_sub_total,2) AS tf_paid, ROUND( (tf_amount_due - tf_sub_total ),2) AS balance FROM v_student_payment_record_tf WHERE sy_id = ".$sy_id." AND stud_id = ".$stud_id." ORDER BY tf_payment_date,spd_id ASC");
			$get_balance  	= $this->module->table_where('student_tf_balance', array('sy_id' => $sy_id, 'stud_id' => $stud_id) );
			$tf_paid  		= $this->module->get_query("SELECT SUM(tf_amount_due) as tf_amount_paid FROM  v_student_payment_record_tf WHERE  sy_id = ".$sy_id." AND stud_id = ".$stud_id." "); 

			//echo $this->db->last_query();
			//
			
			$ubalance = 0;

			if($unpaid->num_rows() > 0 ){
				foreach($unpaid->result() as $u){
					$rubalance = $u->balance;

					if($rubalance > 0){
						$ubalance += $rubalance;
					}
				}
			}

			
			
			
			$total_balance 	= $get_balance->num_rows() < 1 ? 0 : $get_balance->row('stb_balance') ;
			$total_paid 	= $tf_paid->num_rows() < 1 ? 0 : $tf_paid->row('tf_amount_paid');


			if($enrollment->num_rows() > 0){
				$upon_enrollment = $enrollment->row('sap_total_payment');
			}

			if($sa_is_scholar == 'Y'){
				$tf_balance = $total_balance - ($total_paid + $upon_enrollment);
			}else{
				$tf_balance   = $total_balance - $total_paid;
			}

			$tf_balance = $tf_balance +  $ubalance;

			
		}


		?>


		<div class="row">
			
			<div class="col-md-12">

				<div class="panel panel-primary panel-shadow" style="border-color: #1f4495">
					<div class="panel-heading" style="background-color: #1f4495; border-color: #1f4495">
						<h3 class="panel-title text-white"> Payment Form</h3>
					</div>

					<div class="panel-body">

						<form method="post" id="frmTuition" action="<?=base_url()?>collection/tuition_fee" class="form-horizontal form-groups-bordered">
							
							

							<input type="hidden" name="tf_stud_id" value="<?=$stud_id?>">
							<div class="row">
								


								<?php if($fees->num_rows() < 0 ): ?>
									<div class="col-md-12"><h4>No records found</h4></div>
								<?php else:?>
								
								<div class="col-md-9">
									
										<div class="col-md-2" >
											<small>Department</small><br/>
											<strong><?=$dept_name?></strong>
										</div>

										<div class="col-md-2">
											<small>Level & Section</small><br/>
											<strong><?=$lvl_section?></strong>
											<input type="hidden" name="sec_id" value="<?=$sec_id?>">
											<input type="hidden" name="sy_id" value="<?=$sy_id?>">
										</div>

										<div class="col-md-2">
											<small>Mode of Payment</small><br/>
											<strong><?= ucfirst(strtolower($fee_type))?></strong>
										</div>

										<div class="col-md-2">
											<small>Scholar</small><br/>
											<strong><?=$sa_is_scholar == 'N' ? 'No' : 'Yes' ?></strong>
										</div>

										<div class="col-md-2">
											<small>Sibling Discount</small><br/>
											<strong><?=$sib_discount == 'N' ? 'No' : 'Yes' ?></strong>
										</div>

										<div class="col-md-2">
											<small>Installment</small><br/>
											<strong><?= number_format($inst_amnt,2) ?></strong> 
											<input type="hidden" name="tf_tuition_fee" class="tf_tuition_fee" value="<?=$tuition_fee?>">
											<input type="hidden" name="tf_miscelleneous_fee" class="tf_miscelleneous_fee" value="<?=$miscelleneous_fee?>">

											<input type="hidden" id="tf_stud_id" value="<?=$stud_id?>">
										</div>

								</div>

								<div class="col-md-3 " style="border-left : 5px solid #eeeeee">
									Outstanding Balance<br/>
									<h3 class="m-0 bold html_tf_balance <?=($tf_balance > 0 ? 'text-danger' : 'text-success' )?> " ><?= number_format( $tf_balance,2) ?></h3>
									<!-- <input type="hidden" name="tf_balance" class="tf_balance" value="<?=$tf_balance?>"> -->
								</div>

								<?php endif;?>
							</div>
				
							<hr/>

						</form>
						
					</div>
					
				</div>
			</div>
		</div>





		<div class="row">
			<!-- <span>TF: <?=number_format($tuition_fee,2)?></span><br/>
			<span>MS: <?=number_format($miscelleneous_fee,2)?></span> -->

			<div class="col-md-12">
				<h4 class=" bold">PAYMENT RECORD <small>(TUITION FEE )</small></h4>
				<div class="tbl_payment_record">


					<table class="table table-condensed table-bordered table-striped datatable">
						<thead>
							<th class="width-5 bold text-center">No.</th>
							
							<th class="bold width-7 text-center">Date</th>
							<th class="bold width-10 text-center">Period</th>
							<th class="bold width-15 text-center">Type</th>
							<th class="bold text-center">Remarks</th>
							<th class="bold width-8 text-center">Due Amount</th>
							<th class="bold width-8 text-center">Fines</th>
							<th class="bold width-8 text-center">Amount Paid</th>
							<th class="bold width-8 text-center">Balance</th>
							<th class="bold width-8 text-center">Running Balance</th>
							
							
						</thead>
						<tbody >
							<?php 
								$sum_amount_due 	= $sum_amount_due;

								$total_amount_due 	= 0;
								$total_fines 		= 0;
								$total_amount_fines = 0;
								$total_amount_paid 	= 0; 
								$balance  			= 0;
								$total_abalance  	= 0;

								$e_tf_amount_due 	= 0;

							if($student_payment->num_rows() < 1 ): ?>
								
								<?php if($tf_balance > 0): ?>
								<tr><td colspan="11" class="text-center" ><h1 class="text-danger bold"> <i class="fa fa-times"></i> No payment</h1></td></tr>
								<?php else:?>
								<tr><td colspan="11" class="text-center" ><h1 class="text-success bold"> <i class="fa fa-check"></i>  Account already settled.</h1></td></tr>
								<?php endif;?>
							<?php else: ?>

								<!-- ENROLLMENT -->

								<?php if($enrollment->num_rows() > 0):

									//$cn = 1;

									foreach($enrollment->result() as $e): 

										$sap_total_payment 	= $e->sap_total_payment;
										$sap_other_fee 		= $e->sap_other_fee;
										$e_tf_amount_due 	= $sap_total_payment - $sap_other_fee;
								?>
									<tr>
										<td class="text-center">1</td>
										<td><?= date('m-d-Y',strtotime($e->sap_payment_date)) ?> </td>
										<td>Upon Enrollment</td>
										
										<td></td>
										<td> <?= $e->lvl_name.' - '.$e->sec_name?></td>
										<td class="text-right"><?=number_format($e_tf_amount_due,2)?></td>
										<td class="text-right"><?= '(0%) 0.00'?></td>
										<td class="text-right"><?=number_format($e_tf_amount_due,2)?></td>
										<td class="text-right"><?=number_format(0,2)?></td>
										
										<td class="text-right bold text-danger"><?=number_format($total_balance,2)?></td>
										
									</tr>
									<?php endforeach;?>
								<?php endif; ?>

								<?php 

								$cnt = 2; 
								$rbalance = 0;
								$due_balance = 0;
								$abalance = 0;

								$balance  			= $total_balance;
								$sum_tf_amount_due  = $sum_amount_due->num_rows() > 0 ? $sum_amount_due->row('sum_tf_amount_due') : 0;
								$amount_due_paid 	= $sum_amount_due->num_rows() > 0 ? $sum_amount_due->row('tf_amount_due') : 0;


								
								//$total_paid_db     = $get_total_paid_db->num_rows() > 0 ? $get_total_paid_db->row('tf_sub_total') : 0;

								
								foreach($student_payment->result() as $r):

									$tf_amount_due 	= $r->tf_amount_due;
									$tf_fine 		= $r->tf_fine_percentage;
									$tf_fine_amount = $r->tf_fine_amount;
									$tf_sub_total 	= $r->tf_sub_total;

									$tf_balance 	= $r->balance;
									$abalance 		= $tf_balance <= 0 ? 0 : $tf_balance;

									$total_abalance += $abalance;

									$total_amount_due 	+= $tf_amount_due;
									$total_fines 		+= $tf_fine;
									$total_amount_fines += $tf_fine_amount;
									$total_amount_paid 	+= $tf_sub_total;

									/*$balance 			= abs( ($total_balance - $sum_amount_due));
									$rbalance 			= $balance;
									$running_balance 	= abs($rbalance);*/

									$due_balance += $tf_sub_total;
									$rbalance 	 = ($balance - $tf_amount_due) + $abalance ;





									?>
									<tr>
										<td class="text-center"><?=$cnt++?></td>
										
										<td> <?=date('m-d-Y', strtotime($r->tf_payment_date))?></td>
										<td><?=$r->tf_months?></td>
										<td><?= $r->tf_payment_type == 'Cash' ? $r->tf_payment_type : $r->tf_payment_type . ' - ('.$r->tf_bank_name.' : '.$r->tf_account_number.')'?></td>
										<td><?=$r->tf_remarks?></td>
										<td class="text-right"><?=number_format($tf_amount_due,2)?></td>
										<td class="text-right"><?= '('.$tf_fine.'%) ' .number_format($tf_fine_amount,2)?></td>
										<td class="text-right"><?=number_format($tf_sub_total,2)?></td>
										<td class="text-right"><?= number_format($abalance,2)?> </td>
										
										<td class="text-right"><?= number_format($rbalance,2)?> </td>
										
									</tr>

									<!-- <?php 
										$sum_tf_amount_due 	= $amount_due_paid + $tf_amount_due;
										$balance 			= $rbalance;
									?> -->
										
								<?php endforeach;?>
							<?php endif; ?>


						</tbody>
						<tfoot>
							<tr>
								<td colspan="5" class="text-right bold">Total</td>
								<td class="text-right bold"><?=number_format($total_amount_due + $e_tf_amount_due,2)?></td>
								<td class="text-right bold"><?='('.$total_fines.'%) '.number_format($total_amount_fines,2)?></td>

								<td class="text-right bold"><?=number_format($total_amount_paid + $e_tf_amount_due,2)?></td>
								<td class="text-right bold"><?=number_format($total_abalance,2)?></td>
								<td ></td>
							</tr>
						</tfoot>
					</table>

					
					

					

				</div>
			</div>
		</div>

</div><!---END MAIN CONTENT -->

    
    
</div> <!-- end of body container -->

<?= $this->load->view('inc/js')?>
<script type="text/javascript" charset="utf-8">
  $(document).ready(function() {
     
       
  });
</script>
</body>
</html>



