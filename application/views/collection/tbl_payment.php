
<?php 
foreach($fees->result() as $r){

	$stud_name 	 	= $r->stud_lastname.', '.$r->stud_firstname;
	$stud_id 		= $r->stud_id;
	$sib_discount 	= $r->sad_has_sib_discount;
	$dept_name 		= $r->dept_name;
	$sa_is_scholar  = $r->sa_is_scholar;

	$lvl_section 	= $r->lvl_name.'-'.$r->sec_name;
	$sec_id 		= $r->sec_id; 

	//FEE TABLE
	$fee_type 			= $r->fee_type;
	$fee_tf 			= $r->fee_tf;
	$fee_other_schl_fee = $r->fee_other_schl_fee;
	$enrollment_payment = $r->sad_sub_total;

	//SCHOLAR 
	$scholar_tf 		= $r->sad_scholar_tuition_fee;
	$scholar_misc 		= $r->sad_scholar_miscellaneous_fee;
	
	//INITIALIZATION
	$inst_amnt 			= 0;
	$misc				= 0;
	$discount 			= 0.10; // 10% of Tuition Fee
	$monthly_misc 		= 300;
	$quarterly_misc 	= 800;
	$semestral_misc 	= 2400;
	$out_balance 		= 0;
	$multiplier 		= 0;

	$tuition_fee 		= 0;
	$miscelleneous_fee  = 0;


	switch ($fee_type) {
		case 'MONTHLY':
			$misc 		= $monthly_misc;
			$multiplier = 8;
			break;
		case 'QUARTERLY':
			$misc 		= $quarterly_misc;
			$multiplier = 3;
			break;
		case 'SEMESTRAL':
			$misc 		= $semestral_misc;
			$multiplier = 1;
			break;
		
		default:
			$misc 		= 0;
			$multiplier = 0;
			break;
	}


	// CASH PAYMENT
	if($fee_type <> 'CASH'){

		// CHECK IF SCHOLAR
		if($sa_is_scholar == 'N'){

			// CHECK IF HAS SIBLING DISCOUNT
			if($sib_discount == 'N'){
				if($dept_name == 'Pre-School'){
					$inst_amnt = $fee_tf;

					$tuition_fee 		= $fee_tf;
					$miscelleneous_fee 	= 0;
				}else{
					$inst_amnt = ($fee_tf + $misc) ;

					$tuition_fee 		= $fee_tf;
					$miscelleneous_fee 	= $misc;
				}
			}else{

				if($dept_name == 'Pre-School'){
					$inst_amnt = ($fee_tf  - ($fee_tf * $discount));

					$tuition_fee 		= $inst_amnt;
					$miscelleneous_fee 	= 0;

				}else{
					$inst_amnt = $fee_tf - ($fee_tf * $discount) + $misc ;

					$tuition_fee 		= $fee_tf - ($fee_tf * $discount);
					$miscelleneous_fee 	= $misc;
				}
				
			}

			$out_balance 	= $inst_amnt * $multiplier;
		}else{

			// FOR SCHOLARS
			$inst_amnt 		= $r->sad_scholar_sub_total;
			$out_balance 	= $inst_amnt * 10;

			$tuition_fee 		= $scholar_tf;
			$miscelleneous_fee 	= $scholar_misc / 10;
		}
		

	}else{
		$inst_amnt 		= 0;
		$out_balance 	= 0;

		$tuition_fee 		= $scholar_tf;
		$miscelleneous_fee 	= $scholar_misc;
		
	}

	//$tf_payment  = $tf_payment->num_rows() < 1 ? 0 : $tf_payment->row('tf_paid');

	$unpaid 		= $this->module->get_query("SELECT ROUND(tf_sub_total,2) AS tf_paid, ROUND( (tf_amount_due - tf_sub_total ),2) AS balance FROM v_student_payment_record_tf WHERE sy_id = ".$sy_id." AND stud_id = ".$stud_id." ORDER BY tf_payment_date,spd_id ASC");
	$get_balance  	= $this->module->table_where('student_tf_balance', array('sy_id' => $sy_id, 'stud_id' => $stud_id) );
	$tf_paid  		= $this->module->get_query("SELECT SUM(tf_amount_due) as tf_amount_paid FROM  v_student_payment_record_tf WHERE  sy_id = ".$sy_id." AND stud_id = ".$stud_id." "); 

	//echo $this->db->last_query();
	//
	
	$ubalance = 0;

	if($unpaid->num_rows() > 0 ){
		foreach($unpaid->result() as $u){
			$rubalance = $u->balance;

			if($rubalance > 0){
				$ubalance += $rubalance;
			}
		}
	}

	
	
	
	$total_balance 	= $get_balance->num_rows() < 1 ? 0 : $get_balance->row('stb_balance') ;
	$total_paid 	= $tf_paid->num_rows() < 1 ? 0 : $tf_paid->row('tf_amount_paid');


	if($enrollment->num_rows() > 0){
		$upon_enrollment = $enrollment->row('sap_total_payment');
	}

	if($sa_is_scholar == 'Y'){
		$tf_balance = $total_balance - ($total_paid + $upon_enrollment);
	}else{
		$tf_balance   = $total_balance - $total_paid;
	}

	$tf_balance = $tf_balance +  $ubalance;

	
}


?>


<div class="row">
	
	<div class="col-md-12">

		<div class="panel panel-primary panel-shadow" style="border-color: #1f4495">
			<div class="panel-heading" style="background-color: #1f4495; border-color: #1f4495">
				<h3 class="panel-title text-white"> Payment Form</h3>
			</div>

			<div class="panel-body">

				<form method="post" id="frmTuition" action="<?=base_url()?>collection/tuition_fee" class="form-horizontal form-groups-bordered">
					
					
					<input type="hidden" name="tf_stud_id" value="<?=$stud_id?>">
					<div class="row">



						<?php if($fees->num_rows() < 0 ): ?>
							<div class="col-md-12"><h4>No records found</h4></div>
						<?php else:?>
						
						<div class="col-md-9">
							
								<div class="col-md-2" >
									<small>Department</small><br/>
									<strong><?=$dept_name?></strong>
								</div>

								<div class="col-md-2">
									<small>Level & Section</small><br/>
									<strong><?=$lvl_section?></strong>
									<input type="hidden" name="sec_id" value="<?=$sec_id?>">
									<input type="hidden" name="sy_id" value="<?=$sy_id?>">
									<input type="hidden" name="stud_name" value="<?=$stud_name?>">
								</div>

								<div class="col-md-2">
									<small>Mode of Payment</small><br/>
									<strong><?= ucfirst(strtolower($fee_type))?></strong>
								</div>

								<div class="col-md-2">
									<small>Scholar</small><br/>
									<strong><?=$sa_is_scholar == 'N' ? 'No' : 'Yes' ?></strong>
								</div>

								<div class="col-md-2">
									<small>Sibling Discount</small><br/>
									<strong><?=$sib_discount == 'N' ? 'No' : 'Yes' ?></strong>
								</div>

								<div class="col-md-2">
									<small>Installment</small><br/>
									<strong><?= number_format($inst_amnt,2) ?></strong> 
									<input type="hidden" name="tf_tuition_fee" class="tf_tuition_fee" value="<?=$tuition_fee?>">
									<input type="hidden" name="tf_miscelleneous_fee" class="tf_miscelleneous_fee" value="<?=$miscelleneous_fee?>">

									<input type="hidden" id="tf_stud_id" value="<?=$stud_id?>">
									<input type="hidden" value="<?=$stud_name?>" class="stud_name">
								</div>

						</div>

						<div class="col-md-3 " style="border-left : 5px solid #eeeeee">
							Outstanding Balance<br/>
							<h3 class="m-0 bold html_tf_balance <?=($tf_balance > 0 ? 'text-danger' : 'text-success' )?> " ><?= number_format( $balance['total'],2) ?></h3>
							<!-- <input type="hidden" name="tf_balance" class="tf_balance" value="<?=$tf_balance?>"> -->
						</div>

						<?php endif;?>
					</div>
		
					<hr/>
					
					<h4 class="bold">TUITION FEE</h4>
					<table class="table table-condensed table-bordered table_past_due">
						<thead>
							<th>Period</th>
							<th class="text-center">Due Amount</th>
							<th class="text-center">Fine (%)</th>
							<th>Fine Amount</th>
							<th>Sub Total</th>
							<th>Remarks</th>
							<td></td>
						</thead>

						<tbody>

							<tr class="tbl_row_tf">
								<td>
									<!-- <input type="hidden" name="" class="form-control" value="<?=$stud_id?>"> -->
									<select name="tuition0[tf_months]" class="form-control tf_months">
										<?php 

											if($fee_type == 'MONTHLY'){
												$months = array('July', 'August', 'September', 'October', 'November', 'December', 'January', 'February', 'March', 'April', 'May', 'June');
											}else if($fee_type == 'QUARTERLY'){
												$months = array('2nd Quarter [August]', '3rd Quarter [October]', '4th Quarter [January]');
											}else if($fee_type == 'SEMESTRAL'){
												$months = array('2nd Semester [October]');
											}else{
												$months = array('CASH');
											}
										?>

										<?php 
										$x = 1;
										foreach($months as $m):?>
										<option value="<?=$m?>"><?= '['.$x++.'] '.$m?> </option>
										<?php endforeach;?>
									</select>
								</td>
								<td class="vmiddle text-center">
									<!-- <h5 class="m-0"><?= number_format($inst_amnt,2) ?></h5> -->
									<input type="text" class="form-control payment text-right tf_amount_due digit" placeholder="" name="tuition0[tf_amount_due]" value="<?=number_format($inst_amnt,2)?>">
								</td>
								<td>
									<select name="tuition0[tf_fine_percentage]" class="form-control tf_fine_percentage">
			                           <option value="0">0%</option>
			                            <?php for ($x = 3; $x <= 30; $x+=3) : ?>
			                              <option value="<?= $x ?>"><?= $x?>% </option>
			                            <?php endfor; ?>
			                        </select>
			                    </td>
								<td><input type="text" class="form-control text-right tf_fine_amount" readonly="" placeholder="" name="tuition0[tf_fine_amount]" value="0.00"></td>
								<td><input type="text" class="form-control tf_sub_total text-right" placeholder="" name="tuition0[tf_sub_total]" value="<?= number_format($inst_amnt,2) ?>"></td> <!-- number_format($inst_amnt,2) -->
								<td><input type="text" class="form-control tf_remarks" placeholder="" autocomplete="off" name="tuition0[tf_remarks]"></td>
								<td class="width-9">
									<div class="btn-group">
										<button class="btn btn-sm btn-success btn_add_tf btn-xs" type="button"><i class="fa fa-plus"></i></button>
	                                	<button class="btn btn-sm btn-danger btn_remove_tf  btn-xs" type="button" ><i class="fa fa-times"></i></button>
									</div>
									
								</td>
							</tr>
						</tbody>
						<tfoot>
							<tr>
								<td colspan="4" class="text-right bold"> Sub-total Amount</td>
								<td>
									<h4 class="m-0 sub_total_amnt bold text-right"><?= number_format($inst_amnt,2) ?></h4>
									<input type="hidden" name="tf_amount_paid" class="tf_amount_paid" value="<?=$inst_amnt?>">
								</td>
								<td colspan="2" class="due"> 
										<!-- <button class="btn btn-blue btn-xs print_table" type="button" >Print Table</button> -->
								</td>
							</tr>
						</tfoot>
					</table>

					<hr/>
					
					<h4 class="bold">Statement of Account</h4> 
					<table class="table-soa table-sm table-hover table-striped responsive m-0">
                      <thead>
                        <th class="width-1"></th>
                        <th class="bold width-20">Period</th>
                        <th class="text-right  bold width-10">Amount Due</th>
                        <th class="text-right bold width-10">Due Date</th>
                        <th class="text-right bold width-15">Percent(%)</th>
                        <th class="text-right bold width-15">Fines</th>
                        <th class="text-right bold width-15">Total Amount Due</th>
                        <th class="text-right bold width-10">Payment Date</th>
                      </thead>

                      <tbody>
                        <?php 
                          $total_amount_paid = 0;
                          $amount_due        = 0;
                          $total_due 		 = 0;


                         	$balance   		= $this->module->get_out_balance($stud_id, $sy_id);
							$payment_mode  	= $balance['payment_mode'];
					        $is_scholar     = $balance['is_scholar'];
				            $installment 	= $balance['student_tf'];
							$payment_record = $this->module->get_payment_record($sy_id, $stud_id);

						
                            foreach($payment_record as $p):
                                $amount_paid  = $p['tf_amount_paid'];
                                $period       = $p['dd_date_name']; 
                                $amount_due   = $p['tf_amount_due'];
                                $due_date     = $p['dd_date_due'];
                                $fines        = $p['tf_fine_amount'];
                                $payment_due  = $p['tf_total_amount_due'];
                                $payment_date = $p['tf_payment_date'];
                                $total_due    = array_sum($p['total_amount_due']); 
                                $is_unpaid    = $p['is_unpaid'];
                                $percent 	  = $p['tf_fine_percentage'];

                        ?>

                            <tr>
                              <td> <?=!empty($is_unpaid) ? '<i class="fa fa-times text-danger"></i>' : '' ?> </td>
                              <td class="<?=$is_unpaid?>"><?=$period?></td>
                              <td class="text-right  <?=$is_unpaid?>"><?=number_format($amount_due,2);?></td>
                              <td class="text-right <?=$is_unpaid?> "><?=date('m/d/y', strtotime($due_date))?></td>
                              <td class="text-right <?=$is_unpaid?>"><?=number_format($percent);?> %</td>
                              <td class="text-right <?=$is_unpaid?>"><?=number_format($fines,2);?></td>
                              <td class="text-right <?=$is_unpaid?>"><?=number_format($payment_due,2);?></td>
                              <td class="text-right <?=$is_unpaid?>"><?= (empty($payment_date) ? ' --' : date('m/d/y', strtotime($payment_date)) )?></td>
                            </tr>

                        <?php endforeach; ?>
                      </tbody>
                   	<tfoot>
                   		<tr>
                   			<td></td>
                   			<td colspan="5">Total Dues</td>
                   			<td class="text-right"><h4 class="m-0 bold <?=($total_due <> 0 ? 'text-danger': '' )?>"><?=number_format($total_due,2)?></h4></td>
                   		</tr>
                   	</tfoot>

                  </table>

					<h4 class="bold">OTHERS</h4>

					<table class="table table-condensed table-bordered table_past_due">
						<thead>
							<th>Type</th>
							<th>Quantity</th>
							<th class="text-center">Amount</th>							
							<td></td>
						</thead>

					</table>

					<hr/>

					<div class="row">
						<div class="col-md-10 col-sm-12 col-xs-12">
							<table class="table table-condensed table-bordered mb-0">
								<thead>
									<th>Payment Type</th>
									<th>Bank</th>
									<th>Check No.</th>
									<th colspan="2">Date</th>
								</thead>
								<tbody>
									<tr>
										<td class="text-center">
											<div class="row">
												<div class="col-md-4">
													<div class="radio">
														<label>
															<input type="radio" name="tf_payment_type" value="Cash" checked="">CASH
														</label>
													</div>
												</div>

												<div class="col-md-5 col-md-offset-1">
													<div class="radio">
														<label>
															<input type="radio" name="tf_payment_type" value="Check" >CHECK
														</label>
													</div>
												</div>
											</div>
										</td>
										<td>
											<input type="text" class="form-control" placeholder="" name="tf_bank_name"/>
										</td>
										<td>
											<input type="text" class="form-control text-right" autocomplete="off" placeholder="" name="tf_account_number"/>
										</td>
										<td>
											<input type="text" class="form-control text-right tf_payment_date" autocomplete="off" placeholder="" name="tf_payment_date" value="<?=date('Y-m-d')?>" /> <!-- date('Y-m-d') -->
										</td>
										<td>
											<button class="btn btn-success btn-block <?= ($tf_balance <= 0 ? 'disabled' : '') ?>  " type="submit" > <i class="fa fa-save"></i> Create Payment</button>

										</td>
									</tr>
								</tbody>
							</table>
						</div>

						

					</div>
	
				</form>
				
			</div>
			
		</div>
	</div>
</div>


<div class="row">


	<div class="col-md-12">
		
		
		

		<div class="row">
			<div class="col-md-4 ">
				<h4 class=" bold">PAYMENT RECORD <small>(TUITION FEE )</small></h4>
			</div>

			<div class="col-md-8 text-right">
				<?php 
		        $mo   = array( 'jul', 'aug', 'sep', 'oct', 'nov', 'dec', 'jan', 'feb', 'mar'); 
		        for($x=0; $x < count($mo); $x++ ):?>
					<span class="m-2 label <?=( $balance[$mo[$x]] <=0 ? 'label-default' : 'label-secondary')?>"><?= ucfirst($mo[$x]).'  <span class="bold">'.number_format($balance[$mo[$x]],2).'</span>'?> </span>
				<?php endfor;?>
			</div>
		</div>
		<div class="tbl_payment_record">
			<table class="table table-condensed table-bordered table-striped datatable">
				<thead>
					<th class="width-5 bold text-center">No.</th>
					
					<th class="bold  text-center">Date</th>
					<th class="bold  text-center">Period</th>
					<th class="bold  text-center">Type</th>
					<th class="bold text-center">Remarks</th>
					<th class="bold width-8 text-center">Due Amount</th>
					<th class="bold width-8 text-center">Fines</th>
					<th class="bold width-8 text-center">Amount Paid</th>
					<!-- <th class="bold width-8 text-center">Balance</th> -->
					<!-- <th class="bold width-8 text-center">Running Balance (<?=number_format($total_balance,2)?>)</th> -->
					<!-- <th class="bold">Running Balance</th> -->
					<th class="width-7"></th>
					
				</thead>
				<tbody >
					<?php 
						$sum_amount_due 	= $sum_amount_due;

						$total_amount_due 	= 0;
						$total_fines 		= 0;
						$total_amount_fines = 0;
						$total_amount_paid 	= 0; 
						$balance  			= 0;
						$total_abalance  	= 0;

						$e_tf_amount_due 	= 0;

					if($student_payment->num_rows() < 1 ): ?>
						
						<?php if($tf_balance > 0): ?>
						<tr><td colspan="10" class="text-center" ><h1 class="text-danger bold"> <i class="fa fa-warning"></i> Please settle your account.</h1></td></tr>
						<?php else:?>
						<tr><td colspan="10" class="text-center" ><h1 class="text-success bold"> <i class="fa fa-check"></i>  Account already settled.</h1></td></tr>
						<?php endif;?>
					<?php else: ?>

						

						<?php 

						$cnt = 2; 
						$rbalance = 0;
						$due_balance = 0;
						$abalance = 0;

						$balance  			= $total_balance;
						$sum_tf_amount_due  = $sum_amount_due->num_rows() > 0 ? $sum_amount_due->row('sum_tf_amount_due') : 0;
						$amount_due_paid 	= $sum_amount_due->num_rows() > 0 ? $sum_amount_due->row('tf_amount_due') : 0;


						
						
						foreach($student_payment->result() as $r):

							$tf_amount_due 	= $r->tf_amount_due;
							$tf_fine 		= $r->tf_fine_percentage;
							$tf_fine_amount = $r->tf_fine_amount;
							$tf_sub_total 	= $r->tf_sub_total;

							$tf_balance 	= $r->balance;
							$abalance 		= $tf_balance <= 0 ? 0 : $tf_balance;

							$total_abalance += $abalance;

							$total_amount_due 	+= $tf_amount_due;
							$total_fines 		+= $tf_fine;
							$total_amount_fines += $tf_fine_amount;
							$total_amount_paid 	+= $tf_sub_total;

							$due_balance += $tf_sub_total;
							$rbalance 	 = ($balance - $tf_amount_due) + $abalance ;

							?>
							<tr>
								<td class="text-center"><?=$cnt++?></td>
								
								<td> <?=date('m-d-Y', strtotime($r->tf_payment_date))?></td>
								<td><?=$r->tf_months?></td>
								<td><?= $r->tf_payment_type == 'Cash' ? $r->tf_payment_type : $r->tf_payment_type . ' - ('.$r->tf_bank_name.' : '.$r->tf_account_number.')'?></td>
								<td><?=$r->tf_remarks?></td>
								<td class="text-right"><?=number_format($tf_amount_due,2)?></td>
								<td class="text-right"><?= '('.$tf_fine.'%) ' .number_format($tf_fine_amount,2)?></td>
								<td class="text-right"><?=number_format($tf_sub_total,2)?></td>
								
								<td class="text-center"> 
									<button type="button" class="btn btn-info  btn-xs btn-edit" data-id="<?=$r->spd_id?>" data-fee_type= "<?=$fee_type?>" data-stud_id ="<?=$stud_id?>" ><i class="fa fa-pencil"></i></button>
									<button type="button" class="btn btn-danger  btn-xs btn-delete" data-id="<?=$r->spd_id?>" data-sp_id = "<?=$r->sp_id?>" ><i class="fa fa-times"></i></button> 
								</td>
							</tr>

						<?php endforeach;?>

						<!-- ENROLLMENT -->

						<?php if($enrollment->num_rows() > 0):
							foreach($enrollment->result() as $e): 

								$sap_total_payment 	= $e->sap_total_payment;
								$sap_other_fee 		= $e->sap_other_fee;
								$e_tf_amount_due 	= $sap_total_payment - $sap_other_fee;
						?>
							<tr>
								<td class="text-center">1</td>
								<td><?= date('m-d-Y',strtotime($e->sap_payment_date)) ?> </td>
								<td>Upon Enrollment</td>
								
								<td></td>
								<td> <?= $e->lvl_name.' - '.$e->sec_name?></td>
								<td class="text-right"><?=number_format($e_tf_amount_due,2)?></td>
								<td class="text-right"><?= '(0%) 0.00'?></td>
								<td class="text-right"><?=number_format($e_tf_amount_due,2)?></td>
								<td></td>
							</tr>
							<?php endforeach;?>
						<?php endif; ?>
					<?php endif; ?>


				</tbody>
				<tfoot>
					<tr>
						<td colspan="5" class="text-right bold">Total</td>
						<td class="text-right bold"><?=number_format($total_amount_due + $e_tf_amount_due,2)?></td>
						<td class="text-right bold"><?='('.$total_fines.'%) '.number_format($total_amount_fines,2)?></td>

						<td class="text-right bold"><?=number_format($total_amount_paid + $e_tf_amount_due,2)?></td>
						<td class="text-right bold"></td>
					</tr>
				</tfoot>
			</table>
		</div>

		
	</div>
</div>





