<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <title><?= $title;?></title>

    <?= $this->load->view('inc/css')?>

</head>
<body class="page-body" id="my-body">

<div class="page-container"><!-- add class "sidebar-collapsed" to close sidebar by default, "chat-visible" to make chat appear always -->
    
    <div class="sidebar-menu">

        <div class="sidebar-menu-inner">
            <?= $this->load->view('inc/sidebar')?>
        </div>

    </div>

    <div class="main-content"> <!---START MAIN CONTENT -->
         

        <div class="row">
          <div class="col-md-12">
            
            <ul class="nav nav-tabs bordered mt-0" ><!-- available classes "bordered", "right-aligned" -->
              <li class="active">
                <a href="#tuition" data-toggle="tab">
                  <span class="hidden-xs"> Tuition Fee</span>
                </a>
              </li>

              <li class="">
                <a href="#others" data-toggle="tab">
                  <span class="hidden-xs"> Others</span>
                </a>
              </li>

              <!-- <li class="">
                <a href="#payable" data-toggle="tab">
                  <span class="hidden-xs">Accounts Payable</span>
                </a>
              </li> -->
            </ul>

            <div class="tab-content">
               <div class="tab-pane active " id="tuition">
                    
                    
                    <div class="row">

                      <div class="col-md-12">
                        <div class="form-group">
                            <div class="col-sm-8">
                              <label class="control-label bold">Learner's Name</label>
                              <select class="form-control select2  tf_stud_id has-success mb-10" name="tf_stud_id" >
                                  
                                    <?php foreach ($students->result() as $k):?>
                                        <option value="<?=$k->stud_id?>" ><?= ucwords($k->stud_lastname.', '.$k->stud_firstname).' - ('.$k->sec_name.')'?></option>
                                    <?php endforeach; ?>
                                       
                                </select>
                              </div>

                              <div class="col-sm-4 ">
                                  <h2 class="text-right bold">Create Payment</h2>
                              </div>
                        </div>
                      </div>
                    </div>
                    
                    <div class="row">
                      <div class="col-md-12">
                        <div class="form-group">
                              <div class="col-md-12 msg"></div>
                              <div class="here col-md-12 col-sm-12 col-xs-12">
                                <h1>Please choose learner first.</h1>
                              </div>
                        </div>
                      </div>
                    </div>

                    
                   

                
              </div>

              <div class="tab-pane " id="others">
                
                <div class="panel panel-primary panel-shadow" >
                  <div class="panel-heading">
                    <h3 class="panel-title text-white"> </h3>
                  </div>

                  <div class="panel-body">
                      
                      <div class="row">
                        <div class="col-md-12">
                          <div class="form-group">
                              <div class="col-sm-6 col-sm-12">
                                <label class="control-label bold">Learner's Name</label>
                                <select class="form-control select2  oth_stud_id has-success" name="tf_stud_id" >
                                    
                                      <?php foreach ($students->result() as $k):?>
                                          <option value="<?=$k->stud_id?>" ><?= ucwords($k->stud_lastname.', '.$k->stud_firstname).' - ('.$k->sec_name.')'?></option>
                                      <?php endforeach; ?>
                                         
                                  </select>
                                </div>
                          </div>
                        </div>
                      </div>

                  </div>
                </div>
                
              </div>
              <!-- <div class="tab-pane " id="payable">
                
                 <form method="post" id="frmSubmit" action="<?=base_url()?>collection/create_payables" class="form-horizontal form-groups-bordered">
                      <div class="col-md-12 msg"></div>
              
                      <div class="form-group">
                        <table class="table table-condensed table-bordered table-primary">
                          <thead>
                            <th class="width-25">Learner's Name</th>
                            <th class="bold width-15">Type</th>
                            <th class="bold">Amount to Pay</th>
                            <th class="bold width-10">Date <small>(m-d-Y)</small></th>
                            <th class="bold">Remarks</th>
                            <th class="bold"></th>
                          </thead>
              
                          <tbody>
                            <tr class="tbl_row">
                              <td>
                                <select class="form-control   stud_id has-success" name="payable0[stud_id]" >
                                  <?php foreach ($grade_level->result() as $r): 
                                    
                                  ?>
                                        <optgroup label="<?=$r->lvl_name?>">
                                    <?php foreach ($students->result() as $k):?>
                                        <?php 
                                        $lvl_id   = $r->lvl_id;
                                        $klvl_id  = $k->lvl_id;
              
                                        if($lvl_id == $klvl_id):?>
                                        <option value="<?=$k->stud_id?>" ><?= ucwords($k->stud_lastname.', '.$k->stud_firstname).' - ('.$k->sec_name.')'?></option>
                                      <?php endif;?>
                                    <?php endforeach; ?>
                                        </optgroup>
                                  <?php endforeach; ?>
                                </select>
                              </td>
                              <td>
                                <select name="payable0[type]" class="form-control type">
                                  <option disabled="" selected="">Select</option>
                                  <?php foreach($type->result() as $r):?>
                                  <option value="<?=$r->coltype_id?>"><?=$r->coltype_desc?></option>
                                  <?php endforeach; ?>
                                  <option value="others">Others</option>
                                </select>
                              </td>
                              <td><input type="text" class="form-control digit amnt_pay text-right" placeholder="" name="payable0[amnt_pay]"></td>
                              <td><input type="text" class="form-control date"  name="payable0[date]" value="<?=date('m-d-Y')?>"></td>
                              <td><input type="text" class="form-control remarks" placeholder="" name="payable0[remarks]"></td>
                              <td>
                                <button class="btn btn-sm btn-success btn_add" type="button"><i class="fa fa-plus"></i></button>
                                <button class="btn btn-sm btn-danger btn_remove" type="button"><i class="fa fa-times"></i></button>
                              </td>
                            </tr>
                          </tbody>
                        </table>
                      </div>
                  </form>
                  
              </div> -->
            </div>

          </div>
        </div>

        
    </div><!---END MAIN CONTENT -->

  <!-- Modal 7 (Ajax Modal)-->
  <div class="modal fade" id="modal-7">
    <div class="modal-dialog" style="width: 70%">
      <div class="modal-content" style="border: 1px solid #1f4495;">

        <form method="post" id="UpdatePayment" action="<?=base_url()?>collection/edit_payment" class="form-horizontal form-groups-bordered">
        
        <div class="modal-header" style="background-color: #1f4495;">
          <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
          <h4 class="modal-title text-white bold">Edit Payment Record</h4>
        </div>
        
        <div class="modal-body">

         <div class="msg"></div>
        
          <div id="tbl_edit"></div> 
      
          
        </div>
        
        <div class="modal-footer">
          <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
          <button type="submit" class="btn btn-success">Save changes</button>
        </div>

        </form>
      </div>
    </div>
  </div>
  

    

    
    
</div> <!-- end of body container -->

<?= $this->load->view('inc/js')?>
<script>


</script>

<script type="text/javascript" charset="utf-8">
  $(document).ready(function() {
    $('.tf_payment_date').mask('0000/00/00', {placeholder: "yyyy/mm/dd"});
    

    $(document.body).on('click','.btn-edit',function(){
        $('#modal-7').modal('show', {backdrop: 'static', keyboard: false });  

        var spd_id    = $(this).data('id');
        var fee_type  = $(this).data('fee_type');
        var stud_id   = $(this).data('stud_id');

        $('#tbl_edit').load(base_url+'collection/get_edit_payment/'+spd_id+'/'+fee_type+'/'+stud_id);

        console.log(spd_id);     

    });

    //FOR TUITION FEE
    
    $(document.body).on('change','.tf_fine_percentage',function(){
      var base    = $(this);
      var tr      = base.closest('tr');
      var amount  = tr.find('.tf_amount_due').val().replace(/,/g, '');  
      var percent = tr.find('.tf_fine_percentage').val().replace(/,/g, ''); 

      var total   = parseFloat(amount) * (parseFloat(percent)/100);
      var fine    = tr.find('.tf_fine_amount').val(accounting.format(total,2));

      var total_amount = parseFloat(amount) + parseFloat(total);
      tr.find('.tf_sub_total').val(accounting.format(total_amount,2));

      console.log(total_amount);

      get_sub_total();

    });


    var t = 1; 
     $(document.body).on('click','.btn_add_tf',function(){
        //console.log('test');
        var tr    = $(this).closest('.tbl_row_tf');
        var clone = tr.clone();
        
        clone.find(".tf_months").attr("name", "tuition"+t+"[tf_months]");
        clone.find(".tf_amount_due").attr("name", "tuition"+t+"[tf_amount_due]");
       /* clone.find(".tf_tuition_fee").attr("name", "tuition"+t+"[tf_tuition_fee]");
        clone.find(".tf_miscelleneous_fee").attr("name", "tuition"+t+"[tf_miscelleneous_fee]");*/
        clone.find(".tf_fine_percentage").attr("name", "tuition"+t+"[tf_fine_percentage]");
        clone.find(".tf_fine_amount").attr("name", "tuition"+t+"[tf_fine_amount]").val('0.00');
        clone.find(".tf_sub_total").attr("name", "tuition"+t+"[tf_sub_total]").val(accounting.format($('.tf_amount_due').val(),2) );
        clone.find(".tf_remarks").attr("name", "tuition"+t+"[tf_remarks]");

        clone.find('.tf_months option:selected').next().attr('selected', 'selected');
        

        
        //$('.tf_months option:selected').next().attr('selected', 'selected');



        t++;
        tr.after(clone);

        get_sub_total();

     });


      $(document.body).on('click','.btn_remove_tf',function(){

        if( $(this).closest('tr').is('tr:only-child') ) {
            console.log('last tr');
        }
        else {
          if (confirm('Are you sure you want to delete this reacord?')) {
            $(this).closest('tr').remove();
            get_sub_total();
          }
        }

      });


      $(document.body).on('click','.btn-delete',function(){

        /*.btn_remove_payment, */

        if (confirm('Are you sure you want to delete this reacord?')) {
            //$(this).closest('tr').remove();

            var stud_id = $('#tf_stud_id').val(); 
            var spd_id  = $(this).data('id');
            var sp_id   = $(this).data('sp_id');

            //console.log(stud_id); 

            $.post( base_url+'collection/delete_payment/'+spd_id+'/'+sp_id, function( data ) {
              $('.here').load(base_url + 'collection/get_assessment/'+stud_id);
            });
            
        } 
         
      });

      
      //$('#frmTuition').submit(function(e){
      //
      

      /*$(document.body).on('click', '.print_table', function(e){
        stud_id = $('.stud_name').val();
        
        var TableData = new Array();
    
        $('.table_past_due tr').each(function(row, tr){
            TableData[row]={
                "period" : $(tr).find('td:eq(0)').text()
                , "due_amount" :$(tr).find('td:eq(1)').text()
                , "fine_amount" : $(tr).find('td:eq(3)').text()
                , "sub_total" : $(tr).find('td:eq(4)').text()
            }
        }); 


        console.log(TableData);  // first row is the table header - so remove

        

      });*/

      $(document.body).on('submit', '#frmTuition', function(e){

        e.preventDefault(); 

        var base  = $(this);
        var msg   = $(".msg");
        var btn   = base.find("button");
        var tr    = base.closest('tr');



          $.ajax({
          type:base.attr("method"),//get/post
          data:base.serialize(),
          url:base.attr("action"),//location for the url
          beforeSend:function(){
            msg.empty().html(alert_minimal('Processing . . .'));
            btn.prop("disabled",true);
          },
          success:function(rrdata){

            btn.prop("disabled",false);

            var rdata = $.parseJSON(rrdata);
            if(rdata.stat){
              msg.empty().html(alert_success(rdata.msg)).show();

              /*var stud_id = $('.tf_stud_id').val(); */

              var stud_id = rdata.id; 
              $('.here').load(base_url+'collection/get_assessment/'+stud_id);
              //$('.tbl_payment_record').load(base_url + 'collection/get_update_payment_record/'+stud_id);

              //$('.html_tf_balance').html(accounting.format(rdata.id, 2) );
              //$('.tf_balance').val(rdata.id);

              console.log(rdata.id);
            }
            else{
              msg.empty().html(alert_error(rdata.msg));
            }

            
            
          },
          error:function(rdata){
            btn.prop("disabled",false);
            msg.empty().html(alert_error('An error occured, please try again later'));
          }
        });
      });


      $(document.body).on('submit', '#UpdatePayment', function(e){

        e.preventDefault(); 

        var base  = $(this);
        var msg   = base.find(".msg");
        var btn   = base.find("button");
        var tr    = base.closest('tr');



          $.ajax({
          type:base.attr("method"),//get/post
          data:base.serialize(),
          url:base.attr("action"),//location for the url
          beforeSend:function(){
            msg.empty().html(alert_minimal('Processing . . .'));
            btn.prop("disabled",true);
          },
          success:function(rrdata){

            btn.prop("disabled",false);

            var rdata = $.parseJSON(rrdata);
            if(rdata.stat){
              msg.empty().html(alert_success(rdata.msg)).show();

              var stud_id = $('#tf_stud_id').val(); 
              $('.here').load(base_url+'collection/get_assessment/'+stud_id);

              console.log(rdata.id);
            }
            else{
              msg.empty().html(alert_error(rdata.msg));
            }

            
            
          },
          error:function(rdata){
            btn.prop("disabled",false);
            msg.empty().html(alert_error('An error occured, please try again later'));
          }
        });
      });


      $(document.body).on('blur','.tf_sub_total',function(){
        $(this).val(accounting.format($(this).val(),2));
      });

    // END FOR TUITION FEE FUNCTION


    

    $('.date').mask('00/00/0000', {placeholder: "mm/dd/yyyy"});
   
    $('.tf_stud_id').change(function(){
      stud_id  = $(this).val();

      $('.here').load(base_url+'collection/get_assessment/'+stud_id);
      $('.tf_payment_date').mask('0000/00/00', {placeholder: "yyyy/mm/dd"});
      $('.msg').empty().hide();
    });






    var s = 1; 
     $(document.body).on('click','.btn_add',function(){
        //console.log('test');
        var tr    = $(this).closest('.tbl_row');
        var clone = tr.clone();
        clone.find('.remarks, .amnt_pay').val('');

        clone.find(".stud_id").attr("name", "payable"+s+"[stud_id]");
        clone.find(".type").attr("name", "payable"+s+"[type]");
        clone.find(".amnt_pay").attr("name", "payable"+s+"[amnt_pay]");
        clone.find(".date").attr("name", "payable"+s+"[date]");
        clone.find(".remarks").attr("name", "payable"+s+"[remarks]");

        s++;
        tr.after(clone);
        //$('.date').val();
     });


     $(document.body).on('click','.btn_remove',function(){
        $(this).closest('tr').remove();
     });

    $(document.body).on('blur','.digit',function(){
      $(this).val(accounting.format($(this).val(),2));
    });


    $(document.body).on('blur','.tf_sub_total ',function(){
        //$('.sub_total_amnt ').val(accounting.format($(this).val(),2));
        get_sub_total();
    });


    $(document.body).on('keyup','.tf_amount_due',function(){

      var val  = $(this).val().replace(/,/g, '');
      
      
      var fine          = $(this).closest('.tbl_row_tf').find('.tf_fine_percentage').val();
      var fine_amount   = $(this).closest('.tbl_row_tf').find('.tf_fine_amount').val().replace(/,/g, '');

      var total_fine  = (parseFloat(val) * (parseFloat(fine)/100) );
      var subtotal    = parseFloat(val) + parseFloat(total_fine);

      $(this).closest('.tbl_row_tf').find('.tf_sub_total').val(accounting.format(subtotal,2));
      $(this).closest('.tbl_row_tf').find('.tf_fine_amount').val(accounting.format(total_fine,2) );
      

      get_sub_total();
      console.log(subtotal);

    });


    





  

       
  });


function showAjaxModal()
  {
    jQuery('#modal-7').modal('show', {backdrop: 'static'});
    
    /*jQuery.ajax({
      url: "data/ajax-content.txt",
      success: function(response)
      {
        jQuery('#modal-7 .modal-body').html(response);
      }
    });*/
  }


function get_sub_total(){
      var sum = 0;
      var balance = 0
      var due = 0;

      var out_balance  = $('.tf_balance').val();

      $('.tf_sub_total').each(function() {
          var val = parseFloat($(this).val().replace(/,/g , '') );
          sum += val;
      });

      $('.tf_amount_due').each(function() {
        var due = parseFloat($(this).val().replace(/,/g , '') );
        balance += due;

      });

      //console.log(balance);

      $('.sub_total_amnt').html( accounting.format(sum,2) );
      $('.tf_amount_paid').val(sum);

      //$('.due').html(balance);
      
  }



 
function validate_date(birthdate){
  var bdate = birthdate;
  var comp = bdate.split('/');
  var m = parseInt(comp[0], 10);
  var d = parseInt(comp[1], 10);
  var y = parseInt(comp[2], 10);
  var date = new Date(y,m-1,d);
  if (date.getFullYear() == y && date.getMonth() + 1 == m && date.getDate() == d) {
    return true;
  } else {
    return false;
  }
}


</script>
</body>
</html>