
<?= $this->load->view('inc/isfaculty') ?>
<?php 
    if(empty($subj->row('sub_name')) ){
       header('Location: '.base_url());
    }
?>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <title><?= $title;?></title>

    <?= $this->load->view('inc/css')?>

</head>
<body class="page-body gray">

<div class="page-container"><!-- add class "sidebar-collapsed" to close sidebar by default, "chat-visible" to make chat appear always -->

    

    <div class="sidebar-menu">

        <div class="sidebar-menu-inner">
            <?= $this->load->view('inc/sidebar')?>
        </div>

    </div>

    <div class="main-content"> <!---START MAIN CONTENT -->
    
           <div class="row">
               <div class="col-md-9">
                    <?php 
                        $dept_name =  $subj->row('dept_name');
                        $badge = '';

                        if($dept_name=='Pre-School'){
                            $badge  = 'success';
                        }else if($dept_name == 'Primary' ){
                            $badge  = 'danger';
                        }else{
                            $badge  = 'info';
                        }
                    ?>
                   <div class="panel panel-<?=$badge?>">
                        <div class="panel-heading">
                            <div class="row" style="padding:25px 15px 15px">
                                <div class="col-md-6">
                                    <h2 class="m-0 bold text-white"><?=$subj->row('sub_name')?> 
                                        <?php $sub_det = $this->module->get_query("SELECT subj_det_name FROM subject_detail WHERE subj_det_id =".$subj->row('subj_det_id')." "); 

                                            if($sub_det->num_rows() > 0):
                                        ?>

                                            - <?= $sub_det->row('subj_det_name')?>

                                        <?php endif; ?>
                                    </h2>
                                </div>

                                <div class="col-md-6 text-right">
                                    <h4 class="m-0 bold text-white"><?=$subj->row('lvl_name').' <i class="fa fa-angle-right"></i> '.$subj->row('sec_name')?></h4>
                                </div>
                            </div>
                        </div>

                        <div class="panel-body">
                            
                            <form method="post" id="frmSubmit" action="<?=base_url()?>grading/edit_score" >

                                <div class="row" >

                                    <div class="col-md-3">
                                       <?php 
                                            $scr_id           =  $score_hdr->row('scr_id');
                                            $scr_quarter      =  $score_hdr->row('scr_quarter');
                                            $scr_type         =  $score_hdr->row('scr_type');
                                            $scr_item         =  $score_hdr->row('scr_item');
                                            $scr_sub_type     =  $score_hdr->row('scr_sub_type');
                                            $scr_total_score  =  $score_hdr->row('scr_total_score');
                                        ?>

                                        <input type="hidden" name="subj_id" class="form-control subj_id" value="<?=$subj->row('subj_id'); ?>">
                                        <input type="hidden" name="scr_id" class="form-control scr_id" value="<?=$scr_id;?>">


                                       
                                       
                                        <div class="form-group">
                                            <label >Quarter</label>
                                            <select class="form-control quarter"  disabled=""  required="">
                                               <option selected="" disabled="">SELECT</option>
                                               <option <?=($scr_quarter=='1Q' ? 'selected=""' : '')?> value="1Q">1st Quarter</option>
                                               <option <?=($scr_quarter=='2Q' ? 'selected=""' : '')?> value="2Q">2nd Quarter</option>
                                               <option <?=($scr_quarter=='3Q' ? 'selected=""' : '')?> value="3Q">3rd Quarter</option>
                                               <option <?=($scr_quarter=='4Q' ? 'selected=""' : '')?> value="4Q">4th Quarter</option>
                                            </select>
                                              

                                              <input type="hidden" name="scr_quarter" class="form-control" value="<?=$scr_quarter;?>">

                                        </div>
                                    </div>

                            
                                    <div class="col-md-3">
                                        <div class="form-group">
                                            <label >Type</label>
                                            <select class="form-control type" disabled="" required="">
                                               <option selected="" disabled="">SELECT</option>
                                               <option <?=($scr_type=='WW' ? 'selected=""' : '')?> value="WW">Written Works</option>
                                               <option <?=($scr_type=='PT' ? 'selected=""' : '')?>  value="PT">Performance Task</option>
                                               <option <?=($scr_type=='QA' ? 'selected=""' : '')?>  value="QA">Quarterly Assessment</option>
                                            </select>

                                            <input type="hidden" name="scr_type" class="form-control" value="<?=$scr_type;?>">
                                        </div>
                                    </div>

                                    <div class="col-md-1">
                                        <div class="form-group">
                                            <label >No</label>
                                            <input type="text" class="form-control scr_item" readonly="" name="scr_item" value="<?=$scr_item?>">
                                        </div>
                                    </div>

                                    <div class="col-md-3">
                                        <div class="form-group">
                                            <label >Sub-type</label>
                                            <select class="form-control sub_type" disabled="">
                                               <option selected="" disabled="">SELECT</option>
                                               <option <?=($scr_sub_type=='SW' ? 'selected=""' : '')?> value="SW">Seatwork</option>
                                               <option <?=($scr_sub_type=='HW' ? 'selected=""' : '')?> value="HW">Homework</option>
                                               <option <?=($scr_sub_type=='QZ' ? 'selected=""' : '')?> value="QZ">Quizes</option>
                                            </select>

                                            <input type="hidden" name="scr_sub_type" class="form-control" value="<?=$scr_sub_type;?>">
                                        </div>
                                    </div>

                                    <div class="col-md-2">
                                        <label >Total Score</label>
                                        <div class="input-group m-0" >
                                            <input class="form-control scr_total_score" value="<?=$scr_total_score?>" type="text" name="scr_total_score" autofocus="" required="" autocomplete="off">
                                            <span class="input-group-btn">
                                            <button class="btn btn-danger btn_delete"> <i class="fa fa-times"></i></button>
                                             </span>
                                        </div>

                                        
                                    </div>
                                </div>

                                <hr/>

                                <?php 
                                    $cnt        = 1;
                                    $sec_id     = $subj->row('sec_id');
                                    $sy_id      = $this->module->get_active_sy();
                                    $student    = $this->module->get_query(" SELECT * FROM v_section_assignment WHERE stud_gender = 'Male' AND  sec_id =".$sec_id." AND sy_id =".$sy_id." ORDER BY stud_lastname ASC");

                                    $student_cnt  = $this->module->get_query(" SELECT COUNT(*) as cnt FROM v_section_assignment WHERE  sec_id =".$sec_id." AND sy_id =".$sy_id." ORDER BY stud_lastname ASC");
                                ?>

                                <div class="row">
                                  <div class="col-md-10">
                                    <h3><strong>Class List</strong> (<?=$student_cnt->row('cnt')?>)</h3>
                                  </div>
                                  <div class="col-md-2 text-right">
                                    <a class="btn btn-success" href="<?=base_url()?>grading/class_record/<?=$subj->row('subj_id')?>">View Class record </a>
                                  </div>
                                </div>

                                <table class="table table-condensed table-striped ">
                                    <thead>
                                        <th class="width-5 text-center bold">No.</th>
                                        <th class="bold">Learners Name</th>
                                        <th class="bold" style="width:20%">Raw Score</th>
                                    </thead>

                                    <tbody>

                                        <tr>
                                            <td colspan="3" class="bold">BOYS</td>
                                        </tr>

                                        <?php
                                        foreach ($student->result() as $k):  
                                            $stud_id =$k->stud_id;
                                          ?>
                                          
                                            <tr>
                                                <td class="text-center"><?=$cnt?></td>
                                                <td><h5><strong><?=$k->stud_lastname.'</strong>, '.$k->stud_firstname.' '.substr($k->stud_middlename,0, 1) ?><?= !empty($k->stud_middlename)?'.':''?></h5></td>
                                                <td> 
                                                    <div class="input-group m-0 raw_score has-success" >
                                                        <input type="hidden" name="student<?=$cnt?>[stud_id]" class="form-control" value="<?=$stud_id; ?>">
                                                          <?php $score = $this->module->table_where('student_score', array('scr_id' => $scr_id, 'stud_id' => $stud_id )); ?>

                                                          <input type="hidden" name="student<?=$cnt?>[sscr_id]" class="form-control" value="<?=$score->row('sscr_id')?>">
                                                          
                                                          <input class="form-control num" type="text" value="<?=$score->row('sscr_score')?>" name="student<?=$cnt?>[sscr_score]" autofocus="" autocomplete="off" required="" tabindex="<?=$cnt?>">
                                                        <span class="input-group-btn">
                                                        <button class="btn btn-danger btn_delete"> <i class="fa fa-times"></i></button>
                                                         </span>

                                                        
                                                    </div>
                                                </td>
                                            </tr>

                                         <?php  
                                                $cnt++;
                                                endforeach; ?>

                                        <tr>
                                            <td colspan="3" class="bold">GIRLS</td>
                                        </tr>

                                         <?php 
                                        $cnt2        = 1;
                                        $sec_id     = $subj->row('sec_id');
                                        $sy_id      = $this->module->get_active_sy();
                                        $student  = $this->module->get_query(" SELECT * FROM v_section_assignment WHERE stud_gender = 'Female' AND  sec_id =".$sec_id." AND sy_id =".$sy_id." ORDER BY stud_lastname ASC");
                                        foreach ($student->result() as $k):  
                                            $stud_id =$k->stud_id;
                                          ?>
                                          
                                            <tr>
                                                <td class="text-center"><?=$cnt2?></td>
                                                <td><h5><strong><?=$k->stud_lastname.'</strong>, '.$k->stud_firstname.' '.substr($k->stud_middlename,0, 1) ?><?= !empty($k->stud_middlename)?'.':''?></h5></td>
                                                <td> 
                                                    <div class="input-group m-0 raw_score has-success" >
                                                        <input type="hidden" name="student<?=$cnt?>[stud_id]" class="form-control" value="<?=$stud_id; ?>">
                                                          <?php $score = $this->module->table_where('student_score', array('scr_id' => $scr_id, 'stud_id' => $stud_id )); ?>

                                                          <input type="hidden" name="student<?=$cnt?>[sscr_id]" class="form-control" value="<?=$score->row('sscr_id')?>">
                                                          
                                                          <input class="form-control num" type="text" value="<?=$score->row('sscr_score')?>" name="student<?=$cnt?>[sscr_score]" autofocus="" autocomplete="off" required="" tabindex="<?=$cnt?>">

                                                        <span class="input-group-btn">
                                                        <button class="btn btn-danger btn_delete"> <i class="fa fa-times"></i></button>
                                                         </span>

                                                        
                                                    </div>
                                                </td>
                                            </tr>

                                         <?php  
                                                $cnt++;
                                                $cnt2++;
                                                endforeach; ?>

                                    </tbody>
                                </table>

                                <div class="row">
                                    <div class="col-md-12 text-right"><button class="btn btn-success" type="submit"> Update Record </button></div>
                                </div>

                            </form>
                        </div>
                    </div>
               </div>

               <div class="col-md-3 msg">
                   
               </div>
              
           </div>


    </div><!---END MAIN CONTENT -->
</div> <!-- end of body container -->


<?= $this->load->view('inc/js')?>
<script type="text/javascript" charset="utf-8">
  $(document).ready(function() {

        $(document.body).on('blur','.num',function(){
           var  scr_total_score = parseInt($('.scr_total_score').val());
           var tr               = $(this).closest('tr');
           var num              = parseInt(tr.find('.num').val());  

           if( num <= scr_total_score){
                $('.msg').empty();
                tr.find('.raw_score').removeClass('has-error').focus();
           }else{
                $(this).val('');
                $('.msg').html(alert_error('<strong>Raw Score</strong> must be lower than to the total score'));
                tr.find('.raw_score').addClass('has-error').focus();
           }

        });

        $('.btn_delete').click(function(){

            var tr = $(this).closest('tr');
            var id = tr.find('.digit').val('');

        });

        $('.type').on('change', function(e){
            var type        = $(this).val(); 
            var quarter     = $('.quarter').val();
            var subj_id     = $('.subj_id').val();

            if(type=='WW'){
                $('.sub_type').prop('disabled',false);
            }else{
                $('.sub_type').prop('disabled',true).prop('selectedIndex', 0);
            }

            //$('.scr_item').load(base_url+'grading/get_item/'+quarter+'/'+type);

            e.preventDefault(); 

            var base  = $(this);
            var msg   = $(".msg");
            var btn   = base.find("button");
            
            $.ajax({
                  type:base.attr("method"),//get/post
                  data:base.serialize(),
                  url:base_url+'grading/get_item/'+quarter+'/'+type+'/'+subj_id,//location for the url
                  beforeSend:function(){
                    msg.empty().html(alert_minimal('Processing . . .'));
                    btn.prop("disabled",true);
                  },
                  success:function(rrdata){

                    btn.prop("disabled",false);
                    var rdata = $.parseJSON(rrdata);
                    if(rdata.stat){
                     $('.scr_item').val(rdata.msg);
                    }
                    else{
                      msg.empty().html(alert_error(rdata.msg));
                    }
                    
                  },
                  error:function(rdata){
                    btn.prop("disabled",false);
                    msg.empty().html(alert_error('An error occured, please try again later'));
                  }
            });
            
            
        });


        $('#frmSubmit').submit(function(e){
            e.preventDefault(); 

            var base  = $(this);
            var msg   = $(".msg");
            var btn   = base.find("button");

            var subj_id = $('.subj_id').val();
            
            $.ajax({
                  type:base.attr("method"),//get/post
                  data:base.serialize(),
                  url:base.attr("action"),//location for the url
                  beforeSend:function(){
                    msg.empty().html(alert_minimal('Processing . . .'));
                    btn.prop("disabled",true);
                  },
                  success:function(rrdata){

                    btn.prop("disabled",false);
                    var rdata = $.parseJSON(rrdata);
                    if(rdata.stat){
                    msg.empty().html(alert_success(rdata.msg));
                    /* window.setTimeout(function(){
                        window.location = base_url + 'grading/class_record/'+subj_id;
                      },3000);*/

                     $('#frmSubmit')[0].reset();
                    }
                    else{   
                      msg.empty().html(alert_error(rdata.msg));
                    }
                    
                  },
                  error:function(rdata){
                    btn.prop("disabled",false);
                    msg.empty().html(alert_error('An error occured, please try again later'));
                  }
            });
        });

  });
</script>
</body>
</html>