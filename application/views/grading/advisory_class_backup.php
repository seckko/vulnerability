<?php 

    
  $usr_name       = $this->session->userdata('usr_name');
  $usr_type       = $this->session->userdata('usr_type');
  $usr_firstname  = $this->session->userdata('usr_firstname');
  $usr_lastname   = $this->session->userdata('usr_lastname');
  $usr_is_login   = $this->session->userdata('usr_is_login');
  $tch_id         = $this->session->userdata('tch_id');
  $sy_id          = $this->module->get_active_sy();

  $where           = 'tch_id = "'.$tch_id.'"  AND sy_id = "'.$sy_id.'" ';

  if( ($usr_type <> 'Faculty') || empty($tch_id) ){
    header('Location: '.base_url());
  }

?>


<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <title><?= $title;?></title>

    <?= $this->load->view('inc/css')?>

</head>
<body class="page-body gray">

<div class="page-container  horizontal-menu sidebar-collapsed"><!-- add class "sidebar-collapsed" to close sidebar by default, "chat-visible" to make chat appear always -->
    <header class="navbar navbar-fixed-top"><!-- set fixed position by adding class "navbar-fixed-top" -->
        
        <div class="navbar-inner">
            <?=$this->load->view('inc/topbar');?>
        </div>
    </header>

    <div class="main-content">

        <?php 
            $sec_name       = '';
            $lvl_name       = '';
            $sec_teacher    = '';
            $dept_name      = '';
            $lvl_color      = '';

            $sy_id          = $sy_id;
            $sec_id         = $sec_id;
            $quarter        = $this->module->table_where('quarter', array('qtr_active' => 'Y'))->row('qtr_code');

            if($section->num_rows() > 0){
                foreach($section->result() as $r){
                    $lvl_name       = $r->lvl_name;
                    $sec_name       = $r->sec_name;
                    $sec_teacher    = $r->sec_teacher;
                    $dept_name      = $r->dept_name;
                    $lvl_color      = $r->lvl_color;
                }
            }
        ?>
        <div class="row">
            <div class="col-md-12 ">
                <div class="panel panel-primary " >
                    <div class="panel-heading" style="padding:20px 20px">
                        <div class="row">
                            <div class="col-md-8">
                                <h1 class="m-0 bold" style="color:#<?=$lvl_color?>"><?=$sec_name?></h1>
                                <h4 class="m-0"><?= '<strong>'.$lvl_name .'</strong> | '.$dept_name.' Department' ?></h4>
                            </div>
                        </div>
                    </div>

                    <div class="panel-body">

                        <table class="table table-condense" id="data">
                            <thead>
                                <th class="text-center" style="width:1%">No.</th>
                                <th>Learners Name</th>

                                <?php foreach ($subject->result() as $k): 
                                        $sub_id         = $k->sub_id;
                                        $sub_name       = $k->sub_name;
                                        $subj_det_id    = $k->subj_det_id;

                                        $subj_id        = $k->subj_id;
                                ?>

                                <?php if($subj_det_id == 0):?>
                                <th class="text-center width-5">
                                    <?=$k->sub_name?>
                                    <br/><small><?=$k->tch_firstname.' '.$k->tch_lastname?>  </small>      
                                </th>
                                <?php else: ?>
                                <th class="text-center width-5">
                                    <?php 
                                        $subj_det = $this->module->table_where('subject_detail', array('subj_det_id' => $k->subj_det_id)); 
                                    ?>

                                    <?=$k->sub_name.'<br/> '.$subj_det->row('subj_det_name')?>
                                    <br/><small><?=$k->tch_firstname.' '.$k->tch_lastname?>  </small>
                                </th>
                                <?php endif; ?>
                                
                                <?php endforeach; ?>

                            </thead>
                            <tbody>
                                
                            <tbody>
                                    <?php 
                                        $cnt = 1;
                                        foreach($boys->result() as $r): 
                                            $total_ww_st = 0;
                                            $total_pt_st = 0;
                                            $total_qa_st = 0;                                                
                                            $stud_id     =  $r->stud_id;
                                        ?>
                                        <tr class="me">
                                           <td class="text-center vmiddle  boys" ><?=$cnt?></td>
                                           <td class="vmiddle ">
                                                <h5 class="m-0"> 
                                                   <strong > <?=$r->stud_lastname.'</strong>, '.$r->stud_firstname.' '.substr($r->stud_middlename,0, 1) ?><?= !empty($r->stud_middlename)?'.':''?>
                                                </h5>
                                            </td>
                                            
                                            <?php foreach ($subject->result() as $k): 
                                                $sub_id     = $k->sub_id;
                                                $subj_id    = $k->subj_id;

                                                $ww_total   = 0;
                                                $pt_total   = 0;
                                                $qa_total   = 0;

                                                $ww_score   = 0;
                                                $pt_score   = 0;
                                                $qa_score   = 0;

                                                $total = $this->module->get_query("SELECT scr_type, SUM(scr_total_score) AS scr_total_score FROM student_score_hdr WHERE scr_quarter = '".$quarter."' AND subj_id = ".$subj_id." GROUP BY scr_type");

                                                $score  = $this->module->get_query("SELECT scr_type, SUM(sscr_score) AS sscr_score FROM v_student_score WHERE scr_quarter = '".$quarter."' AND subj_id = ".$subj_id." AND stud_id = ".$stud_id." GROUP BY scr_type");


                                                foreach($total->result() as $t){
                                                    $scr_type = $t->scr_type;

                                                    if($scr_type == 'WW'){
                                                        $ww_total   = $t->scr_total_score;
                                                    }else if($scr_type == 'PT'){
                                                        $pt_total   = $t->scr_total_score;
                                                    }else if($scr_type == 'QA'){
                                                        $qa_total   = $t->scr_total_score;
                                                    }
                                                }

                                                $component        = $this->module->table_where('component_assessment', array('sub_id' => $sub_id));
                                                $ca_ww_percentage = 0;
                                                $ca_pt_percentage = 0;
                                                $ca_qa_percentage = 0;

                                                $quarterly_grade  = 0;

                                                if($component->num_rows() > 0 ){
                                                  foreach($component->result() as $l){
                                                      $ca_ww_percentage = $l->ca_ww_percentage;
                                                      $ca_pt_percentage = $l->ca_pt_percentage;
                                                      $ca_qa_percentage = $l->ca_qa_percentage;
                                                  }
                                                }else{
                                                    $ca_ww_percentage = $ca_ww_percentage;
                                                    $ca_pt_percentage = $ca_pt_percentage;
                                                    $ca_qa_percentage = $ca_qa_percentage;
                                                }

                                                $initial_grade = 0;

                                                if($score->num_rows() > 0){
                                                    foreach($score->result() as $t){
                                                        $scr_type = $t->scr_type;

                                                        if($scr_type == 'WW'){
                                                            $ww_score   = $t->sscr_score;
                                                            $ps_ww      = round( (($ww_score * 100) / $ww_total),2 );
                                                            $ws_ww      = round( ($ps_ww * ($ca_ww_percentage / 100 ) ) ,2 );
                                                        }else if($scr_type == 'PT'){
                                                            $pt_score   = $t->sscr_score;
                                                            $ps_pt      = round( (($pt_score * 100) / $pt_total),2 );
                                                            $ws_pt      = round( ($ps_pt * ($ca_pt_percentage / 100 ) ) ,2 );

                                                        }else if($scr_type == 'QA'){
                                                            $qa_score   = $t->sscr_score;
                                                            $ps_qa      = round( (($qa_score * 100) / $qa_total),2 );
                                                            $ws_qa      = round( ($ps_qa * ($ca_qa_percentage / 100 ) ) ,2 );
                                                        }
                                                    }

                                                    $initial_grade = $ws_ww + $ws_pt + $ws_qa;
                                                }else{
                                                    $initial_grade = 0;
                                                }


                                                $q = $this->module->get_query("SELECT gt_grade FROM grade_transmutation WHERE ( ".$initial_grade." BETWEEN CAST(gt_min AS DECIMAL)  AND CAST(gt_max AS DECIMAL)) ");
                                                $final_grade = $q->row('gt_grade');

                                                if($q->num_rows() < 1){
                                                    $quarterly_grade = 0;
                                                }else{
                                                    $quarterly_grade = $final_grade;
                                                }

                                            
                                                

                                            ?>
                                           
                                            <th class="text-center width-5"><?=$quarterly_grade?></th>
                                           
                                            <?php endforeach; ?>


                                        <?php 
                                            $cnt++;
                                            endforeach;?>
                            </tbody>
                        </table>  

                        
                    </div>
                </div>
            </div>
        </div>
    </div>

    
</div> <!-- end of body container -->


<?= $this->load->view('inc/js')?>
<script type="text/javascript" charset="utf-8">
  $(document).ready(function() {

    $("#data tr.me").click(function() {
        var selected = $(this).hasClass("highlights");
        $("#data tr").removeClass("highlights");
        if(!selected)
                $(this).addClass("highlights");
    });
       

  });
</script>
</body>
</html>