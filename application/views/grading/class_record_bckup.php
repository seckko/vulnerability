<?= $this->load->view('inc/isfaculty') ?>


<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <title><?= $title;?></title>

    <?= $this->load->view('inc/css')?>

</head>
<body class="page-body gray">

<div class="page-container"><!-- add class "sidebar-collapsed" to close sidebar by default, "chat-visible" to make chat appear always -->

    <div class="sidebar-menu">

        <div class="sidebar-menu-inner">
            <?= $this->load->view('inc/sidebar')?>
        </div>

    </div>

    <div class="main-content"> <!---START MAIN CONTENT -->
        <h1><?=$title;?></h1> 
        <hr/>


        <div class="panel panel-primary panel-table" >
            <div class="panel-heading">
                <div class="panel-title">
                    <h3>
                        <strong><?=$subj->row('sub_name')?> </strong>
                        <?php $sub_det = $this->module->get_query("SELECT subj_det_name FROM subject_detail WHERE subj_det_id =".$subj->row('subj_det_id')." "); 

                            if($sub_det->num_rows() > 0):
                        ?>

                            - <?= $sub_det->row('subj_det_name')?>

                        <?php endif; ?>

                    </h3>
                    <span> <?=$subj->row('lvl_name').' - '.$subj->row('sec_name')?>  </span>
                </div>
            </div>

            <div class="panel-body">
                <?php 
                    $cnt            = 1;
                    $sec_id         = $subj->row('sec_id');
                    $subj_id        = $this->uri->segment(3);
                    $sy_id          = $this->module->get_active_sy();
                    $student        = $this->module->get_query("SELECT * FROM v_section_assignment WHERE sec_id =".$sec_id." AND sy_id =".$sy_id." ORDER BY stud_lastname ASC"); 
                ?>
                
                <div class="row">
                    <div class="col-md-12">
                       <a href="<?=base_url()?>grading/add_score/<?=$subj_id?>" class="btn btn-success"><i class="fa fa-plus"></i> Add Score </a>
                    </div>
                </div>
                <br/>
                <div class="table-responsive">
                    
                    <table class="table table-condensed table-bordered table-striped ">
                        <thead>
                            <th colspan="2"></th>

                            <?php  
                                $ww  = $this->module->get_query("SELECT scr_type, COUNT(*) AS cnt FROM v_subject_score WHERE subj_id = ".$subj_id." AND scr_type = 'WW' GROUP BY scr_type")->row('cnt');
                                $pt  = $this->module->get_query("SELECT scr_type, COUNT(*) AS cnt FROM v_subject_score WHERE subj_id = ".$subj_id." AND scr_type = 'PT' GROUP BY scr_type")->row('cnt');
                                $qa  = $this->module->get_query("SELECT scr_type, COUNT(*) AS cnt FROM v_subject_score WHERE subj_id = ".$subj_id." AND scr_type = 'QA' GROUP BY scr_type")->row('cnt'); 
                            ?>
                            <th class="bold text-center" rowspan="2" colspan="<?=intval($ww) + 3?>" style="background-color: #009987; color: #fff"><h4 class="m-0 bold text-white">WRITTEN WORKS</h4></th>
                            <th class="bold text-center" rowspan="2" colspan="<?=intval($pt) + 3?>" style="background-color: #b167c4; color: #fff" ><h4 class="m-0 bold text-white">PERFORMANCE TASK</h4></th>
                            <th class="bold text-center" rowspan="2" colspan="<?=intval($qa) + 3?>" style="background-color: #ea2474; color: #fff"><h4 class="m-0 bold text-white">QUARTERLY ASSESSMENT</h4></th>
                            <th style="width:5%"></th>
                        </thead> 

                        <tbody>
                             <tr>
                                <th class="vmiddle text-center bold width-5">NO.</th>
                                <th class="vmiddle bold">LEARNERS NAME</th>
                                
                                <!-- WRITTEN WORKS -->

                                <?php 
                                    $total_ww = 0;
                                    $total_pt = 0;
                                    $total_qa = 0;

                                    $ca_ww_percentage = $this->module->get_query("SELECT * FROM component_assessment WHERE sub_id = ".$subj->row('sub_id')." ")->row('ca_ww_percentage');
                                    $ca_pt_percentage = $this->module->get_query("SELECT * FROM component_assessment WHERE sub_id = ".$subj->row('sub_id')." ")->row('ca_pt_percentage');
                                    $ca_qa_percentage = $this->module->get_query("SELECT * FROM component_assessment WHERE sub_id = ".$subj->row('sub_id')." ")->row('ca_qa_percentage');

                                    $hdr  = $this->module->get_query("SELECT * FROM student_score_hdr WHERE subj_id = ".$subj_id." AND scr_type = 'WW' ");
                                    foreach($hdr->result() as $h):
                                ?>
                                    <th class="text-center vmiddle" style="width:40pt">
                                        <small><?=$h->scr_item?> <br/> <?= $h->scr_sub_type?> </small> <br/> (<strong><?=number_format($h->scr_total_score)?></strong>)
                                        <?php $total_ww += $h->scr_total_score  ?>
                                        <hr style="margin:5px" />

                                        <div class="btn-group">
                                            <a href="<?=base_url()?>grading/edit_score/<?=$subj_id.'/'.$h->scr_id?>" type="button" class="btn btn-primary btn-xs btn-block">Edit</a>
                                            <a href="#" data-id="<?=$h->scr_id?>" type="button" class="btn btn-danger btn-xs btn-block delete">Delete</a>
                                        </div>

                                    </th>
                                <?php endforeach; ?>
                                    <th class="text-center vmiddle" style="background-color: #009987; color: #fff; width:5%" ><small>TOTAL</small> <br/> (<strong><?=$total_ww?></strong>)</th>
                                    <th class="text-center vmiddle" style="background-color: #009987; color: #fff; width:5%" >PS <br/> </th>
                                    <th class="text-center vmiddle" style="background-color: #009987; color: #fff; width:5%" >WS <br/><strong>(<?=$ca_ww_percentage?>%)</strong><br/> </th>

                                <!-- END WRITTEN WORKS -->

                                <!-- PERFORMANCE TASK -->

                                <?php 

                                    $hdr  = $this->module->get_query("SELECT * FROM student_score_hdr WHERE subj_id = ".$subj_id." AND scr_type = 'PT' ");
                                    foreach($hdr->result() as $h):
                                ?>
                                    <th class="text-center vmiddle" style="width:40pt">
                                        <small><?=$h->scr_item?> <br/> <?= $h->scr_sub_type?> </small> <br/> (<strong><?=number_format($h->scr_total_score)?></strong>)
                                        <?php $total_pt += $h->scr_total_score  ?>
                                        <hr style="margin:5px" />

                                        <div class="btn-group">
                                            <a href="<?=base_url()?>grading/edit_score/<?=$subj_id.'/'.$h->scr_id?>" type="button" class="btn btn-primary btn-xs btn-block">Edit</a>
                                            <a href="#" data-id="<?=$h->scr_id?>" type="button" class="btn btn-danger btn-xs btn-block delete">Delete</a>
                                        </div>

                                    </th>
                                <?php endforeach; ?>
                                 <th class="text-center vmiddle" style="background-color: #b167c4; color: #fff; width:5%" ><small>TOTAL</small> <br/> (<strong><?=$total_pt?></strong>) </th>
                                 <th class="text-center vmiddle" style="background-color: #b167c4; color: #fff; width:5%" >PS <br/> </th>
                                 <th class="text-center vmiddle" style="background-color: #b167c4; color: #fff; width:5%" >WS <br/><strong>(<?=$ca_pt_percentage?>%)</strong><br/> </th>
                                <!-- END PERFORMANCE TASK -->

                                <!-- QUARTERLY ASSESSMENT -->
                                <?php 
                                    $hdr  = $this->module->get_query("SELECT * FROM student_score_hdr WHERE subj_id = ".$subj_id." AND scr_type = 'QA' ");
                                    foreach($hdr->result() as $h):
                                ?>
                                    <th class="text-center vmiddle" style="width:40pt">
                                        <small><?=$h->scr_item?> <br/> <?= $h->scr_sub_type?> </small> <br/> (<strong><?=number_format($h->scr_total_score)?></strong>)
                                        <?php $total_qa += $h->scr_total_score  ?>
                                        <hr style="margin:5px" />

                                        <div class="btn-group">
                                            <a href="<?=base_url()?>grading/edit_score/<?=$subj_id.'/'.$h->scr_id?>" type="button" class="btn btn-primary btn-xs btn-block">Edit</a>
                                            <a href="#" data-id="<?=$h->scr_id?>" type="button" class="btn btn-danger btn-xs btn-block delete">Delete</a>
                                        </div>

                                    </th>
                                <!-- END QUARTERLY ASSESSMENT -->

                                    
                                <?php endforeach; ?>
                                 <th class="text-center vmiddle" style="background-color: #ea2474; color: #fff; width:5%"><small>TOTAL</small> <br/> (<strong><?=$total_qa?></strong>)</th>
                                 <th class="text-center vmiddle" style="background-color: #ea2474; color: #fff; width:5%" >PS <br/> </th>
                                 <th class="text-center vmiddle" style="background-color: #ea2474; color: #fff; width:5%" >WS <br/><strong>(<?=$ca_qa_percentage?>%)</strong><br/> </th>

                                 <th class="bold text-center vmiddle">INITIAL GRADE</th>
                                 <th class="bold text-center vmiddle">FINAL GRADE</th>
                            </tr>

                            <?php 
                                $cnt = 1;
                                foreach($student->result() as $k):
                            ?>
                                <tr>
                                    <td class="text-center vmiddle"><?=$cnt++?></td>
                                    <td class="vmiddle"><h5 class="m-0"><strong><?=$k->stud_lastname.'</strong>, '.$k->stud_firstname.' '.substr($k->stud_middlename,0, 1) ?><?= !empty($k->stud_middlename)?'.':''?></h5>
                                    </td>

                                    <?php 
                                        $total_ww_st = 0;
                                        $total_pt_st = 0;
                                        $total_qa_st = 0;

                                        $initial_grade = 0;
                                        $final_grade = 0;

                                        $total_ww_st_cnt = 0;
                                        $total_pt_st_cnt = 0;
                                        $total_qa_st_cnt = 0;

                                        $total_all_cnt = 0;

                                        $weighted_score_ww = 0;
                                        $weighted_score_pt = 0;
                                        $weighted_score_qa = 0;


                                        $hdrs  = $this->module->get_query("SELECT * FROM v_student_score WHERE subj_id = ".$subj_id." AND scr_type = 'WW' AND stud_id=".$k->stud_id." ");
                                        foreach($hdrs->result() as $d):
                                    ?>

                                    <td class="text-center vmiddle" ><?=$d->sscr_score?></td>
                                        <?php 
                                            $total_ww_st += $d->sscr_score;
                                            $total_ww_st_cnt++;
                                        ?>
                                    <?php endforeach; ?>
                                    <td class="text-center bold" ><?=$total_ww_st?></td>
                                    <td class="text-center bold" ">
                                        <?php 
                                            if($total_ww_st > 0){
                                                $percentage_score = intval($total_ww_st) / intval($total_ww) * 100; 
                                                echo number_format(round($percentage_score,2),2);
                                            }else{
                                                echo 0;
                                            }
                                        ?>
                                            
                                    </td>

                                    <td class="text-center bold" style="background-color: #009987; color: #fff; ">
                                        <?php 
                                            if($total_ww_st > 0){
                                                $weighted_score_ww = $percentage_score * (intval($ca_ww_percentage) / 100 );
                                                echo number_format(round($weighted_score_ww,2),2);
                                            }else{
                                                echo 0;
                                            }
                                        ?>
                                            
                                    </td>

                                    <?php 
                                        $hdrs  = $this->module->get_query("SELECT * FROM v_student_score WHERE subj_id = ".$subj_id." AND scr_type = 'PT' AND stud_id=".$k->stud_id." ");
                                        foreach($hdrs->result() as $d):
                                    ?>

                                    <td class="text-center vmiddle" ><?=$d->sscr_score?></td>
                                        <?php $total_pt_st += $d->sscr_score  ?>

                                    <?php endforeach; ?>
                                    <td class="text-center bold"><?=$total_pt_st?></td>
                                    <td class="text-center bold" ">
                                        <?php 
                                            if($total_pt_st > 0){
                                                $percentage_score = intval($total_pt_st) / intval($total_pt) * 100; 
                                                echo number_format(round($percentage_score,2),2);
                                            }else{
                                                echo 0;
                                            }
                                        ?>
                                            
                                    </td>

                                    <td class="text-center bold" style="background-color: #b167c4; color: #fff; ">
                                        <?php 
                                            if($total_pt_st > 0){
                                                $weighted_score_pt = $percentage_score * (intval($ca_pt_percentage) / 100 );
                                                echo number_format(round($weighted_score_pt,2),2);
                                            }else{
                                                echo 0;
                                            }
                                        ?>
                                            
                                    </td>

                                    
                                    <?php 
                                        $hdrs  = $this->module->get_query("SELECT * FROM v_student_score WHERE subj_id = ".$subj_id." AND scr_type = 'QA' AND stud_id=".$k->stud_id." ");
                                        foreach($hdrs->result() as $d):
                                    ?>
                        
                                    <td class="text-center vmiddle"><?=$d->sscr_score?></td>
                                        <?php $total_qa_st += $d->sscr_score;?>

                                    <?php endforeach; ?>
                                    <td class="text-center bold"><?=$total_qa_st?></td>
                                    <td class="text-center bold" ">
                                        <?php 

                                            if($total_qa_st > 0){
                                                $percentage_score = intval($total_qa_st) / intval($total_qa) * 100; 
                                                echo number_format(round($percentage_score,2),2);
                                            }else{
                                                echo  0;
                                            }
                                            
                                        ?>
                                            
                                    </td>

                                    <td class="text-center bold" style="background-color: #ea2474; color: #fff; ">
                                        <?php 
                                            if($total_qa_st > 0){
                                                $weighted_score_qa = $percentage_score * (intval($ca_qa_percentage) / 100 );
                                                echo number_format(round($weighted_score_qa,2),2);
                                            }else{
                                                echo 0;
                                            }
                                        ?>
                                            
                                    </td>

                                    
                                    <td class="text-center ">
                                        <h5 class=" m-0">
                                            <?php 
                                                $initial_grade = $weighted_score_ww  + $weighted_score_pt + $weighted_score_qa;

                                                echo number_format(round($initial_grade,2),2);
                                            ?>
                                                
                                        </h5> 
                                    </td>

                                    <td class="text-center bold">
                                        <h5 class="bold m-0">
                                            <?php 
                                                $q = $this->module->get_query("SELECT * FROM grade_transmutation WHERE gt_min <= ".$initial_grade." AND gt_max >= ".$initial_grade." ");

                                                $final_grade = $q->row('gt_grade');

                                                echo number_format(round($final_grade,2),2);
                                            ?>
                                                
                                        </h5> 
                                    </td>
                                </tr>
                            <?php 
                                $cnt++; 
                                endforeach;  ?>


                        </tbody>
                    </table>  

                   
                </div>
            </div>

        </div>



    </div><!---END MAIN CONTENT -->
</div> <!-- end of body container -->


<?= $this->load->view('inc/js')?>
<script type="text/javascript" charset="utf-8">
  $(document).ready(function() {
        $(document.body).on("click",".delete",function(e){
            e.preventDefault();
            var scr_id = $(this).data('id');

            $.ajax({url: base_url+'grading/delete_score/'+scr_id, success: function(result){
                //tr.fadeOut(1000);
                window.setTimeout(function(){location.reload()},1000);
            }});
            
            //var tr  = $(this).closest('td');
            //tr.find('delete').fadeOut();


        });

  });
</script>
</body>
</html>