<?php 

    
  $usr_name       = $this->session->userdata('usr_name');
  $usr_type       = $this->session->userdata('usr_type');
  $usr_firstname  = $this->session->userdata('usr_firstname');
  $usr_lastname   = $this->session->userdata('usr_lastname');
  $usr_is_login   = $this->session->userdata('usr_is_login');
  $tch_id         = $this->session->userdata('tch_id');
  $sy_id          = $this->module->get_active_sy();

  $where           = 'tch_id = "'.$tch_id.'"  AND sy_id = "'.$sy_id.'" ';



  if( ($usr_type <> 'Faculty') || empty($tch_id) ){
    header('Location: '.base_url());
  }

  if(empty($subj_id)){
    header('Location: '.base_url().'grading');
  }

?>


<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <title><?= $title;?></title>

    <?= $this->load->view('inc/css')?>

</head>
<body class="page-body gray">

<div class="page-container  horizontal-menu sidebar-collapsed"><!-- add class "sidebar-collapsed" to close sidebar by default, "chat-visible" to make chat appear always -->
    <header class="navbar navbar-fixed-top"><!-- set fixed position by adding class "navbar-fixed-top" table-responsive -->
        
        <div class="navbar-inner">
            <?=$this->load->view('inc/topbar');?>
        </div>
    </header>

    <div class="main-content">
        
        <?php 
            $subj_id        = ''; 
            $lvl_id         = '';  
            $sec_id         = '';  
            $tch_id         = '';  
            $sy_id          = ''; 
            $sub_id         = '';  
            $subj_det_id    = '';  
            $lvl_name       = ''; 
            $lvl_color      = '';      
            $sec_name       = '';   
            $dept_name      = '';          
            $sub_name       = ''; 

            foreach ($subj_assignment->result() as $r) {
                $subj_id        = $r->subj_id ; 
                $lvl_id         = $r->lvl_id ;  
                $sec_id         = $r->sec_id ;  
                $tch_id         = $r->tch_id ;  
                $sy_id          = $r->sy_id ; 
                $sub_id         = $r->sub_id ;  
                $subj_det_id    = $r->subj_det_id ;  
                $lvl_name       = $r->lvl_name ; 
                $lvl_color      = $r->lvl_color ;      
                $sec_name       = $r->sec_name ;   
                $dept_name      = $r->dept_name ;          
                $sub_name       = $r->sub_name ;
                $subj_det       = $this->module->get_query("SELECT subj_det_name FROM subject_detail WHERE subj_det_id =".$subj_det_id." ");  
            } 

              $subj_det_name  = $subj_det->row('subj_det_name');
              
              if( $subj_det->num_rows() > 0){
                  $subj_det_name =  '<small class="text-white"> | '.$subj_det_name.'</small>';
              }else{
                  $subj_det_name = '';
              }

              $student          = $this->module->get_query("SELECT * FROM v_section_assignment WHERE  sy_id = ".$sy_id." AND sec_id = ".$sec_id." ORDER BY stud_lastname, stud_firstname");
              $score_hdr_ww     = $this->module->get_query("SELECT * FROM student_score_hdr WHERE subj_id = ".$subj_id." AND scr_type = 'WW' ORDER BY scr_id");
              $score_hdr_pt     = $this->module->get_query("SELECT * FROM student_score_hdr WHERE subj_id = ".$subj_id." AND scr_type = 'PT' ORDER BY scr_id");
              $score_hdr_qa     = $this->module->get_query("SELECT * FROM student_score_hdr WHERE subj_id = ".$subj_id." AND scr_type = 'QA' ORDER BY scr_id");

        ?>

        <div class="row">
            <div class="col-md-12 ">
                <div class="panel panel-primary" >
                    <div class="panel-heading" style="background: #<?=$lvl_color ?>; color: #fff; padding:15px">
                        <div class="row">
                            <div class="col-md-3">
                                <h2 class=" text-white m-0 "><?=$sub_name?> <?=$subj_det_name?></h2>
                                <h3 class=" text-white m-0">
                                    
                                </h3>
                            </div>

                            <div class="col-md-6 text-center">
                                <h1 class=" text-white m-0 bold">CLASS RECORD</h1>
                            </div>

                            <div class="col-md-3 text-right">
                                <h4 class="text-white m-0 bold"> <?= $lvl_name .' - '.$sec_name?> </h4>
                                <p class="m-0"><?=$dept_name?></p>
                            </div>
                        </div>
                    </div>

                    <div class="panel-body">
                        <div class="row">
                            <div class="col-md-12 text-right">

                                <div class="btn-group">
                                    <a href="<?=base_url()?>grading/add_score/<?=$subj_id?>" class="btn btn-green"><i class="fa fa-plus"></i> Record Score </a>
                                    <button type="button" class="btn btn-primary">Export to Excel</button>
                                </div>
                                
                            </div>
                        </div>

                        <br/>

                        <div class="table-wrapper">
                            <div class="table-scroll">
                                <table class="table responsive table-condensed table-bordered">
                                    
                                    <tbody>
                                        <tr>
                                            <td class="text-center bold widtd-3 vmiddle" >No.</td>
                                            <td class="bold vmiddle">Learners Name</td>
                                        <?php 
                                            $cnt = 1;
                                            foreach ($score_hdr_ww->result() as $k):?>
                                                <td class="text-center">
                                                    
                                                    <small><?=$cnt++?><br/>
                                                    <?=$k->scr_sub_type?></small><br/>
                                                    <strong>(<?=$k->scr_total_score?>)</strong>
                                                    <br/><?=$k->scr_id?>
                                                </td>
                                        <?php endforeach; ?>
                                        </tr>

                                        <?php 
                                            $cnt            = 1;
                                            $stud_gender    = '';

                                            foreach($student->result() as $r): 
                                                $stud_gender = $r->stud_gender;

                                               // if($stud_gender == 'Male' ):
                                        ?>

                                        <tr>
                                           <td class="text-center vmiddle" > <span class="badge badge-roundless" style="background-color:#004d7f; color:#fff"><?=$cnt?></span></td>
                                           <td class="vmiddle" style="width:300;">
                                            <h5 class="m-0">
                                               <strong ><?=$r->stud_lastname.'</strong>, '.$r->stud_firstname.' '.substr($r->stud_middlename,0, 1) ?><?= !empty($r->stud_middlename)?'.':''?>
                                            </h5>
                                          </td>

                                            <?php 
                                            foreach ($score_hdr_ww->result() as $k):
                                                $scr_id = $k->scr_id;
                                                $score  = $this->module->get_query("SELECT * FROM v_student_score_absent WHERE scr_id = ".$scr_id." AND scr_type = 'WW' AND stud_id=".$r->stud_id." ");

                                                if($score->num_rows() > 0 ):

                                                foreach ($score->result() as $sc):
                                                    $sscr_absent = $sc->sscr_absent;
                                            ?>

                                                <td class="text-center"> 
                                                    <?php 
                                                        if($sscr_absent == 'Y'):
                                                            echo 'A';
                                                        else:
                                                    ?>
                                                    <?= empty($sc->sscr_score) ? 'NS': $sc->sscr_score ?>
                                                    <?php endif; ?>
                                                </td>

                                                <?php endforeach; 
                                                else: ?>
                                                <td class="text-center bold"  style="background-color:#<?=$lvl_color?>; color:#fff" >NS</td>
                                                <?php endif; ?>

                                          <?php endforeach; ?>


                                          <?php 
                                            foreach ($score_hdr_ww->result() as $k):
                                                $scr_id = $k->scr_id;
                                                $score  = $this->module->get_query("SELECT * FROM v_student_score_absent WHERE scr_id = ".$scr_id." AND scr_type = 'PT' AND stud_id=".$r->stud_id." ");

                                                if($score->num_rows() > 0 ):

                                                foreach ($score->result() as $sc):
                                                    $sscr_absent = $sc->sscr_absent;
                                            ?>

                                                <td class="text-center"> 
                                                    <?php 
                                                        if($sscr_absent == 'Y'):
                                                            echo 'A';
                                                        else:
                                                    ?>
                                                    <?= empty($sc->sscr_score) ? 'NS': $sc->sscr_score ?>
                                                    <?php endif; ?>
                                                </td>

                                                <?php endforeach; 
                                                else: ?>
                                                <td class="text-center bold"  style="background-color:#<?=$lvl_color?>; color:#fff" >NS</td>
                                                <?php endif; ?>

                                          <?php endforeach; ?>

                                          <?php 
                                            foreach ($score_hdr_ww->result() as $k):
                                                $scr_id = $k->scr_id;
                                                $score  = $this->module->get_query("SELECT * FROM v_student_score_absent WHERE scr_id = ".$scr_id." AND scr_type = 'QA' AND stud_id=".$r->stud_id." ");

                                                if($score->num_rows() > 0 ):

                                                foreach ($score->result() as $sc):
                                                    $sscr_absent = $sc->sscr_absent;
                                            ?>

                                                <td class="text-center"> 
                                                    <?php 
                                                        if($sscr_absent == 'Y'):
                                                            echo 'A';
                                                        else:
                                                    ?>
                                                    <?= empty($sc->sscr_score) ? 'NS': $sc->sscr_score ?>
                                                    <?php endif; ?>
                                                </td>

                                                <?php endforeach; 
                                                else: ?>
                                                <td class="text-center bold"  style="background-color:#<?=$lvl_color?>; color:#fff" >NS</td>
                                                <?php endif; ?>

                                          <?php endforeach; ?>


                                        </tr>

                                        <?php
                                            $cnt++;   
                                            //endif; 
                                            endforeach; ?>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
         
        </div>
    </div>

    
</div> <!-- end of body container -->


<?= $this->load->view('inc/js')?>
<script type="text/javascript" charset="utf-8">
  $(document).ready(function() {
       

  });
</script>
</body>
</html>