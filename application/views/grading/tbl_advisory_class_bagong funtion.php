
        <?php 
            $sec_name       = '';
            $lvl_name       = '';
            $lvl_id         = '';
            $sec_teacher    = '';
            $dept_name      = '';
            $lvl_color      = '';

            $sy_id          = $this->module->get_active_sy();
            $sec_id         = $sec_id;
            //$quarter        = $this->module->table_where('quarter', array('qtr_active' => 'Y'));
            $qtr_code       = $this->uri->segment(4);
            $controller     = $this->uri->segment(1);

            if($section->num_rows() > 0){
                foreach($section->result() as $r){
                    $lvl_id         = $r->lvl_id;
                    $lvl_name       = $r->lvl_name;
                    $sec_name       = $r->sec_name;
                    $sec_teacher    = $r->sec_teacher;
                    $dept_name      = $r->dept_name;
                    $lvl_color      = $r->lvl_color;
                }
            }
        ?>
        

        <div class="row">
            <div class="col-md-12 ">
                <div class="panel panel-primary " >
                    <div class="panel-heading" style="padding:20px 20px">
                        <div class="row">
                            <div class="col-md-9">
                                <h1 class="m-0 bold" style="color:#<?=$lvl_color?>"><?=$sec_name?></h1>
                                <h4 class="m-0"><?= '<strong>'.$lvl_name .'</strong> | '.$dept_name.' Department' ?></h4>
                                <h5 class="m-0"><strong><?=$sec_teacher?></strong> <small> | Class Adviser</small> </h5>
                                <h4 class="m-0">School Year <?= $this->module->get_active_sy_name()?></h4>
                            </div>

                            <div class="col-md-3 text-right">
                                <select class="form-control selectboxit"  id="quarter"  onchange= "location = this.value" > 
                                    <?php  
                                      $quarters      = $this->module->get_table('quarter');
                                      foreach($quarters->result() as $q): ?>
                                      <option value="<?=base_url().$controller.'/advisory_class/'.$sec_id.'/'.$q->qtr_code?>" <?=($qtr_code==$q->qtr_code ?  'selected="" ' : '' )?> ><?=$q->qtr_name?></option>
                                    <?php endforeach; ?>
                                </select>

                                <br/>
                                <div class="text-right">
                                    <div class="btn-group">
                                        <a href="<?=base_url()?>grading/print_report_card/<?=$sec_id.'/'.$qtr_code?>" class="btn btn-blue "><i class="fa fa-print"></i> Print Report Card</a>
                                        <a href="<?=base_url()?>grading/print_advisory_class/<?=$sec_id.'/'.$qtr_code?>" class="btn btn-primary "><i class="fa fa-print"></i> Print Advisory Class</a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="panel-body">
                        

                        <div class="table-wrapper">
                            <div class="table-scroll">
                                <table class="table-custom table-bordered" id="data">
                                    <thead>
                                        <th class="text-center bold">No.</th>
                                        <th  style="width:25%" class="text-center bold"> Learners Name</th>

                                        <?php 
                                            $subject  = $this->module->getTableSort('subject', 'sub_sort');
                                                foreach ($subject->result() as $r):
                                                    $sub_name   = $r->sub_name;
                                                    $sub_id     = $r->sub_id;
                                                ?>
                                                   <th class="text-center  vmiddle width-5 bold">
                                                    <?=$sub_name?> 
                                                   </th>
                                                    
                                                    <?php 
                                                    $subject_detail = $this->module->table_where('subject_detail', array('sub_id' => $sub_id));
                                                    
                                                    foreach($subject_detail->result() as $s):
                                                        $subj_det_name = $s->subj_det_name;
                                                    ?>

                                                    <th class=" vbottom text-center bold" style="width:10px;">
                                                       <small> <?=$subj_det_name?></small>
                                                    </th>

                                                <?php endforeach; ?>
                                        <?php endforeach; ?>

                                        <th class="text-center vmiddle width-5 bold">Average</th>
                                        <th class="text-center vmiddle width-5 bold">Lowest</th>
                                        <th class="text-center vmiddle width-15 bold">Award</th>
                                    </thead>

                                    <tbody>

                                        <?php 
                                            $cnt            = 1;
                                            $disq_grade     = array();
                                            $average_array  = array();
                                            

                                            foreach($student_data as $d):
                                                $stud_id    = $d['stud_id'];
                                                $stud_name  = $d['stud_name'];
                                                $grades     = $d['subjects'];
                                        ?>
                                            <tr class="me">
                                                <td class="text-center vmiddle td" ><?=$cnt++?></td>
                                                <td class="vmiddle td name">
                                                    <h5 class="m-0"><?=$stud_name?></h5>
                                                </td>

                                                <?php 

                                                $average            = 0;
                                                $average_divider    = 0;
                                                $final_average      = 0;

                                                $sub_grades = array();
                                                

                                                foreach ($subject->result() as $r):
                                                    $sub_name   = $r->sub_name;
                                                    $sub_id     = $r->sub_id;

                                                    $subject_detail = $this->module->table_where('subject_detail', array('sub_id' => $sub_id));
                                                ?>

                                                <td class="text-center vmiddle td ">
                                                    <?php 
                                                        $grade      = 0;
                                                        $divider    = 0;
                                                        $gg         = 0;

                                                        foreach($grades as $g){
                                                            $gsub_id        = $g['sub_id'];
                                                            $gsub_name      = $g['sub_name'];
                                                            $gsubj_det_id   = $g['subj_det_id'];

                                                            if( ($gsub_id == $sub_id) ){
                                                                if(($gsubj_det_id == 0)){
                                                                    $grade = $g['grade'];

                                                                }else{
                                                                    $gg  += $g['grade'];
                                                                    $divider ++;
                                                                    $grade = round(($gg / $divider));
                                                                }

                                                                
                                                            }
                                                        } 
                                                        
                                                        //push to disqualifying grade
                                                        if($grade <> 0){
                                                            array_push($sub_grades,  $grade );
                                                        }

                                                        $average_divider ++;
                                                        $average += $grade;
                                                        echo ($grade == 0 || empty($grade) )? '--' : $grade;  


                                                    ?>
                                                </td>
                                                       

                                                    <?php 
                                                    foreach($subject_detail->result() as $s):
                                                        $subj_det_id    = $s->subj_det_id;
                                                        $subj_det_name = $s->subj_det_name;
                                                    ?>

                                                        <td class="text-center vmiddle td ">
                                                            <?php 
                                                                $grade = 0;
                                                                foreach($grades as $g){
                                                                    $gsub_id        = $g['sub_id'];
                                                                    $gsub_name      = $g['sub_name'];
                                                                    $gsubj_det_id   = $g['subj_det_id'];


                                                                    if( ($gsub_id == $sub_id) && ($gsubj_det_id == $subj_det_id) ){
                                                                        $grade = $g['grade'];
                                                                        

                                                                        if(strtolower($gsub_name) <> 'english'){
                                                                            //push to disqualifying grade
                                                                            if($grade <> 0){
                                                                                array_push($sub_grades,  $grade );
                                                                            }
                                                                            
                                                                        } 
                                                                    }
                                                                } 

                                                                if($grade <= 0){
                                                                    echo '--';
                                                                } else{
                                                                    echo $grade;
                                                                }                                                          
                                                            ?>
                                                        </td>

                                                    <?php endforeach; ?>
                                                <?php endforeach; ?>

                                                <td class="text-center vmiddle td text-danger">
                                                    <?php 
                                                        $final_average =  round( ($average / ($average_divider-1)), 2);
                                                        echo number_format($final_average, 2);

                                                        array_push($average_array,  array( 'stud_id' => $stud_id, 'final_average' =>  $final_average) );
                                                    ?>
                                                </td>

                                                <td class="text-center vmiddle td">
                                                    <?php 
                                                        //get the lowest grades
                                                        if(!empty($sub_grades)){
                                                            $min_grade  = 0;
                                                            $min        = min($sub_grades);
                                                            $min_grade  = $min;
                                                            echo $min_grade;
                                                        }
                                                       
                                                            
                                                    ?>

                                                </td>
                                                <td class="text-center vmiddle td">
                                                    <?php 
                                                        $award = '---';
                                                        $ave = floor($final_average);

                                                        if( ($ave >=98 && $ave <=100) && ($min_grade >= 97) ){
                                                            $award = 'With Highest Honors';                                                                                         
                                                        }else if( ($ave >=95 && $ave <=97) && ($min_grade >= 94) ){
                                                            $award = 'With High Honors';
                                                        }else if( ($ave >=90 && $ave <=94) && ($min_grade >= 90) ) {
                                                            $award = 'With Honors';
                                                        }else{
                                                            $award = $award;
                                                        }


                                                       /* if($ave >=98 && $ave <=100 ){
                                                            if($min_grade >= 97){
                                                                $award = 'With Highest Honors';  
                                                            }else if($min_grade > 94){
                                                                $award = 'With High Honors';
                                                            }else if ($min_grade >= 90){
                                                                $award = 'With Honors';
                                                            }                                                                                             
                                                        }else if($ave >=95 && $ave <=97){
                                                            if($min_grade >= 97){
                                                                $award = 'With Highest Honors';  
                                                            }else if($min_grade > 94){
                                                                $award = 'With High Honors';
                                                            }else if ($min_grade >= 90){
                                                                $award = 'With Honors';
                                                            }  
                                                        }else if($ave >=90 && $ave <=94) {
                                                            if($min_grade >= 97){
                                                                $award = 'With Highest Honors';  
                                                            }else if($min_grade > 94){
                                                                $award = 'With High Honors';
                                                            }else if ($min_grade >= 90){
                                                                $award = 'With Honors';
                                                            }  
                                                        }else{
                                                            $award = $award;
                                                        }*/


                                                       /* if(($ave >=98 && $ave <=100) && ($min_grade >= 97) ){
                                                            $award = 'With Highest Honors';                                   
                                                        }else if(($ave >=95 && $ave <=97) &&($min_grade >= 94)){
                                                            $award = 'With High Honors';
                                                        }else if(($ave >=90 && $ave <=94) && ($min_grade >= 90)){
                                                            $award = 'With Honors';
                                                        }else{
                                                            $award = $award;
                                                        }*/

                                                        echo $award;

                                                    ?>
                                                </td>
                                            </tr>


                                            
                                        <?php endforeach; ?>
                                        
                                        
                                    </tbody>
                                </table>
                            </div>
                                
                        </div>

                    </div>
                </div>
            </div>
        </div>
