<?php 

$sec_name       = '';
$lvl_name       = '';
$sec_teacher    = '';
$dept_name      = '';
$lvl_color      = '';

$sy_id          = $this->module->get_active_sy();
$sec_id         = $sec_id;
$qtr_code       = $this->uri->segment(4);


if($section->num_rows() > 0){
    foreach($section->result() as $r){
        $lvl_name       = $r->lvl_name;
        $sec_name       = $r->sec_name;
        $sec_teacher    = $r->sec_teacher;
        $dept_name      = $r->dept_name;
        $lvl_color      = $r->lvl_color;
    }
}


header('Content-Description: File Transfer');
header('Content-Type: application/octet-stream');
header('Content-Disposition: attachment; filename="Rating Sheet ('.$sec_name.').xls', date( 'd m Y' ));
header('Content-Transfer-Encoding: binary');
header('Expires: 0');
header('Cache-Control: must-revalidate, post-check=0, pre-check=0');
header('Pragma: public');
echo "\xEF\xBB\xBF"; // UTF-8 BOM

?>

<style type="text/css">
  .text-center{
    text-align: center !important;
  }

  .text-danger{
    color: #ff6c60;
  }

  table {
    border-collapse: collapse;
  }


  table, th, td {
    border: thin solid #373e4a;
    padding:2px 10px;
  }

  td{
    text-align: left !important;
  }

  td.green{
    color: white !important;
      background-color: #109618 !important;
  }

  td.orange{
    color: white !important;
      background-color: #FF9900 !important;
  }

  .text-left{
    text-align: left !important;
  }

  .text-right{
    text-align: right !important;
  }

  .text-center{
    text-align: center !important;
  }

</style>

<div class="row">
<div class="main-content">
        
        

        <div class="row">
            <div class="col-md-12 ">
                <div class="panel panel-primary " >
                    <div class="panel-heading" style="padding:30px 20px">
                        <div class="row">
                                <span style="font-size: 20px; font-weight: bold;">RATING SHEET |  <?= $lvl_name .' - '.$sec_name.' '?></span><br/>
                        </div>
                    </div>

                    <div class="panel-body">
                        <table class="table-custom table-bordered" id="data">
                        <thead>
                            <tr>
                                <th class="text-center " style="font-size:10px ;">No.</th>
                                <th style="width:50%; font-size: 12px;"  class="text-center "> &nbsp;&nbsp; Learners Name</th>
                                <?php 
                                    $subject  = $this->module->getTableSort('subject', 'sub_sort');

                                        foreach ($subject->result() as $r):
                                            $sub_name   = $r->sub_name;
                                            $sub_id     = $r->sub_id;

                                            $check_subject = $this->module->table_where('subject_assignment', array('sub_id' => $sub_id, 'sec_id' => $sec_id));
                                            if($check_subject->num_rows() > 0):
                                        ?>

                                           <th class="text-center vmiddle  width-5 "   colspan="5"   style="word-wrap: break-word;">
                                           <?=$sub_name?> 
                                           </th>
                                            
                                            <?php 
                                                $subject_detail = $this->module->table_where('subject_detail', array('sub_id' => $sub_id));                                                        
                                                foreach($subject_detail->result() as $s):
                                                    $subj_det_name = $s->subj_det_name;
                                            ?>

                                                <th class="text-center vmiddle  width-5"   colspan="5" style="word-wrap: break-word;">
                                                   <?=$subj_det_name?>
                                                </th>

                                            <?php endforeach; ?>
                                        <?php endif; ?>
                                <?php endforeach; ?>
                                
                                <th class="bold text-center" style="font-size:10px">
                                     Average
                                </th>

                                <th class="bold text-center" style="font-size:10px">
                                    Average
                                </th>

                            </tr>
                            <tr>
                                <th colspan="2"></th>
                                <?php 
                                    $subject  = $this->module->getTableSort('subject', 'sub_sort');

                                        foreach ($subject->result() as $r):
                                            $sub_name   = $r->sub_name;
                                            $sub_id     = $r->sub_id;

                                            $check_subject = $this->module->table_where('subject_assignment', array('sub_id' => $sub_id, 'sec_id' => $sec_id));
                                            if($check_subject->num_rows() > 0):
                                        ?>
                                        
                                                <?php foreach($quarters->result() as $q) :
                                                    $qtr_code = $q->qtr_code;
                                                ?>
                                                    <th class="text-center vmiddle bold" style="background-color: #fff; "><?=$qtr_code?></th>
                                                <?php endforeach; ?>
                                               <!--  <th></th> -->
                                               <th class="text-center  vmiddle bold " style="background-color: #0073b7 ; color: #fff;">FG</th>
                                            
                                            <?php 
                                                $subject_detail = $this->module->table_where('subject_detail', array('sub_id' => $sub_id));                                                        foreach($subject_detail->result() as $s):
                                                    $subj_det_name = $s->subj_det_name;
                                            ?>

                                                <?php foreach ($quarters->result() as $q) :
                                                    $qtr_code = $q->qtr_code;
                                                ?>
                                               <th class="text-center  vmiddle bold" ><?=$qtr_code?></th>

                                                <?php endforeach; ?>
                                                <!-- <th></th> -->
                                                <th class="text-center  vmiddle bold " style="background-color: #008d4c ; color: #fff;">FG</th>

                                            <?php endforeach; ?>
                                        <?php endif; ?>
                                <?php endforeach; ?>
                                <th></th>
                            </tr>
                        </thead>

                        <tbody>
                            <?php 
                                $cnt=1;
                                foreach($student_data as $d):
                                    $stud_id    = $d['stud_id'];
                                    $stud_name  = $d['stud_name'];

                                    $final_average = 0;
                                    $final_count   = 0;
                            ?>
                                <tr class="me">
                                    <td class="text-center vmiddle td" ><small><?=$cnt++?></small></td>
                                    <td class="vmiddle td name">
                                        &nbsp;&nbsp;<?=$stud_name?>
                                    </td>

                                    <?php foreach ($subject->result() as $r):
                                        $sub_name   = $r->sub_name;
                                        $sub_id     = $r->sub_id;

                                        $check_subject = $this->module->table_where('subject_assignment', array('sub_id' => $sub_id, 'sec_id' => $sec_id));
                                        if($check_subject->num_rows() > 0):
                                    ?>

                                            <?php 
                                                $fg     = 0;
                                                $fg_div = 0;



                                                foreach ($quarters->result() as $q) :
                                                $qtr_code = $q->qtr_code;

                                                $final_grade = 0;

                                                foreach($student_data as $g):
                                                    $gstud_id   = $g['stud_id'];
                                                    $gsubjects  = $g['subjects'];

                                                    if($gstud_id == $stud_id):
                                                        foreach($gsubjects as $h):
                                                            $hsub_id    = $h['sub_id'];
                                                            $hquarter   = $h['quarter'];

                                                            if($hsub_id == $sub_id):

                                                                foreach($hquarter as $qr):
                                                                    $qrqtr_code = $qr['qtr_code'];
                                                                    $qrfinal_grade = $qr['final_grade'];

                                                                    if( $qrqtr_code == $qtr_code):?>
                                                                       <td class="text-center  vmiddle" >
                                                                            <small>
                                                                           <?=empty($qrfinal_grade) ? '' : $qrfinal_grade?>
                                                                            
                                                                            <?php 
                                                                                $final_grade = $qrfinal_grade;
                                                                                $fg += $final_grade;
                                                                                $fg_div ++;
                                                                            ?>
                                                                            </small>
                                                                       </td>
                                                                    <?php endif; ?>

                                                               <?php endforeach; ?>

                                                            <?php endif; ?>

                                                       <?php endforeach; ?>

                                                    <?php endif; ?>

                                                <?php endforeach; ?>
                                            <?php endforeach; ?> <!-- end quarter -->
                                            <!-- <th style="border-width: medium;"></th> -->
                                            <td class="text-center  vmiddle bold " style="background-color: #0073b7 ; color: #fff;">
                                               
                                                <?php  
                                                    $subject_average = round(($fg / $fg_div));
                                                    echo $subject_average;
                                                    

                                                    $final_average += $subject_average;
                                                    $final_count ++;
                                                ?>
                                                
                                            </td>
                                                
                                                <?php 
                                                    

                                                    $subject_detail = $this->module->table_where('subject_detail', array('sub_id' => $sub_id));
                                                    foreach($subject_detail->result() as $s):
                                                        $subj_det_name  = $s->subj_det_name;
                                                        $subj_det_id    =  $s->subj_det_id;
                                                ?>

                                                    <?php 
                                                        $fg_det     = 0;
                                                        $fg_det_div = 0;

                                                        foreach ($quarters->result() as $q) :
                                                        $qtr_code = $q->qtr_code;
                                                    ?>
                                                    <td class="text-center  vmiddle" >
                                                        <small>
                                                        <?php 

                                                        foreach($student_data as $g):
                                                            $gstud_id   = $g['stud_id'];
                                                            $gsubjects  = $g['subjects'];

                                                            if($gstud_id == $stud_id):
                                                                foreach($gsubjects as $h):
                                                                    $hsub_id    = $h['sub_id'];
                                                                    $hquarter   = $h['quarter'];

                                                                    if($hsub_id == $sub_id):

                                                                        foreach($hquarter as $qr):
                                                                            $qrqtr_code = $qr['qtr_code'];
                                                                            $qrfinal_grade = $qr['final_grade'];
                                                                            $qrquarterly_grade = $qr['quarterly_grade']; 

                                                                            if( $qrqtr_code == $qtr_code):

                                                                                foreach($qrquarterly_grade as $qg):
                                                                                    $qgsub_id       = $qg['sub_id'];
                                                                                    $qgsubj_det_id  = $qg['subj_det_id'];
                                                                                    $qggrade        = $qg['grade'];

                                                                                    if($qgsubj_det_id == $subj_det_id):
                                                                            ?>
                                                                                        <?= (empty($qggrade) || $qggrade <= 0 ) ? '' : $qggrade?>
                                                                                        <?php 
                                                                                            $fg_det += $qggrade;
                                                                                        ?>

                                                                                    <?php endif; ?>
                                                                                <?php endforeach; ?>
                                                                            <?php endif; ?>

                                                                       <?php endforeach; ?>

                                                                    <?php endif; ?>

                                                               <?php endforeach; ?>

                                                            <?php endif; ?>
                                                            
                                                        <?php endforeach; ?>
                                                        </small>
                                                    </td>

                                                                   
                                                    <?php endforeach; ?>
                                                       <!--  <th style="border-width: medium; "></th> -->
                                                       <td class="text-center  vmiddle bold " style="background-color: #008d4c ; color: #fff;">
                                                           <?= round($fg_det / $fg_div)?>
                                                       </td>
                                                <?php endforeach; ?>
                                            <?php endif; ?>
                                    <?php endforeach; ?>

                                    <td class="text-center vmiddle bold text-danger bold">
                                        <?php 
                                           echo  number_format( ($final_average/$final_count) ,3);
                                        ?>
                                    </td>

                                    <td class="text-center vmiddle bold text-danger bold">
                                        <?php 
                                           echo round( ($final_average/$final_count) );
                                        ?>
                                    </td>


                                    
                                </tr>
                            <?php endforeach;?>
                        </tbody>
                       
                    </table>

                    </div>
                </div>
            </div>
         
        </div>
    </div>
        

</div>


<?php 



//header('Content-Type:application/xls');
//header("Content-Disposition:attachment; filename=ExportClassList.xls");
?>
