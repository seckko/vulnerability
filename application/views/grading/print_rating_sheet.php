<!DOCTYPE html>
<html lang="en">
<?= $this->load->view('inc/css')?>
<link rel="stylesheet" href="<?php echo base_url()?>asset/css/print.css">
<link rel="stylesheet" href="<?php echo base_url()?>asset/css/print_media10.css">
<body class="page-body"  onload="window.print()"   > <!-- onload="window.print()"   onload="window.print()" onafterprint="goback()" --> 

<div class="page-container horizontal-menu">

	<div class="main-content">

	        <?php 
	            $sec_name       = '';
	            $lvl_name       = '';
	            $sec_teacher    = '';
	            $dept_name      = '';
	            $lvl_color      = '';

	            $sy_id          = $this->module->get_active_sy();
	            $sec_id         = $sec_id;
                $qtr_code       = $this->uri->segment(4);


	            if($section->num_rows() > 0){
	                foreach($section->result() as $r){
	                    $lvl_name       = $r->lvl_name;
	                    $sec_name       = $r->sec_name;
	                    $sec_teacher    = $r->sec_teacher;
	                    $dept_name      = $r->dept_name;
	                    $lvl_color      = $r->lvl_color;
	                }
	            }
	        ?>
            

			<br/><br/>
			<table class="table-custom table-no">
				<tbody>
					<tr>
						<td class="no-border">
							<p class="m-0 bold" style="font-size:34px ;color:#<?=$lvl_color?>"><?=$sec_name?></p>
						</td>
						<td class="text-right no-border">
							
						</td>
					</tr>
					<tr class="no-border">
						<td class="no-border">
							<h4 class="m-0"><?= '<strong>'.$lvl_name .'</strong> | '.$dept_name.' Department' ?></h4>
							<h5 class="m-0"><strong><?=$sec_teacher?></strong> <small> | Class Adviser</small> </h5>
						</td>
						<td class="text-right no-border"> 
                            <h3 class="bold m-0">Rating Sheet</h3>
                            <p class="m-0" style="font-size: 11px">School Year <?= $this->module->get_active_sy_name()?></p>
                        </td>
					</tr>
				</tbody>
			</table>

			<br/>
            
            <div class="table-wrapper">
               
                    <table class="table-custom table-bordered" id="data">
                        <thead>
                            <tr>
                                <th class="text-center " style="font-size:10px ;">No.</th>
                                <th style="width:50%; font-size: 12px;"  class="text-center "> &nbsp;&nbsp; Learners Name</th>
                                <?php 
                                    $subject  = $this->module->getTableSort('subject', 'sub_sort');

                                        foreach ($subject->result() as $r):
                                            $sub_name   = $r->sub_name;
                                            $sub_id     = $r->sub_id;

                                            $check_subject = $this->module->table_where('subject_assignment', array('sub_id' => $sub_id, 'sec_id' => $sec_id));
                                            if($check_subject->num_rows() > 0):
                                        ?>

                                           <th class="text-center vmiddle  " style="font-size:9px"  colspan="5"  >
                                           <?=$sub_name?> 
                                           </th>
                                            
                                            <?php 
                                                $subject_detail = $this->module->table_where('subject_detail', array('sub_id' => $sub_id));                                                        
                                                foreach($subject_detail->result() as $s):
                                                    $subj_det_name = $s->subj_det_name;
                                            ?>

                                                <th class="text-center vmiddle  " style="font-size:9px"  colspan="5"  >
                                                   <small> <?=$subj_det_name?></small>
                                                </th>

                                            <?php endforeach; ?>
                                        <?php endif; ?>
                                <?php endforeach; ?>
                                <th class="bold" style="font-size:9px">
                                    Average
                                </th>
                            </tr>
                            <tr>
                                <th colspan="2"></th>
                                <?php 
                                    $subject  = $this->module->getTableSort('subject', 'sub_sort');

                                        foreach ($subject->result() as $r):
                                            $sub_name   = $r->sub_name;
                                            $sub_id     = $r->sub_id;

                                            $check_subject = $this->module->table_where('subject_assignment', array('sub_id' => $sub_id, 'sec_id' => $sec_id));
                                            if($check_subject->num_rows() > 0):
                                        ?>
                                        
                                                <?php foreach($quarters->result() as $q) :
                                                    $qtr_code = $q->qtr_code;
                                                ?>
                                                    <th class="text-center vmiddle bold" style="background-color: #fff; "><?=$qtr_code?></th>
                                                <?php endforeach; ?>
                                               <!--  <th></th> -->
                                               <th class="text-center  vmiddle bold " style="background-color: #0073b7 ; color: #fff;">FG</th>
                                            
                                            <?php 
                                                $subject_detail = $this->module->table_where('subject_detail', array('sub_id' => $sub_id));                                                        
                                                foreach($subject_detail->result() as $s):
                                                    $subj_det_name = $s->subj_det_name;
                                            ?>

                                                <?php foreach ($quarters->result() as $q) :
                                                    $qtr_code = $q->qtr_code;
                                                ?>
                                               <th class="text-center  vmiddle bold" ><?=$qtr_code?></th>

                                                <?php endforeach; ?>
                                                <!-- <th></th> -->
                                                <th class="text-center  vmiddle bold " style="background-color: #008d4c ; color: #fff;">FG</th>

                                            <?php endforeach; ?>
                                        <?php endif; ?>
                                <?php endforeach; ?>
                                <th></th>
                            </tr>
                        </thead>

                        <tbody>
                            <?php 
                                $cnt=1;
                                foreach($student_data as $d):
                                    $stud_id    = $d['stud_id'];
                                    $stud_name  = $d['stud_name'];

                                    $final_average = 0;
                                    $final_count   = 0;
                            ?>
                                <tr class="me">
                                    <td class="text-center vmiddle td" ><small><?=$cnt++?></small></td>
                                    <td class="vmiddle td name">
                                        <small>
                                        &nbsp;&nbsp;<?=$stud_name?>
                                        </small>
                                    </td>

                                    <?php foreach ($subject->result() as $r):
                                        $sub_name   = $r->sub_name;
                                        $sub_id     = $r->sub_id;

                                        $check_subject = $this->module->table_where('subject_assignment', array('sub_id' => $sub_id, 'sec_id' => $sec_id));
                                        if($check_subject->num_rows() > 0):
                                    ?>

                                            <?php 
                                                $fg     = 0;
                                                $fg_div = 0;



                                                foreach ($quarters->result() as $q) :
                                                $qtr_code = $q->qtr_code;

                                                $final_grade = 0;

                                                foreach($student_data as $g):
                                                    $gstud_id   = $g['stud_id'];
                                                    $gsubjects  = $g['subjects'];

                                                    if($gstud_id == $stud_id):
                                                        foreach($gsubjects as $h):
                                                            $hsub_id    = $h['sub_id'];
                                                            $hquarter   = $h['quarter'];

                                                            if($hsub_id == $sub_id):

                                                                foreach($hquarter as $qr):
                                                                    $qrqtr_code = $qr['qtr_code'];
                                                                    $qrfinal_grade = $qr['final_grade'];

                                                                    if( $qrqtr_code == $qtr_code):?>
                                                                       <td class="text-center  vmiddle" >
                                                                            <small>
                                                                           <?=empty($qrfinal_grade) ? '' : $qrfinal_grade?>
                                                                            
                                                                            <?php 
                                                                                $final_grade = $qrfinal_grade;
                                                                                $fg += $final_grade;
                                                                                $fg_div ++;
                                                                            ?>
                                                                            </small>
                                                                       </td>
                                                                    <?php endif; ?>

                                                               <?php endforeach; ?>

                                                            <?php endif; ?>

                                                       <?php endforeach; ?>

                                                    <?php endif; ?>

                                                <?php endforeach; ?>
                                            <?php endforeach; ?> <!-- end quarter -->
                                            <!-- <th style="border-width: medium;"></th> -->
                                            <td class="text-center  vmiddle bold ">
                                                <?php  
                                                    $subject_average = round(($fg / $fg_div));
                                                    echo $subject_average;
                                                    

                                                    $final_average += $subject_average;
                                                    $final_count ++;
                                                ?>
                                                
                                            </td>
                                                
                                                <?php 
                                                    

                                                    $subject_detail = $this->module->table_where('subject_detail', array('sub_id' => $sub_id));
                                                    foreach($subject_detail->result() as $s):
                                                        $subj_det_name  = $s->subj_det_name;
                                                        $subj_det_id    =  $s->subj_det_id;
                                                ?>

                                                    <?php 
                                                        $fg_det     = 0;
                                                        $fg_det_div = 0;

                                                        foreach ($quarters->result() as $q) :
                                                        $qtr_code = $q->qtr_code;
                                                    ?>
                                                    <td class="text-center  vmiddle" >
                                                        <small>
                                                        <?php 

                                                        foreach($student_data as $g):
                                                            $gstud_id   = $g['stud_id'];
                                                            $gsubjects  = $g['subjects'];

                                                            if($gstud_id == $stud_id):
                                                                foreach($gsubjects as $h):
                                                                    $hsub_id    = $h['sub_id'];
                                                                    $hquarter   = $h['quarter'];

                                                                    if($hsub_id == $sub_id):

                                                                        foreach($hquarter as $qr):
                                                                            $qrqtr_code = $qr['qtr_code'];
                                                                            $qrfinal_grade = $qr['final_grade'];
                                                                            $qrquarterly_grade = $qr['quarterly_grade']; 

                                                                            if( $qrqtr_code == $qtr_code):

                                                                                foreach($qrquarterly_grade as $qg):
                                                                                    $qgsub_id       = $qg['sub_id'];
                                                                                    $qgsubj_det_id  = $qg['subj_det_id'];
                                                                                    $qggrade        = $qg['grade'];

                                                                                    if($qgsubj_det_id == $subj_det_id):
                                                                            ?>
                                                                                        <?= (empty($qggrade) || $qggrade <= 0 ) ? '' : $qggrade?>
                                                                                        <?php 
                                                                                            $fg_det += $qggrade;
                                                                                        ?>

                                                                                    <?php endif; ?>
                                                                                <?php endforeach; ?>
                                                                            <?php endif; ?>

                                                                       <?php endforeach; ?>

                                                                    <?php endif; ?>

                                                               <?php endforeach; ?>

                                                            <?php endif; ?>
                                                            
                                                        <?php endforeach; ?>
                                                        </small>
                                                    </td>

                                                                   
                                                    <?php endforeach; ?>
                                                       <!--  <th style="border-width: medium; "></th> -->
                                                       <td class="text-center  vmiddle bold ">
                                                        <small>
                                                           <?= round($fg_det / $fg_div)?>
                                                        </small>
                                                       </td>
                                                <?php endforeach; ?>
                                            <?php endif; ?>
                                    <?php endforeach; ?>

                                    <td class="text-center vmiddle bold text-danger">
                                        <?php 
                                           echo round( ($final_average/$final_count) );
                                        ?>
                                    </td>


                                    
                                </tr>
                            <?php endforeach;?>
                        </tbody>
                       
                    </table>

                    
               
            </div>
			
        
            <div class="row">
                <div class="col-md-6">
                    <br/>
                     <small>Isidore de Seville Integrated School | S.Y. <?= $this->module->get_active_sy_name()?></small>
                </div>
                <div class="col-md-6 text-right">
                    <p class=" m-0">
                        <small>Prepared by:</small>
                        <strong>
                        <?=$this->session->userdata('usr_firstname').' '.$this->session->userdata('usr_lastname')?> </strong> <small> | <?=$this->session->userdata('usr_type')?></small>
                    </p>
                    <small><?php 
                        date_default_timezone_set("Asia/Manila");
                        echo date('l, M d, Y h:i a')?></small>
                </div>
            </div>
	</div>

</div>
<script type="text/javascript">
	var base_url = "<?php echo base_url(); ?>"; 

 function goback(){
	 window.location.href = base_url+'grading';
 	//window.location.replace(base_url);
 }
</script>
</body>
</html>