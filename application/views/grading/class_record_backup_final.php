<?php 

    
  $usr_name       = $this->session->userdata('usr_name');
  $usr_type       = $this->session->userdata('usr_type');
  $usr_firstname  = $this->session->userdata('usr_firstname');
  $usr_lastname   = $this->session->userdata('usr_lastname');
  $usr_is_login   = $this->session->userdata('usr_is_login');
  $tch_id         = $this->session->userdata('tch_id');
  $sy_id          = $this->module->get_active_sy();

  $where           = 'tch_id = "'.$tch_id.'"  AND sy_id = "'.$sy_id.'" ';



  if( ($usr_type <> 'Faculty') || empty($tch_id) ){
    header('Location: '.base_url());
  }

  if(empty($subj_id)){
    header('Location: '.base_url().'grading');
  }

?>


<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <title><?= $title;?></title>

    <?= $this->load->view('inc/css')?>

</head>
<body class="page-body gray">

<div class="page-container  horizontal-menu sidebar-collapsed"><!-- add class "sidebar-collapsed" to close sidebar by default, "chat-visible" to make chat appear always -->
    <header class="navbar navbar-fixed-top"><!-- set fixed position by adding class "navbar-fixed-top" table-responsive -->
        
        <div class="navbar-inner">
            <?=$this->load->view('inc/topbar');?>
        </div>
    </header>

    <div class="main-content">
        
        <?php 
            $subj_id        = ''; 
            $lvl_id         = '';  
            $sec_id         = '';  
            $tch_id         = '';  
            $sy_id          = ''; 
            $sub_id         = '';  
            $subj_det_id    = '';  
            $lvl_name       = ''; 
            $lvl_color      = '';      
            $sec_name       = '';   
            $dept_name      = '';          
            $sub_name       = ''; 

            foreach ($subj_assignment->result() as $r) {
                $subj_id        = $r->subj_id ; 
                $lvl_id         = $r->lvl_id ;  
                $sec_id         = $r->sec_id ;  
                $tch_id         = $r->tch_id ;  
                $sy_id          = $r->sy_id ; 
                $sub_id         = $r->sub_id ;  
                $subj_det_id    = $r->subj_det_id ;  
                $lvl_name       = $r->lvl_name ; 
                $lvl_color      = $r->lvl_color ;      
                $sec_name       = $r->sec_name ;   
                $dept_name      = $r->dept_name ;          
                $sub_name       = $r->sub_name ;
                $subj_det       = $this->module->get_query("SELECT subj_det_name FROM subject_detail WHERE subj_det_id =".$subj_det_id." ");  
            } 

              $subj_det_name  = $subj_det->row('subj_det_name');
              
              if( $subj_det->num_rows() > 0){
                  $subj_det_name =  '<small class="text-white"> | '.$subj_det_name.'</small>';
              }else{
                  $subj_det_name = '';
              }

              $student_male = $this->module->get_query("SELECT * FROM v_section_assignment WHERE  sy_id = ".$sy_id." AND sec_id = ".$sec_id." AND stud_gender = 'Male' ORDER BY stud_lastname, stud_firstname");
              $student_female  = $this->module->get_query("SELECT * FROM v_section_assignment WHERE  sy_id = ".$sy_id." AND sec_id = ".$sec_id." AND stud_gender = 'Female' ORDER BY stud_lastname, stud_firstname");

              $counts = intval($student_male->num_rows()) + intval($student_female->num_rows());
              $count  = intval($counts);

              $quarter = $this->module->table_where('quarter', array('qtr_active' => 'Y'));

              //$score_hdr = $this->module->get_query("SELECT * FROM student_score_hdr WHERE subj_id = ".$subj_id." AND scr_quarter ='".$quarter->row('qtr_code')."' ORDER BY scr_id");

              $score_hdr_ww     = $this->module->get_query("SELECT * FROM student_score_hdr WHERE subj_id = ".$subj_id." AND scr_type = 'WW' AND scr_quarter ='".$quarter->row('qtr_code')."' ORDER BY scr_id");
              $score_hdr_pt     = $this->module->get_query("SELECT * FROM student_score_hdr WHERE subj_id = ".$subj_id." AND scr_type = 'PT' AND scr_quarter ='".$quarter->row('qtr_code')."'AND scr_quarter ='".$quarter->row('qtr_code')."' ORDER BY scr_id");
              $score_hdr_qa     = $this->module->get_query("SELECT * FROM student_score_hdr WHERE subj_id = ".$subj_id." AND scr_type = 'QA' AND scr_quarter ='".$quarter->row('qtr_code')."' ORDER BY scr_id");

              //echo $this->db->last_query();

                /*$total_ww = 0;
                $total_pt = 0;
                $total_qa = 0;

            
                $initial_grade = 0;
                $final_grade = 0;

                $total_ww_st_cnt = 0;
                $total_pt_st_cnt = 0;
                $total_qa_st_cnt = 0;

                $total_all_cnt = 0;

                $weighted_score_ww = 0;
                $weighted_score_pt = 0;
                $weighted_score_qa = 0;*/

                $comp_assessment = $this->module->get_query("SELECT * FROM component_assessment WHERE sub_id = ".$sub_id." ");
                $ca_ww_percentage = 0;
                $ca_pt_percentage = 0;
                $ca_qa_percentage = 0;

                foreach($comp_assessment->result() as $l){
                    $ca_ww_percentage = $l->ca_ww_percentage;
                    $ca_pt_percentage = $l->ca_pt_percentage;
                    $ca_qa_percentage = $l->ca_qa_percentage;
                }

                $student  = $this->module->get_query("SELECT * FROM v_section_assignment WHERE sec_id =".$sec_id." AND sy_id =".$sy_id." ORDER BY stud_lastname, stud_firstname ASC"); 

        ?>



        <div class="row">
            <div class="col-md-12 ">
                <div class="panel panel-primary panel-table" >
                    <div class="panel-heading" style="padding:30px 20px">
                        <div class="row">
                            <div class="col-md-8">
                                <h1 class="m-0" ><strong style="color:#<?=$lvl_color?>">  <?=$sub_name?> </strong> <span>  <?=$subj_det_name?></span> </h1>
                            </div>

                            

                            <div class="col-md-4 text-right">
                                <h4 class=" m-0 bold"> CLASS RECORD </h4>
                                <h3 class=" m-0 bold"><?=($quarter->num_rows() < 1 ? '' : $quarter->row('qtr_name') )?></h3>
                            </div>
                        </div>
                    </div>

                    <div class="panel-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h3 class="m-0 bold"> <?= $lvl_name .' - '.$sec_name.' ('.$count.') '?> </h3>
                                <h5 class="m-0"><?=$dept_name?> Department</h5>
                            </div>


                            <div class="col-md-6 text-right">

                                <div class="btn-group">
                                    <a href="<?=base_url()?>grading/add_score/<?=$subj_id?>" class="btn btn-green"><i class="fa fa-plus"></i> Record Score </a>
                                    <button type="button" class="btn btn-primary">Export to Excel</button>
                                </div>
                                
                            </div>
                        </div>
                        <br/>


                        <?php  

                        $total_ww = 0;
                        $total_pt = 0;
                        $total_qa = 0;

                        $count_scr_type = $this->module->get_query("SELECT scr_type, COUNT(*) AS cnt FROM v_subject_score WHERE subj_id = ".$subj_id." GROUP BY scr_type");
                        $ww = $count_scr_type->row();
                        $pt = 0;
                        $qa = 0;

                        foreach($count_scr_type->result() as $h){
                            $scr_type = $h->scr_type;
                            
                            if($scr_type == 'WW'){
                                $ww = $h->cnt;
                            }else if($scr_type == 'PT'){
                                $pt = $h->cnt;
                            }else if($scr_type == 'QA'){
                                $qa = $h->cnt;
                            }
                        }
                        ?>


                        <div class="table-wrapper">
                            <div class="table-scroll">
                                <table class="table table-condense table-bordered" style="background-color: #fff">
                                    <tbody>
                                        
                                        <tr>
                                            <td colspan="2"></td>
                                                

                                            <th class="bold text-center vmiddle" colspan="<?=intval($ww) +3?>" ><h5 class="m-0 bold">WRITTEN WORKS</h5></th>
                                            <th class="bold text-center vmiddle"  colspan="<?=intval($pt) +3?>" ><h5 class="m-0 bold">PERFORMANCE TASK</h5></th>
                                            <th class="bold text-center vmiddle"  colspan="<?=intval($qa) +3?>"><h5 class="m-0 bold">QUARTERLY ASSESSMENT</h5></th>
                                            <td colspan="2"></td>
                                            
                                        </tr>

                                        <tr>
                                            <td class="text-center bold widtd-3 vbottom" >No.</td>
                                            <td class="bold vbottom" style="width:25%"><h3 class="m-0">Learners Name</h3></td>
                                            <?php 
                                            $cnt = 1;
                                            foreach ($score_hdr_ww->result() as $k):
                                                $total_ww += $k->scr_total_score;
                                            ?>
                                                <td class="text-center vbottom" >


                                                    <a href="<?=base_url()?>grading/edit_score/<?=$subj_id.'/'.$k->scr_id?>" type="button" >
                                                        <i class="fa fa-pencil"></i>
                                                    </a><br/>
                                                    <a href="#" data-id="<?=$k->scr_id?>" type="button" class="delete">
                                                        <i class="fa fa-times"></i>
                                                    </a>

                                                    <hr class="m-5" />
                                                    
                                                    <small><?=$cnt++?><br/>
                                                    <?=$k->scr_sub_type?></small><br/>
                                                    <strong>(<?=$k->scr_total_score?>)</strong><br/>
                                                    
                                                </td>
                                            <?php endforeach; ?>

                                                <td class="text-center vbottom"><br/><small>TOTAL</small> <br/> (<strong><?=$total_ww?></strong>)</td>
                                                <td class="text-center vbottom"><br/><br/>PS  </td>
                                                <td class="text-center vbottom"><br/>WS <br/><strong>(<?=$ca_ww_percentage?>%)</strong><br/> </td>

                                            <?php 
                                            $cnt = 1;
                                            foreach ($score_hdr_pt->result() as $k):
                                                $total_pt += $k->scr_total_score;
                                            ?>
                                                <td class="text-center vbottom">
                                                     <a href="<?=base_url()?>grading/edit_score/<?=$subj_id.'/'.$k->scr_id?>" type="button" >
                                                        <i class="fa fa-pencil"></i>
                                                    </a><br/>
                                                    <a href="#" data-id="<?=$k->scr_id?>" type="button" class="delete">
                                                        <i class="fa fa-times"></i>
                                                    </a>

                                                    <hr class="m-5" />

                                                    <br/>
                                                    <small><?=$cnt++?><br/></small>
                                                    <strong>(<?=$k->scr_total_score?>)</strong>
                                                </td>
                                            <?php endforeach; ?>

                                                <td class="text-center vbottom"><br/><small>TOTAL</small> <br/> (<strong><?=$total_pt?></strong>)</td>
                                                <td class="text-center vbottom"><br/><br/>PS <br/> </td>
                                                <td class="text-center vbottom"><br/>WS <br/><strong>(<?=$ca_pt_percentage?>%)</strong><br/> </td>

                                            <?php 
                                            $cnt = 1;
                                            foreach ($score_hdr_qa->result() as $k):
                                                $total_qa += $k->scr_total_score;
                                            ?>
                                                <td class="text-center vbottom">
                                                     <a href="<?=base_url()?>grading/edit_score/<?=$subj_id.'/'.$k->scr_id?>" type="button" >
                                                        <i class="fa fa-pencil"></i>
                                                    </a><br/>
                                                    <a href="#" data-id="<?=$k->scr_id?>" type="button" class="delete">
                                                        <i class="fa fa-times"></i>
                                                    </a>

                                                    <hr class="m-5" />
                                                    <br/>
                                                    <small><?=$cnt++?><br/></small>
                                                    <strong>(<?=$k->scr_total_score?>)</strong>
                                                </td>
                                            <?php endforeach; ?>
                                            <td class="text-center vbottom"><br/><small>TOTAL</small> <br/> (<strong><?=$total_qa?></strong>)</td>
                                            <td class="text-center vbottom"><br/><br/>PS <br/> </td>
                                            <td class="text-center vbottom"><br/>WS <br/><strong>(<?=$ca_qa_percentage?>%)</strong><br/> </td>

                                            <td class="bold text-center vbottom">INITIAL GRADE</td>
                                            <td class="bold text-center vbottom td-danger" >FINAL GRADE</td>

                                        </tr>

                                            <?php 
                                            $cnt = 1;
                                            foreach($student_male->result() as $m):  ?>
                                                <tr class="me">
                                                       <td class="text-center vmiddle" > <span class="badge badge-roundless" style="background-color:#004d7f; color:#fff"><?=$cnt++?></span></td>
                                                       <td class="vmiddle">
                                                            <h5 class="m-0">
                                                               <strong ><?=$m->stud_lastname.'</strong>, '.$m->stud_firstname.' '.substr($m->stud_middlename,0, 1) ?><?= !empty($m->stud_middlename)?'.':''?>
                                                            </h5>
                                                        </td>

                                                        <?php 

                                                            $total_ww_st = 0;
                                                            $total_pt_st = 0;
                                                            $total_qa_st = 0;

                                                            $initial_grade = 0;
                                                            $final_grade = 0;

                                                            $total_ww_st_cnt = 0;
                                                            $total_pt_st_cnt = 0;
                                                            $total_qa_st_cnt = 0;

                                                            $total_all_cnt = 0;

                                                            $weighted_score_ww = 0;
                                                            $weighted_score_pt = 0;
                                                            $weighted_score_qa = 0;

                                                            $item_score     = 0;

                                                            $hdrs  = $this->module->get_query("SELECT * FROM v_student_score WHERE subj_id = ".$subj_id." AND scr_type = 'WW' AND stud_gender = 'Male' AND stud_id=".$m->stud_id." "); ?>
                                                            
                                                            <?php if($hdrs->num_rows() <1 ): ?>
                                                                    <td class="text-center text-danger bold vmiddle"> NS </td>
                                                            <?php else: 
                                                                    foreach($hdrs->result() as $d): 

                                                                        $scr_stud_id    = $d->stud_id;
                                                                        $sscr_absent    = $d->sscr_absent;
                                                                        $item_score     = $d->sscr_score;

                                                                        $total_ww_st    += $item_score; ?>
                                                                    
                                                                    <?php if($sscr_absent == 'Y'):  ?>
                                                                            <?php if(empty($item_score) ): ?> 
                                                                                <td class="text-center text-danger bold vmiddle"> A </td> 
                                                                            <?php else: ?>
                                                                                <td class="text-center text-danger bold vmiddle"> <?= $item_score?> </td> 
                                                                            <?php endif; ?>

                                                                        <?php else: ?>
                                                                            <td class="text-center vmiddle"><?= $item_score?></td>
                                                                    <?php endif; ?>

                                                                    <?php endforeach; ?>


                                                            <?php endif; ?>

                                                             <td class="text-center bold text-info" ><?=$total_ww_st ?></td>
                                                             <td class="text-center bold text-success">
                                                                <?php 
                                                                    if($total_ww_st > 0){
                                                                        $percentage_score = intval($total_ww_st) / intval($total_ww) * 100; 
                                                                    }else{
                                                                        echo $percentage_score = 0;
                                                                    }
                                                                    echo number_format(round($percentage_score,2),2);
                                                                ?> 
                                                            </td>

                                                            <td class="text-center bold" style="background-color: #303641; color: #fff; ">
                                                                <?php 
                                                                    if($total_ww_st > 0){
                                                                        $weighted_score_ww = $percentage_score * (intval($ca_ww_percentage) / 100 );
                                                                    }else{
                                                                        echo $weighted_score_ww = 0;
                                                                    }
                                                                    echo number_format(round($weighted_score_ww,2),2);
                                                                ?> 
                                                            </td>

                                                           <!--  END WRITTEN WORKS -->

                                                            <?php  $hdrs  = $this->module->get_query("SELECT * FROM v_student_score WHERE subj_id = ".$subj_id." AND scr_type = 'PT' AND stud_gender = 'Male' AND stud_id=".$m->stud_id." "); ?>
                                                            
                                                            <?php if($hdrs->num_rows() <1 ): ?>
                                                                    <td class="text-center text-danger bold vmiddle"> NS </td>
                                                            <?php else: 
                                                                    foreach($hdrs->result() as $d): 

                                                                        $scr_stud_id    = $d->stud_id;
                                                                        $sscr_absent    = $d->sscr_absent;
                                                                        $item_score     = $d->sscr_score;

                                                                        $total_pt_st    += $item_score; ?>
                                                                    
                                                                    <?php if($sscr_absent == 'Y'):  ?>
                                                                            <?php if(empty($item_score) ): ?> 
                                                                                <td class="text-center text-danger bold vmiddle"> A </td> 
                                                                            <?php else: ?>
                                                                                <td class="text-center text-danger bold vmiddle"> <?= $item_score?> </td> 
                                                                            <?php endif; ?>

                                                                        <?php else: ?>
                                                                            <td class="text-center vmiddle"><?= $item_score?></td>
                                                                    <?php endif; ?>
                                                                    <?php endforeach; ?>
                                                            <?php endif; ?>

                                                            <td class="text-center bold text-info" ><?=$total_pt_st ?></td>
                                                             <td class="text-center bold text-success">
                                                                <?php 
                                                                    if($total_pt_st > 0){
                                                                        $percentage_score = intval($total_pt_st) / intval($total_pt) * 100; 
                                                                    }else{
                                                                        echo $percentage_score = 0;
                                                                    }
                                                                    echo number_format(round($percentage_score,2),2);
                                                                ?> 
                                                            </td>

                                                            <td class="text-center bold" style="background-color: #303641; color: #fff; ">
                                                                <?php 
                                                                    if($total_pt_st > 0){
                                                                        $weighted_score_pt = $percentage_score * (intval($ca_pt_percentage) / 100 );
                                                                    }else{
                                                                        echo $weighted_score_pt = 0;
                                                                    }
                                                                    echo number_format(round($weighted_score_pt,2),2);
                                                                ?> 
                                                            </td>

                                                            <!--  END PERFROMANCE TASK -->

                                                            <?php  $hdrs  = $this->module->get_query("SELECT * FROM v_student_score WHERE subj_id = ".$subj_id." AND scr_type = 'QA' AND stud_gender = 'Male' AND stud_id=".$m->stud_id." "); ?>
                                                            
                                                            <?php if($hdrs->num_rows() <1 ): ?>
                                                                    <td class="text-center text-danger bold vmiddle"> NS </td>
                                                            <?php else: 
                                                                    foreach($hdrs->result() as $d): 

                                                                        $scr_stud_id    = $d->stud_id;
                                                                        $sscr_absent    = $d->sscr_absent;
                                                                        $item_score     = $d->sscr_score;

                                                                        $total_qa_st    += $item_score; ?>
                                                                    
                                                                    <?php if($sscr_absent == 'Y'):  ?>
                                                                            <?php if(empty($item_score) ): ?> 
                                                                                <td class="text-center text-danger bold vmiddle"> A </td> 
                                                                            <?php else: ?>
                                                                                <td class="text-center text-danger bold vmiddle"> <?= $item_score?> </td> 
                                                                            <?php endif; ?>

                                                                        <?php else: ?>
                                                                            <td class="text-center vmiddle"><?= $item_score?></td>
                                                                    <?php endif; ?>
                                                                    <?php endforeach; ?>
                                                            <?php endif; ?>

                                                            <td class="text-center bold text-info" ><?=$total_qa_st ?></td>
                                                             <td class="text-center bold text-success">
                                                                <?php 
                                                                    if($total_qa_st > 0){
                                                                        $percentage_score = intval($total_qa_st) / intval($total_qa) * 100; 
                                                                    }else{
                                                                        echo $percentage_score = 0;
                                                                    }
                                                                    echo number_format(round($percentage_score,2),2);
                                                                ?> 
                                                            </td>

                                                            <td class="text-center bold" style="background-color: #303641; color: #fff; ">
                                                                <?php 
                                                                    if($total_qa_st > 0){
                                                                        $weighted_score_qa = $percentage_score * (intval($ca_qa_percentage) / 100 );
                                                                    }else{
                                                                        echo $weighted_score_qa = 0;
                                                                    }
                                                                    echo number_format(round($weighted_score_qa,2),2);
                                                                ?> 
                                                            </td>
                                                            <!--  END PQUARTERLY ASSESSMENT -->

                                                            <td class="text-center ">
                                                                <h5 class=" m-0">
                                                                    <?php 
                                                                        $initial_grade = $weighted_score_ww  + $weighted_score_pt + $weighted_score_qa;
                                                                        echo number_format(round($initial_grade,2),2); 
                                                                    ?>   
                                                                </h5> 
                                                            </td>

                                                            <td class="text-center bold td-danger">
                                                                <h5 class="bold m-0 text-white">
                                                                    <?php 
                                                                        $q = $this->module->get_query("SELECT * FROM grade_transmutation WHERE gt_min <= ".$initial_grade." AND gt_max >= ".$initial_grade." ");
                                                                        $final_grade = $q->row('gt_grade');
                                                                        echo number_format(round($final_grade,2),2);
                                                                    ?>
                                                                        
                                                                </h5> 
                                                            </td>
                                                </tr>
                                            <?php endforeach; ?>

                                            <!-- FEMALE -->

                                            <?php 
                                            $cnt = $cnt;
                                            foreach($student_female->result() as $m):  ?>
                                                <tr class="me">
                                                       <td class="text-center vmiddle" > <span class="badge badge-roundless" style="background-color:#ea2474; color:#fff"><?=$cnt++?></span></td>
                                                       <td class="vmiddle">
                                                            <h5 class="m-0">
                                                               <strong ><?=$m->stud_lastname.'</strong>, '.$m->stud_firstname.' '.substr($m->stud_middlename,0, 1) ?><?= !empty($m->stud_middlename)?'.':''?>
                                                            </h5>
                                                        </td>

                                                        <?php 

                                                            $total_ww_st = 0;
                                                            $total_pt_st = 0;
                                                            $total_qa_st = 0;

                                                            $initial_grade = 0;
                                                            $final_grade = 0;

                                                            $total_ww_st_cnt = 0;
                                                            $total_pt_st_cnt = 0;
                                                            $total_qa_st_cnt = 0;

                                                            $total_all_cnt = 0;

                                                            $weighted_score_ww = 0;
                                                            $weighted_score_pt = 0;
                                                            $weighted_score_qa = 0;

                                                            $item_score     = 0;

                                                            $hdrs  = $this->module->get_query("SELECT * FROM v_student_score WHERE subj_id = ".$subj_id." AND scr_type = 'WW' AND stud_gender = 'Female' AND stud_id=".$m->stud_id." "); ?>
                                                            
                                                            <?php if($hdrs->num_rows() <1 ): ?>
                                                                    <td class="text-center text-danger bold vmiddle"> NS </td>
                                                            <?php else: 
                                                                    foreach($hdrs->result() as $d): 

                                                                        $scr_stud_id    = $d->stud_id;
                                                                        $sscr_absent    = $d->sscr_absent;
                                                                        $item_score     = $d->sscr_score;

                                                                        $total_ww_st    += $item_score; ?>
                                                                    
                                                                    <?php if($sscr_absent == 'Y'):  ?>
                                                                            <?php if(empty($item_score) ): ?> 
                                                                                <td class="text-center text-danger bold vmiddle"> A </td> 
                                                                            <?php else: ?>
                                                                                <td class="text-center text-danger bold vmiddle"> <?= $item_score?> </td> 
                                                                            <?php endif; ?>

                                                                        <?php else: ?>
                                                                            <td class="text-center vmiddle"><?= $item_score?></td>
                                                                    <?php endif; ?>

                                                                    <?php endforeach; ?>


                                                            <?php endif; ?>

                                                             <td class="text-center bold text-info" ><?=$total_ww_st ?></td>
                                                             <td class="text-center bold text-success">
                                                                <?php 
                                                                    if($total_ww_st > 0){
                                                                        $percentage_score = intval($total_ww_st) / intval($total_ww) * 100; 
                                                                    }else{
                                                                        echo $percentage_score = 0;
                                                                    }
                                                                    echo number_format(round($percentage_score,2),2);
                                                                ?> 
                                                            </td>

                                                            <td class="text-center bold" style="background-color: #303641; color: #fff; ">
                                                                <?php 
                                                                    if($total_ww_st > 0){
                                                                        $weighted_score_ww = $percentage_score * (intval($ca_ww_percentage) / 100 );
                                                                    }else{
                                                                        echo $weighted_score_ww = 0;
                                                                    }
                                                                    echo number_format(round($weighted_score_ww,2),2);
                                                                ?> 
                                                            </td>

                                                           <!--  END WRITTEN WORKS -->

                                                            <?php  $hdrs  = $this->module->get_query("SELECT * FROM v_student_score WHERE subj_id = ".$subj_id." AND scr_type = 'PT' AND stud_gender = 'Female' AND stud_id=".$m->stud_id." "); ?>
                                                            
                                                            <?php if($hdrs->num_rows() <1 ): ?>
                                                                    <td class="text-center text-danger bold vmiddle"> NS </td>
                                                            <?php else: 
                                                                    foreach($hdrs->result() as $d): 

                                                                        $scr_stud_id    = $d->stud_id;
                                                                        $sscr_absent    = $d->sscr_absent;
                                                                        $item_score     = $d->sscr_score;

                                                                        $total_pt_st    += $item_score; ?>
                                                                    
                                                                    <?php if($sscr_absent == 'Y'):  ?>
                                                                            <?php if(empty($item_score) ): ?> 
                                                                                <td class="text-center text-danger bold vmiddle"> A </td> 
                                                                            <?php else: ?>
                                                                                <td class="text-center text-danger bold vmiddle"> <?= $item_score?> </td> 
                                                                            <?php endif; ?>

                                                                        <?php else: ?>
                                                                            <td class="text-center vmiddle"><?= $item_score?></td>
                                                                    <?php endif; ?>
                                                                    <?php endforeach; ?>
                                                            <?php endif; ?>

                                                            <td class="text-center bold text-info" ><?=$total_pt_st ?></td>
                                                             <td class="text-center bold text-success">
                                                                <?php 
                                                                    if($total_pt_st > 0){
                                                                        $percentage_score = intval($total_pt_st) / intval($total_pt) * 100; 
                                                                    }else{
                                                                        echo $percentage_score = 0;
                                                                    }
                                                                    echo number_format(round($percentage_score,2),2);
                                                                ?> 
                                                            </td>

                                                            <td class="text-center bold" style="background-color: #303641; color: #fff; ">
                                                                <?php 
                                                                    if($total_pt_st > 0){
                                                                        $weighted_score_pt = $percentage_score * (intval($ca_pt_percentage) / 100 );
                                                                    }else{
                                                                        echo $weighted_score_pt = 0;
                                                                    }
                                                                    echo number_format(round($weighted_score_pt,2),2);
                                                                ?> 
                                                            </td>

                                                            <!--  END PERFROMANCE TASK -->

                                                            <?php  $hdrs  = $this->module->get_query("SELECT * FROM v_student_score WHERE subj_id = ".$subj_id." AND scr_type = 'QA' AND stud_gender = 'Female' AND stud_id=".$m->stud_id." "); ?>
                                                            
                                                            <?php if($hdrs->num_rows() <1 ): ?>
                                                                    <td class="text-center text-danger bold vmiddle"> NS </td>
                                                            <?php else: 
                                                                    foreach($hdrs->result() as $d): 

                                                                        $scr_stud_id    = $d->stud_id;
                                                                        $sscr_absent    = $d->sscr_absent;
                                                                        $item_score     = $d->sscr_score;

                                                                        $total_qa_st    += $item_score; ?>
                                                                    
                                                                    <?php if($sscr_absent == 'Y'):  ?>
                                                                            <?php if(empty($item_score) ): ?> 
                                                                                <td class="text-center text-danger bold vmiddle"> A </td> 
                                                                            <?php else: ?>
                                                                                <td class="text-center text-danger bold vmiddle"> <?= $item_score?> </td> 
                                                                            <?php endif; ?>

                                                                        <?php else: ?>
                                                                            <td class="text-center vmiddle"><?= $item_score?></td>
                                                                    <?php endif; ?>
                                                                    <?php endforeach; ?>
                                                            <?php endif; ?>

                                                            <td class="text-center bold text-info" ><?=$total_qa_st ?></td>
                                                             <td class="text-center bold text-success">
                                                                <?php 
                                                                    if($total_qa_st > 0){
                                                                        $percentage_score = intval($total_qa_st) / intval($total_qa) * 100; 
                                                                    }else{
                                                                        echo $percentage_score = 0;
                                                                    }
                                                                    echo number_format(round($percentage_score,2),2);
                                                                ?> 
                                                            </td>

                                                            <td class="text-center bold" style="background-color: #303641; color: #fff; ">
                                                                <?php 
                                                                    if($total_qa_st > 0){
                                                                        $weighted_score_qa = $percentage_score * (intval($ca_qa_percentage) / 100 );
                                                                    }else{
                                                                        echo $weighted_score_qa = 0;
                                                                    }
                                                                    echo number_format(round($weighted_score_qa,2),2);
                                                                ?> 
                                                            </td>
                                                            <!--  END PQUARTERLY ASSESSMENT -->

                                                            <td class="text-center ">
                                                                <h5 class=" m-0">
                                                                    <?php 
                                                                        $sum_grade      = $weighted_score_ww  + $weighted_score_pt + $weighted_score_qa;
                                                                        $initial_grade  = round($sum_grade,2);
                                                                        echo number_format($initial_grade,2);
                                                                    ?>   
                                                                </h5> 
                                                            </td>

                                                            <td class="text-center bold td-danger">
                                                                <h5 class="bold m-0 text-white">
                                                                    <?php 
                                                                        $q = $this->module->get_query("SELECT * FROM grade_transmutation WHERE gt_min <= ".float_val($initial_grade)." AND gt_max >= ".float_val($initial_grade)." ");
                                                                        $final_grade = $q->row('gt_grade');
                                                                        echo number_format(round($final_grade,2),2);

                                                                        echo $this->db->last_query();
                                                                    ?>
                                                                        
                                                                </h5> 
                                                            </td>
                                                </tr>
                                            <?php endforeach; ?>




                                    </tbody>

                                    
                                </table>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
         
        </div>
    </div>

    
</div> <!-- end of body container -->


<?= $this->load->view('inc/js')?>
<script type="text/javascript" charset="utf-8">
  $(document).ready(function() {
        
        $('.me').click(function(){
            var me = $(this);
            $('tr').css('background-color','#fff');
            me.css('background-color','#ddd');
        }); 

        /*$('td').click(function(){
            var me = $(this);
            $('td').css('background-color','#fff');
            me.css('background-color','#ddd');
        });*/ 

         $(document.body).on("click",".delete",function(e){
            e.preventDefault();
            var scr_id = $(this).data('id');

            if (confirm('Are you sure you want to delete this record?')) {
                $.ajax({url: base_url+'grading/delete_score/'+scr_id, success: function(result){
                    window.setTimeout(function(){location.reload()},1000);
                }});
            }


            
        });

  });
</script>
</body>
</html>