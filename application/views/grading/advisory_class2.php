<?php 

    
  $usr_name       = $this->session->userdata('usr_name');
  $usr_type       = $this->session->userdata('usr_type');
  $usr_firstname  = $this->session->userdata('usr_firstname');
  $usr_lastname   = $this->session->userdata('usr_lastname');
  $usr_is_login   = $this->session->userdata('usr_is_login');
  $tch_id         = $this->session->userdata('tch_id');
  $sy_id          = $this->module->get_active_sy();

  $where           = 'tch_id = "'.$tch_id.'"  AND sy_id = "'.$sy_id.'" ';

  if( ($usr_type <> 'Faculty') || empty($tch_id) ){
    header('Location: '.base_url());
  }

?>


<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <title><?= $title;?></title>

    <?= $this->load->view('inc/css')?>

</head>
<body class="page-body gray">

<div class="page-container  horizontal-menu sidebar-collapsed"><!-- add class "sidebar-collapsed" to close sidebar by default, "chat-visible" to make chat appear always -->
    <header class="navbar navbar-fixed-top"><!-- set fixed position by adding class "navbar-fixed-top" -->
        
        <div class="navbar-inner">
            <?=$this->load->view('inc/topbar');?>
        </div>
    </header>

    <div class="main-content">

        <?php 
            $sec_name       = '';
            $lvl_name       = '';
            $sec_teacher    = '';
            $dept_name      = '';
            $lvl_color      = '';

            $sy_id          = $sy_id;
            $sec_id         = $sec_id;
            $quarter        = $this->module->table_where('quarter', array('qtr_active' => 'Y'));

            if($section->num_rows() > 0){
                foreach($section->result() as $r){
                    $lvl_name       = $r->lvl_name;
                    $sec_name       = $r->sec_name;
                    $sec_teacher    = $r->sec_teacher;
                    $dept_name      = $r->dept_name;
                    $lvl_color      = $r->lvl_color;
                }
            }
        ?>
        <div class="row">
            <div class="col-md-12 ">
                <div class="panel panel-primary " >
                    <div class="panel-heading" style="padding:20px 20px">
                        <div class="row">
                            <div class="col-md-8">
                                <h1 class="m-0 bold" style="color:#<?=$lvl_color?>"><?=$sec_name?></h1>
                                <h4 class="m-0"><?= '<strong>'.$lvl_name .'</strong> | '.$dept_name.' Department' ?></h4>
                                <h5 class="m-0"><strong><?=$sec_teacher?></strong> <small> | Class Adiviser</small> </h5>
                            </div>

                            <div class="col-md-4 text-right">
                                <h3 class="bold m-0"><?=$quarter->row('qtr_name')?></h3>
                                <h4 class="m-0">School Year <?= $this->module->get_active_sy_name()?></h4>
                            </div>
                        </div>
                    </div>

                    <div class="panel-body">
                        <div class="table-wrapper">
                            <div class="table-scroll">
                                <table class="table table-condense table-bordered" id="data">
                                    <thead>
                                        <th class="text-center theader">No.</th>
                                        <th class="theader" style="width:25%"> Learners Name</th>

                                        <?php foreach($thead as $t => $val):?>
                                        <th class="text-center theader vmiddle width-5"><small><?=$val['sub_name']?></small></th>

                                        <!--  with subj_det_id -->
                                        <?php if(!empty($val['subj_det_name'])):?>
                                            <?php foreach($val['subj_det_name'] as $r):?>
                                                <th class=" vbottom text-center" style="width:10px"><small><?=$r['subj_det_name']?></small></th>
                                            <?php endforeach; ?>
                                        <?php endif;?>
                                        <?php endforeach; ?>

                                        <th class="ws text-center vmiddle width-5 bold">Average</th>
                                        <th class="text-center vmiddle width-5 bold">Lowest</th>
                                        <th class="text-center vmiddle width-5 bold">Rank</th>
                                        <th class="text-center vmiddle width-15 bold">Award</th>

                                    </thead>

                                    <tbody>
                                        <?php 

                                            $rank   = array();

                                            $cnts           = 1;
                                            foreach($boys->result() as $b):
                                                $bstud_id = $b->stud_id;

                                                
                                        ?>
                                        <tr class="me">
                                           <td class="text-center vmiddle td" ><?=$cnts?></td>
                                           <td class="vmiddle td name">
                                                <h5 class="m-0"> 
                                                   <strong > <?=$b->stud_lastname.'</strong>, '.$b->stud_firstname.' '.substr($b->stud_middlename,0, 1) ?><?= !empty($b->stud_middlename)?'.':''?>
                                                </h5>
                                            </td>

                                            <?php 
                                                $average    = 0;
                                                $final_ave  = 0;
                                                $qcnt       = 0;
                                                $award      = '';

                                                $disq_grade     = array();
                                                $sub_grade      = array(); 


                                                foreach($thead as $t => $val):?>
                                                <td class="text-center vmiddle td">
                                                    
                                                    <?php 
                                                        $sub_id = $val['sub_id'];
                                                       
                                
                                                            $cnt    = 0;
                                                            $qgrade = 0;

                                                            
                                                            foreach($student as $tt => $sval){
                                                                $ssub_id        = $sval['sub_id'];
                                                                $ssub_name      = $sval['sub_name'];
                                                                $sgrade_data    = $sval['grade_data'];

                                                                if($ssub_id == $sub_id){
                                                                    foreach($sgrade_data as $gval){
                                                                        $gsubj_det_id   = $gval['subj_det_id'];
                                                                        $ggrade         = $gval['grade'];

                                                                        foreach ($ggrade as $key) {
                                                                            $kstud_id   = $key['stud_id'];
                                                                            $ksub_id    = $key['sub_id'];
                                                                            $kqgrade    = $key['quarterly_grade'];

                                                                            if($ksub_id == $sub_id && $kstud_id == $bstud_id){

                                                                                if(empty($gsubj_det_id) || $gsubj_det_id == 0){
                                                                                    $qgrade = $kqgrade;
                                                                                    $cnt    = 1;
                                                                                }else{
                                                                                    $qgrade +=  $kqgrade;
                                                                                    $cnt ++;                                                                                
                                                                                }
                                                                            }
                                                                                
                                                                        }

                                                                    }
                                                                }

                                                                
                                                               
                                                            } 

                                                            if($qgrade == 0){
                                                                echo '--';
                                                            }else{
                                                                $qgrade = round( ($qgrade/$cnt),0);
                                                                $qcnt++;
                                                                echo '<h3 class="m-0">'.$qgrade.'</h3>';
                                                            }
                                                            
                                                            $average += $qgrade; 
                                                            array_push($sub_grade, $qgrade);
                                                                         
                                                    ?>
                                                </td>

                                                <?php if(!empty($val['subj_det_name'])):?>
                                                    <?php foreach($val['subj_det_name'] as $r):
                                                             $subj_det_id = $r['subj_det_id'];

                                                    ?>
                                                        <td class="vmiddle td text-center">
                                                            <?php 
                                                                
                                                                foreach($student as $tt => $sval){
                                                                    $ssub_id        = $sval['sub_id'];
                                                                    $ssub_name      = $sval['sub_name'];
                                                                    $sgrade_data    = $sval['grade_data'];

                                                                    if($ssub_id == $sub_id){ 
                                                                        foreach($sgrade_data as $gh){
                                                                            $ghsubj_det_id  = $gh['subj_det_id'];
                                                                            $ghgrade        = $gh['grade'];

                                                                            if($ghsubj_det_id == $subj_det_id){

                                                                                //echo $ghsubj_det_id.'  / '.$subj_det_id.'<br/>';
                                                                                foreach ($ghgrade as $key) {
                                                                                    $kstud_id       = $key['stud_id'];
                                                                                    $ksub_id        = $key['sub_id'];
                                                                                    $ksubj_det_id   = $key['subj_det_id'];
                                                                                    $kqgrade        = $key['quarterly_grade'];

                                                                                    //echo $ghsubj_det_id .'/'.$subj_det_id.'<br/>';

                                                                                    if( ($bstud_id == $kstud_id) && ($ksub_id == $sub_id) && ($ksubj_det_id && $subj_det_id) ){
                                                                                        $qgrade  = $kqgrade; 
                                                                                        echo '<h3 class="m-0">'.$qgrade.'</h3>';

                                                                                        if( ($ssub_name <> 'English') ){
                                                                                            array_push($sub_grade, $qgrade);
                                                                                        }
                                                                                        //echo ' | <small>'.number_format($key['initial_grade'],2).'</small>';
                                                                                    }
                                                                                }
                                                                            }

                                                                        }
                                                                    }
                                                                }

                                                                //array_push($sub_grade, $qgrade);

                                                            ?>
                                                        </td>
                                                    <?php endforeach; ?>
                                                <?php endif; ?>
                                            <?php endforeach; 
                                                $final_ave = round($average / $qcnt, 3);
                                                array_push($disq_grade, array('stud_id' => $bstud_id, 'average' => $final_ave, 'my_grades' => $sub_grade));

                                                 array_push($rank, array('grade' => $final_ave, 'id' => $bstud_id, 'rank' => '' ));  
                                            ?>

                                            <td class="vmiddle text-center ws final bold"><h3 class="m-0 text-white"><?=$final_ave?></h3></td>

                                                
                                                <?php 

                                                foreach($disq_grade as $cv => $ll){
                                                    $llmy_id        = $ll['stud_id'];
                                                    $llmy_average   = $ll['average'];
                                                    $llmy_grades    = $ll['my_grades'];

                                                    $temp = array_filter($llmy_grades, function($v){
                                                        return $v <> 0;
                                                    });

                                                    $min_grade = min($temp);

                                                    $award = '---';

                                                    /*if( ($llmy_average >=98 && $llmy_average <=100) && ($min_grade >= 97) ){
                                                        $award = 'With Highest Honors';                                                     
                                                    }else if( ($llmy_average >=95 && $llmy_average <=97) && ($min_grade >= 94) ){
                                                        $award = 'With High Honors';
                                                    }else if( ($llmy_average >=90 && $llmy_average <=94) && ($min_grade >= 90) ){
                                                        $award = 'With Honors';
                                                    }else{
                                                        $award = $award;
                                                    }*/

                                                    $ave = round($llmy_average,0);

                                                    if($ave >=98 && $ave <=100){
                                                        if($min_grade >= 97){
                                                            $award = 'With Highest Honors';
                                                        }else if($min_grade >= 94){
                                                            $award = 'With High Honors';
                                                        }else if($min_grade >= 90){
                                                            $award = 'With Honors';
                                                        }                                                        
                                                    }else if($ave >=95 && $ave <=97){
                                                        if($min_grade >= 97){
                                                            $award = 'With Highest Honors';
                                                        }else if($min_grade >= 94){
                                                            $award = 'With High Honors';
                                                        }else if($min_grade >= 90){
                                                            $award = 'With Honors';
                                                        }  
                                                    }else if($ave >=90 && $ave <=94){
                                                       if($min_grade >= 97){
                                                            $award = 'With Highest Honors';
                                                        }else if($min_grade >= 94){
                                                            $award = 'With High Honors';
                                                        }else if($min_grade >= 90){
                                                            $award = 'With Honors';
                                                        }  
                                                    }else{
                                                        $award = $award;
                                                    }

                                                    
                                                }
                                                  
                                                ?>

                                            <td class="vmiddle text-center width-5"><h4 class="m-0"><?= $min_grade?></h4></td>
                                            <td class="vmiddle text-center width-5">
                                                <?php 
                                                   /* $c = 1; // count identifier
                                                    $n = array(); // create new array

                                                    for ($i=0;$i<count($rank);$i++){ // loop through each array
                                                        foreach ($rank[$i] as $value){ // loop through into sub arrays
                                                            if (is_array($value)){
                                                                $n[$i]['details'] = array(
                                                                    "id" => $value['id'],
                                                                    "rank" => $c
                                                                );

                                                                $c++;
                                                            } else {
                                                                $n[$i]['points'] = $value;
                                                            }
                                                        }
                                                    }*/

                                                   


                                                    ?>
                                            </td>
                                            <td class="vmiddle text-center "><?= '<h5 class="m-0 bold">'.$award.'</h5>';?></td>
                                         
                                        </tr>

                                        <?php  
                                                                               
                                            $cnts++;
                                            endforeach;
                                            
                                        ?>
                                        
                                    </tbody>
                                </table>
                               
                                
                            </div>
                        </div>
                        
                        
                    </div>
                </div>
            </div>
        </div>
    </div>

    
</div> <!-- end of body container -->


<?= $this->load->view('inc/js')?>
<script type="text/javascript" charset="utf-8">
  $(document).ready(function() {

    $("#data tr.me").click(function() {
        var selected = $(this).hasClass("highlights");
        $("#data tr").removeClass("highlights");
        $("#data td.final").addClass('ws');

        if(!selected)
            $(this).addClass("highlights");
            var tr = $(this).closest('tr');
            tr.find('.final').removeClass('ws').addClass('td-danger');


        

        //console.log(tr.find('td.final').removeClass('.ws'));
            

    });
       

  });
</script>
</body>
</html>