<?php 

    
  $usr_name       = $this->session->userdata('usr_name');
  $usr_type       = $this->session->userdata('usr_type');
  $usr_firstname  = $this->session->userdata('usr_firstname');
  $usr_lastname   = $this->session->userdata('usr_lastname');
  $usr_is_login   = $this->session->userdata('usr_is_login');
  $tch_id         = $this->session->userdata('tch_id');
  $sy_id          = $this->module->get_active_sy();

  $where           = 'tch_id = "'.$tch_id.'"  AND sy_id = "'.$sy_id.'" ';



  if( ($usr_type <> 'Faculty') || empty($tch_id) ){
    header('Location: '.base_url());
  }

  if(empty($subj_id)){
    header('Location: '.base_url().'grading');
  }

?>


<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <title><?= $title;?></title>

    <?= $this->load->view('inc/css')?>

</head>
<body class="page-body gray">

<div class="page-container  horizontal-menu sidebar-collapsed"><!-- add class "sidebar-collapsed" to close sidebar by default, "chat-visible" to make chat appear always -->
    <header class="navbar navbar-fixed-top"><!-- set fixed position by adding class "navbar-fixed-top" table-responsive -->
        
        <div class="navbar-inner">
            <?=$this->load->view('inc/topbar');?>
        </div>
    </header>

    <div class="main-content">

          <?php 
            $subj_id        = ''; 
            $lvl_id         = '';  
            $sec_id         = '';  
            $tch_id         = '';  
            $sy_id          = ''; 
            $sub_id         = '';  
            $subj_det_id    = '';  
            $lvl_name       = ''; 
            $lvl_color      = '';      
            $sec_name       = '';   
            $dept_name      = '';          
            $sub_name       = ''; 

            foreach ($subj_assignment->result() as $r) {
                $subj_id        = $r->subj_id ; 
                $lvl_id         = $r->lvl_id ;  
                $sec_id         = $r->sec_id ;  
                $tch_id         = $r->tch_id ;  
                $sy_id          = $r->sy_id ; 
                $sub_id         = $r->sub_id ;  
                $subj_det_id    = $r->subj_det_id ;  
                $lvl_name       = $r->lvl_name ; 
                $lvl_color      = $r->lvl_color ;      
                $sec_name       = $r->sec_name ;   
                $dept_name      = $r->dept_name ;          
                $sub_name       = $r->sub_name ;
                $subj_det       = $this->module->get_query("SELECT subj_det_name FROM subject_detail WHERE subj_det_id =".$subj_det_id." ");  
            }  

              $subj_det_name  = $subj_det->row('subj_det_name');
              
              if( $subj_det->num_rows() > 0){
                  $subj_det_name =  '<small> | '.$subj_det_name.'</small>';
              }else{
                  $subj_det_name = '';
              }

              $student_male   = $this->module->get_query("SELECT * FROM v_section_assignment WHERE  sy_id = ".$sy_id." AND sec_id = ".$sec_id." AND stud_gender = 'Male' ORDER BY stud_lastname, stud_firstname");
              $student_female = $this->module->get_query("SELECT * FROM v_section_assignment WHERE  sy_id = ".$sy_id." AND sec_id = ".$sec_id." AND stud_gender = 'Female' ORDER BY stud_lastname, stud_firstname");

              $count  = intval($student_male->num_rows()) + intval($student_female->num_rows());


        ?>

          <div class="row">
            

            <div class="col-md-8 col-md-offset-1">
              <div class="panel panel-primary panel-shadow">
                <div class="panel-heading p-20" >
                    <div class="row">
                      <div class="col-md-8">
                          <h1 class="m-0"><strong ><?=$sub_name?></strong> <span>  <?=$subj_det_name?></span> </h1>
                          
                      </div>

                      <div class="col-md-4 text-right">
                          
                          <h4 class="m-0 "> <strong><?= $lvl_name .' - '.$sec_name?></strong> </h4>
                          <p><?= $dept_name?> Department</p>
                          
                      </div>
                  </div> 
                </div>

                <div class="panel-body">
                    <form method="post" id="frmSubmit" action="<?=base_url()?>grading/add_score" >

                      <div class="row" >

                          <div class="col-md-2 col-md-offset-1">
                              <input type="hidden" name="subj_id" class="form-control subj_id" value="<?=$subj_id?>">
                             
                              <div class="form-group">
                                  <label >Quarter</label>
                                  <?php $active_qtr = $this->module->get_query("SELECT * FROM quarter WHERE qtr_active = 'Y' "); ?>
                                  <input type="hidden" name="scr_quarter" class="form-control scr_quarter " value="<?=$active_qtr->row('qtr_code'); ?>">
                                  <input type="text" class="form-control" readonly="" value="<?=$active_qtr->row('qtr_name'); ?>">
                              </div>
                          </div>

                  
                          <div class="col-md-3">
                              <div class="form-group">
                                  <label >Type</label>
                                  <select class="form-control type" name="scr_type"  required="">
                                     <option selected="" disabled="">SELECT</option>
                                     <option value="WW">Written Works</option>
                                     <option value="PT">Performance Task</option>
                                     <option value="QA">Quarterly Assessment</option>
                                  </select>
                              </div>
                          </div>

                          <div class="col-md-1">
                              <div class="form-group">
                                  <label >No</label>
                                  <input type="text" class="form-control scr_item" readonly="" name="scr_item" value="0">
                              </div>
                          </div>

                          <div class="col-md-2">
                              <div class="form-group">
                                  <label >Sub-type</label>
                                  <select class="form-control sub_type" name="scr_sub_type" required="" disabled="">
                                     <option selected="" disabled="">SELECT</option>
                                     <option value="SW">Seatwork</option>
                                     <option value="HW">Homework</option>
                                     <option value="QZ">Quiz</option>
                                  </select>
                              </div>
                          </div>

                          <div class="col-md-2">
                              <label >Total Score</label>
                              <div class="input-group m-0" >
                                  <input class="form-control scr_total_score" type="text" name="scr_total_score" autofocus="" required="" autocomplete="off">
                                  <span class="input-group-btn">
                                  <button class="btn btn-default btn_delete btn-link btn_clear"> <i class="fa fa-times"></i></button>
                                   </span>
                              </div>

                              
                          </div>
                      </div>
       
                      <hr/>
                      <div class="row">
                        <div class="col-md-10 col-md-offset-1">
                            <table class="table table-condensed ">
                                <thead>
                                    <tr>
                                      <th colspan="2"><h3 class="m-0"><strong><?= $lvl_name .' - '.$sec_name?></strong>  (<?=$count?>)</h3></th>
                                      <th colspan="2" class="text-right"><a href="<?=base_url()?>grading/class_record/<?=$subj_id?>" class="btn btn-primary btn-xs"> <i class="fa fa-search"></i> View Class Record</a></th>
                                    </tr>
                                    <tr>
                                      <th class=" text-center bold width-10" >No.</th>
                                      <th class="bold">Learners Name</th>
                                      <th class="bold col-md-3 col-sm-4 col-xs-5 text-right" >Raw Score</th>
                                      <th class="bold col-md-1 text-center" >Absent</th>
                                    </tr>
                                </thead>
                                <tbody>
                                  <!-- BOYS -->
                                  <?php 
                                    $cnt = 1;
                                    if($student_male->num_rows() > 0):
                                      foreach($student_male->result() as $m):
                                        $stud_gender = $m->stud_gender;
                                  ?>
                                    <tr>
                                      <td class="text-center vmiddle" > <span class="badge badge-roundless" style="background-color:#004d7f; color:#fff"><?=$cnt?></span></td>
                                      <td class="vmiddle">
                                        <h5 class="m-0">
                                           <strong ><?=$m->stud_lastname.'</strong>, '.$m->stud_firstname.' '.substr($m->stud_middlename,0, 1) ?><?= !empty($m->stud_middlename)?'.':''?>
                                        </h5>
                                      </td>
                                      <td class="text-right vmiddle">
                                          <div class="raw_score" >
                                              <input type="hidden" name="student<?=$cnt?>[stud_id]" class="form-control" value="<?=$m->stud_id; ?>">
                                              <input class="form-control num input-sm text-right input-12" type="text" name="student<?=$cnt?>[sscr_score]" autofocus="" placeholder="0" autocomplete="off" required="" tabindex="<?=$cnt?>">
                                          </div>
                                      </td>

                                       <td class=" vmiddle text-center">
                                            <input type="checkbox" value="Y" class="absent" name="student<?=$cnt?>[sscr_absent]">
                                       </td>
                                    </tr>
                                  <?php 
                                      $cnt++;
                                      endforeach; 
                                    endif;  ?>

                                    <!-- GIRLS -->

                                    <?php 

                                    if($student_female->num_rows() > 0):
                                      foreach($student_female->result() as $f):
                                  ?>
                                    <tr>
                                      <td class="text-center vmiddle" ><span class="badge badge-roundless" style="background-color:#ea2474; color:#fff"><?=$cnt?></span></td>
                                      <td class="vmiddle">
                                        <h5 class="m-0">
                                          <strong ><?=$f->stud_lastname.'</strong>, '.$f->stud_firstname.' '.substr($f->stud_middlename,0, 1) ?><?= !empty($f->stud_middlename)?'.':''?>
                                        </h5>
                                      </td>
                                      <td class="text-right vmiddle">
                                          <div class="raw_score" >
                                              <input type="hidden" name="student<?=$cnt?>[stud_id]" class="form-control" value="<?=$m->stud_id; ?>">
                                              <input class="form-control num input-sm text-right input-12" type="text" name="student<?=$cnt?>[sscr_score]" autofocus="" placeholder="0" autocomplete="off" required="" tabindex="<?=$cnt?>">
                                          </div>
                                      </td>

                                       <td class=" vmiddle text-center">
                                            <input type="checkbox" value="Y" class="absent" name="student<?=$cnt?>[sscr_absent]">
                                       </td>

                                    </tr>
                                  <?php 
                                      $cnt += 1;
                                      endforeach; 
                                    endif;  ?>
                                  
                                </tbody>
                            </table>
                        </div>
                      </div>

                      <div class="row">
                        <div class="col-md-6 col-md-offset-1 "></div>
                          <div class="col-md-4  text-right">
                            <button class="btn btn-success bold" type="submit"> <i class="fa fa-save"></i> Record Score </button>
                            <button class="btn btn-default" type="reset"> Clear </button>
                          </div>
                      </div>
                    </form>
                </div>
              </div>
            </div>

            <div class="col-md-2">
              <div class="panel panel-primary panel-shadow">
                    <div class="panel-heading" style="background: #<?=$lvl_color ?>; color: #fff; padding:5px 10px">
                        <div class="panel-title" >
                            <h3 class="text-white">Counter</h3> 
                        </div>
                    </div> 

                    <div class="panel-body p-0 counter">
                        <?=$this->load->view('grading/counter')?>
                    </div>
                </div>

                <div class="msg"></div>
            </div>

          </div>
       
    </div>

    
</div> <!-- end of body container -->


<?= $this->load->view('inc/js')?>
<script type="text/javascript" charset="utf-8">
  $(document).ready(function() {

        $(document.body).on('blur','.num',function(){
           var  scr_total_score = parseInt($('.scr_total_score').val());
           var tr               = $(this).closest('tr');
           var num              = parseInt(tr.find('.num').val());  

           if( num <= scr_total_score){
                $('.msg').empty();
                tr.find('.raw_score').removeClass('has-error');
                tr.css('background-color', '#bdedbc');
           }else{
                $(this).val('');
                $('.msg').html(alert_error('<strong>Raw Score</strong> must be lower than to the total score'));
                tr.find('.raw_score').addClass('has-error').focus();
                tr.css('background-color', '#ffc9c9');
           }

        });

        $(document.body).on('focus','.num',function(){
          var tr = $(this).closest('tr').css('background-color', '#eee');
          //console.log('me');
        });


      $('.type').on('change', function(e){
          var type        = $(this).val(); 
          var quarter     = $('.scr_quarter').val();
          var subj_id     = $('.subj_id').val();

          if(type=='WW'){
              $('.sub_type').prop('disabled',false);
          }else{
              $('.sub_type').prop('disabled',true).prop('selectedIndex', 0);
          }


          if(type == 'WW'){
            $('.scr_item').val(parseInt($('.ww').text()) + 1);
          }else if(type == 'PT'){
            $('.scr_item').val(parseInt($('.pt').text()) + 1);
          }else if(type == 'QA'){
            $('.scr_item').val(parseInt($('.qa').text()) + 1);
          }

          e.preventDefault(); 
      });

      $('.btn_clear').click(function(){
          $('.scr_total_score').val('');
      });


      $('.absent').click(function(){
          var tr = $(this).closest('tr');
          
          if($(this).prop('checked') == true){
            tr.find('.num').val(0);
            tr.css('background-color', '#bdedbc');
          }else{
            tr.find('.num').val('');
            tr.css('background-color', '#ffc9c9');
          }
          


      });


      $('#frmSubmit').submit(function(e){
          e.preventDefault(); 


          var base    = $(this);
          var msg     = $(".msg");
          var btn     = base.find("button");
          var subj_id = $('.subj_id').val();

          
          $.ajax({
                type:base.attr("method"),//get/post
                data:base.serialize(),
                url:base.attr("action"),//location for the url
                beforeSend:function(){
                  msg.empty().html(alert_minimal('Processing . . .'));
                  btn.prop("disabled",true);
                },
                success:function(rrdata){

                  btn.prop("disabled",false);
                  var rdata = $.parseJSON(rrdata);
                  if(rdata.stat){
                  msg.empty().html(alert_success(rdata.msg));
                   $('#frmSubmit')[0].reset();
                   $('.counter').load(base_url+'grading/get_counter/'+subj_id);
                  }
                  else{   
                    msg.empty().html(alert_error(rdata.msg));
                  }
                  
                },
                error:function(rdata){
                  btn.prop("disabled",false);
                  msg.empty().html(alert_error('An error occured, please try again later'));
                }
          });

      });

  });
</script>
</body>
</html>