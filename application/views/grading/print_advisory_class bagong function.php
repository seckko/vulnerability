<!DOCTYPE html>
<html lang="en">
<?= $this->load->view('inc/css')?>
<link rel="stylesheet" href="<?php echo base_url()?>asset/css/print.css">
<link rel="stylesheet" href="<?php echo base_url()?>asset/css/print_media10.css">
<body class="page-body"  onload="window.print()"  > <!-- onload="window.print()"   onload="window.print()" onafterprint="goback()" --> 

<div class="page-container horizontal-menu">

	<div class="main-content">

	        <?php 
	            $sec_name       = '';
	            $lvl_name       = '';
	            $sec_teacher    = '';
	            $dept_name      = '';
	            $lvl_color      = '';

	            $sy_id          = $this->module->get_active_sy();
	            $sec_id         = $sec_id;

                $qtr_code       = $this->uri->segment(4);

	            $quarter        = $this->module->table_where('quarter', array('qtr_code' => $qtr_code));

                

	            if($section->num_rows() > 0){
	                foreach($section->result() as $r){
	                    $lvl_name       = $r->lvl_name;
	                    $sec_name       = $r->sec_name;
	                    $sec_teacher    = $r->sec_teacher;
	                    $dept_name      = $r->dept_name;
	                    $lvl_color      = $r->lvl_color;
	                }
	            }
	        ?>

			<br/><br/>
			<table class="table-custom table-no">
				<tbody>
					<tr>
						<td class="no-border">
							<p class="m-0 bold" style="font-size:34px ;color:#<?=$lvl_color?>"><?=$sec_name?></p>
						</td>
						<td class="text-right no-border">
							
						</td>
					</tr>
					<tr class="no-border">
						<td class="no-border">
							<h4 class="m-0"><?= '<strong>'.$lvl_name .'</strong> | '.$dept_name.' Department' ?></h4>
							<h5 class="m-0"><strong><?=$sec_teacher?></strong> <small> | Class Adviser</small> </h5>
						</td>
						<td class="text-right no-border"> 
                            <h3 class="bold m-0"><?=$quarter->row('qtr_name')?></h3>
                            <p class="m-0" style="font-size: 11px">School Year <?= $this->module->get_active_sy_name()?></p>
                        </td>
					</tr>
				</tbody>
			</table>

			<br/>

			<table class="table-custom table-bordered" id="data">
                <thead>
                    <th class="text-center " style="font-size:10px ;">No.</th>
                    <th style="width:25%; font-size: 12px;"  class="text-center "> Learners Name</th>

                    <?php 
                        $subject  = $this->module->getTableSort('subject', 'sub_sort');
                            foreach ($subject->result() as $r):
                                $sub_name   = $r->sub_name;
                                $sub_id     = $r->sub_id;
                            ?>
                               <th class="text-center  vmiddle width-5" style="font-size:8px ;">
                                    <?=$sub_name?>
                               </th>
                                
                                <?php 
                                $subject_detail = $this->module->table_where('subject_detail', array('sub_id' => $sub_id));
                                
                                foreach($subject_detail->result() as $s):
                                    $subj_det_name = $s->subj_det_name;
                                ?>

                                <th class=" vbottom text-center " style="width:10px;">
                                   <?=$subj_det_name?>
                                </th>

                            <?php endforeach; ?>
                    <?php endforeach; ?>

                    <th class="text-center vmiddle width-5 " style="font-size:8px">Average</th>
                    <th class="text-center vmiddle width-5 " style="font-size:8px">Rounded</th>
                    <th class="text-center vmiddle width-5 " style="font-size:8px">Lowest</th>
                    <th class="text-center vmiddle width-15 " style="font-size:8px">Award</th>
                </thead>

                <tbody>

                    <?php 
                        $cnt        = 1;
                        $disq_grade = array();
                        

                        foreach($student_data as $d):
                            $stud_id    = $d['stud_id'];
                            $stud_name  = $d['stud_name'];
                            $grades     = $d['subjects'];
                    ?>
                        <tr class="me">
                            <td class="text-center vmiddle td" ><?=$cnt++?></td>
                            <td class="vmiddle td name">
                                <?=$stud_name?>
                            </td>

                            <?php 

                            $average            = 0;
                            $average_divider    = 0;
                            $final_average      = 0;

                            $sub_grades = array();
                            

                            foreach ($subject->result() as $r):
                                $sub_name   = $r->sub_name;
                                $sub_id     = $r->sub_id;

                                $subject_detail = $this->module->table_where('subject_detail', array('sub_id' => $sub_id));
                            ?>

                            <td class="text-center vmiddle td ">
                                <?php 
                                    $grade      = 0;
                                    $divider    = 0;
                                    $gg         = 0;

                                    foreach($grades as $g){
                                        $gsub_id        = $g['sub_id'];
                                        $gsub_name      = $g['sub_name'];
                                        $gsubj_det_id   = $g['subj_det_id'];

                                        if( ($gsub_id == $sub_id) ){
                                            if(($gsubj_det_id == 0)){
                                                $grade = $g['grade'];

                                            }else{
                                                $gg  += $g['grade'];
                                                $divider ++;
                                                $grade = round(($gg / $divider));
                                            }

                                            
                                        }
                                    } 
                                    
                                    //push to disqualifying grade
                                    if($grade <> 0){
                                        array_push($sub_grades,  $grade );
                                    }

                                    $average_divider ++;
                                    $average += $grade;
                                    echo ($grade == 0 || empty($grade) )? '--' : $grade;  


                                ?>
                            </td>
                                   

                                <?php 
                                foreach($subject_detail->result() as $s):
                                    $subj_det_id    = $s->subj_det_id;
                                    $subj_det_name = $s->subj_det_name;
                                ?>

                                    <td class="text-center vmiddle td ">
                                        <?php 
                                            $grade = 0;
                                            foreach($grades as $g){
                                                $gsub_id        = $g['sub_id'];
                                                $gsub_name      = $g['sub_name'];
                                                $gsubj_det_id   = $g['subj_det_id'];


                                                if( ($gsub_id == $sub_id) && ($gsubj_det_id == $subj_det_id) ){
                                                    $grade = $g['grade'];
                                                    echo $grade.'<br/>';

                                                    if(strtolower($gsub_name) <> 'english'){
                                                        //push to disqualifying grade
                                                        if($grade <> 0){
                                                            array_push($sub_grades,  $grade );
                                                        }
                                                        
                                                    } 
                                                }
                                            }                                                            
                                        ?>
                                    </td>

                                <?php endforeach; ?>
                            <?php endforeach; ?>

                            <td class="text-center vmiddle td">
                                <?php 
                                    $final_average =  round( ($average / ($average_divider-1)), 2);
                                    echo number_format($final_average, 2);
                                ?>
                            </td>

                            <td class="text-center vmiddle td">
                                <?php 
                                    echo number_format($final_average);
                                ?>
                            </td>

                            <td class="text-center vmiddle td">
                                
                                <?php 
                                    //array_push($disq_grade, array('stud_id' => $stud_id, 'stud_name' => $stud_name, 'grade' => $sub_grades ));
                                    //get the lowest grades
                                    if(!empty($sub_grades)){
                                        $min_grade  = 0;
                                        $min        = min($sub_grades);
                                        $min_grade  = $min;
                                        echo $min_grade;
                                    }
                                   
                                        
                                ?>

                            </td>
                            <td class="vmiddle text-center ">
                                <small class="text-primary">
                                    <?php 
                                        $award = '---';
                                        $ave = round($final_average);

                                        if(($ave >=98 && $ave <=100) && ($min_grade >= 97) ){
                                            $award = 'With Highest Honors';                                   
                                        }else if(($ave >=95 && $ave <=97) &&($min_grade >= 94)){
                                            $award = 'With High Honors';
                                        }else if(($ave >=90 && $ave <=94) && ($min_grade >= 90)){
                                            $award = 'With Honors';
                                        }else{
                                            $award = $award;
                                        }

                                        echo $award;

                                    ?>
                                </small>
                            </td>
                        </tr>


                        
                    <?php endforeach; ?>
                    
                    
                </tbody>
            </table>

            <div class="row">
                <div class="col-md-6">
                    <br/>
                     <small>Isidore de Seville Integrated School | S.Y. <?= $this->module->get_active_sy_name()?></small>
                </div>
                <div class="col-md-6 text-right">
                    <p class=" m-0">
                        <small>Prepared by:</small>
                        <strong>
                        <?=$this->session->userdata('usr_firstname').' '.$this->session->userdata('usr_lastname')?> </strong> <small> | <?=$this->session->userdata('usr_type')?></small>
                    </p>
                    <small><?php 
                        date_default_timezone_set("Asia/Manila");
                        echo date('l, M d, Y h:i a')?></small>
                </div>
            </div>
	</div>

</div>
<script type="text/javascript">
	var base_url = "<?php echo base_url(); ?>"; 

 function goback(){
	 window.location.href = base_url+'grading';
 	//window.location.replace(base_url);
 }
</script>
</body>
</html>