<!DOCTYPE html>
<html lang="en">
<?= $this->load->view('inc/css')?>
<link rel="stylesheet" href="<?php echo base_url()?>asset/css/print.css">
<link rel="stylesheet" href="<?php echo base_url()?>asset/css/print_media10.css">
<body class="page-body"  onload="window.print()"  > <!-- onload="window.print()"   onload="window.print()" onafterprint="goback()" --> 

<div class="page-container horizontal-menu">

	<div class="main-content">

	        <?php 
	            $sec_name       = '';
	            $lvl_name       = '';
	            $sec_teacher    = '';
	            $dept_name      = '';
	            $lvl_color      = '';

	            $sy_id          = $this->module->get_active_sy();
	            $sec_id         = $sec_id;

                $qtr_code       = $this->uri->segment(4);

	            $quarter        = $this->module->table_where('quarter', array('qtr_code' => $qtr_code));

                

	            if($section->num_rows() > 0){
	                foreach($section->result() as $r){
	                    $lvl_name       = $r->lvl_name;
	                    $sec_name       = $r->sec_name;
	                    $sec_teacher    = $r->sec_teacher;
	                    $dept_name      = $r->dept_name;
	                    $lvl_color      = $r->lvl_color;
	                }
	            }
	        ?>

			<br/><br/>
			<table class="table-custom table-no">
				<tbody>
					<tr>
						<td class="no-border">
							<p class="m-0 bold" style="font-size:34px ;color:#<?=$lvl_color?>"><?=$sec_name?></p>
						</td>
						<td class="text-right no-border">
							
						</td>
					</tr>
					<tr class="no-border">
						<td class="no-border">
							<h4 class="m-0"><?= '<strong>'.$lvl_name .'</strong> | '.$dept_name.' Department' ?></h4>
							<h5 class="m-0"><strong><?=$sec_teacher?></strong> <small> | Class Adviser</small> </h5>
						</td>
						<td class="text-right no-border"> 
                            <h3 class="bold m-0"><?=$quarter->row('qtr_name')?></h3>
                            <p class="m-0" style="font-size: 11px">School Year <?= $this->module->get_active_sy_name()?></p>
                        </td>
					</tr>
				</tbody>
			</table>

			<br/>

			<table class="table-custom table-bordered" id="data">
                <thead>
                    <th class="text-center " style="font-size:10px ;">No.</th>
                    <th style="width:25%; font-size: 12px;"  class="text-center "> Learners Name</th>

                    <?php 

                            foreach ($subject->result() as $r):
                                $sub_name   = $r->sub_name;
                                $sub_id     = $r->sub_id;

                                $check_subject = $this->module->table_where('subject_assignment', array('sub_id' => $sub_id, 'sec_id' => $sec_id));
                                if($check_subject->num_rows() > 0):
                            ?>

                               <th class="text-center vmiddle width-5 " style="font-size:10px">
                                <?=$sub_name?> 
                               </th>
                                
                                <?php 
                                    $subject_detail = $this->module->table_where('subject_detail', array('sub_id' => $sub_id));                                                        
                                    foreach($subject_detail->result() as $s):
                                        $subj_det_name = $s->subj_det_name;
                                ?>

                                    <th class=" vbottom text-center " style="font-size:9px; ">
                                        <?=$subj_det_name?>
                                    </th>

                                <?php endforeach; ?>
                            <?php endif; ?>
                    <?php endforeach; ?>
                
                    <th class="text-center vmiddle width-5" style="font-size:10px">Average</th>
                    <th class="text-center vmiddle width-5" style="font-size:10px">Rounded</th>
                    <th class="text-center vmiddle width-5" style="font-size:10px">Lowest</th>
                    <th class="text-center vmiddle width-15" style="font-size:10px">Award</th>
                </thead>

                <tbody>
                    
                    <?php 
                        $cnt=1;
                        foreach($student_data as $d):
                            $stud_id    = $d['stud_id'];
                            $stud_name  = $d['stud_name'];
                    ?>
                        <tr class="me">
                            <td class="text-center vmiddle td"><small><?=$cnt++?></small></td>
                            <td class="vmiddle td name">
                                &nbsp;&nbsp;<?=$stud_name?>
                            </td>

                            <?php 

                                $sub_grades = array(); 

                                $average_divider = 0;
                                $average         = 0;

                                foreach ($subject->result() as $r):
                                $sub_name   = $r->sub_name;
                                $sub_id     = $r->sub_id;

                                $check_subject = $this->module->table_where('subject_assignment', array('sub_id' => $sub_id, 'sec_id' => $sec_id));
                                if($check_subject->num_rows() > 0):
                                
                                    foreach($student_data as $g):
                                        $gstud_id   = $g['stud_id'];
                                        $gsubjects  = $g['subjects'];


                                        if($gstud_id == $stud_id):
                                            foreach($gsubjects as $h):
                                                $hsub_id    = $h['sub_id'];
                                                if($hsub_id == $sub_id):
                                                    $ggrade     = $h['total_grade'];
                                                    array_push($sub_grades,  $ggrade );

                                                    
                                                    $average         += $ggrade;
                                                    $average_divider ++;
                                            ?>
                                                <td class="text-center vmiddle td ">
                                                   <?=empty($ggrade) ? '' : $ggrade?>
                                               </td>

                                                <?php endif; ?>
                                           <?php endforeach; ?>
                                        <?php endif; ?>
                                    <?php endforeach; ?>

                                        <?php 
                                            $subject_detail = $this->module->table_where('subject_detail', array('sub_id' => $sub_id));
                                            foreach($subject_detail->result() as $s):
                                                $subj_det_name  = $s->subj_det_name;
                                                $subj_det_id    =  $s->subj_det_id;
                                        ?>

                                        <td class="text-center vmiddle td ">
                                            <?php 
                                            foreach($student_data as $g):
                                                $gstud_id   = $g['stud_id'];
                                                $gsubjects  = $g['subjects'];

                                                if($gstud_id == $stud_id):
                                                    foreach($gsubjects as $h):
                                                        $hsub_id    = $h['sub_id'];
                                                        if($hsub_id == $sub_id):
                                                            $ggrade             = $h['total_grade'];
                                                            $gsubject_details   = $h['subject_details'];

                                                            foreach($gsubject_details as $d):
                                                                $dsub_id      = $d['sub_id'];
                                                                $dsubj_det_id = $d['subj_det_id'];
                                                                $dgrade       = $d['grade'];

                                                                if( ($dsub_id == $sub_id) && ($dsubj_det_id == $subj_det_id) && ($gstud_id == $stud_id) ){
                                                                    echo $dgrade;

                                                                    if(strtolower($sub_name) <> 'english'){
                                                                        //push to disqualifying grade
                                                                        if($dgrade <> 0){
                                                                            array_push($sub_grades,  $dgrade );
                                                                        }
                                                                        
                                                                    } 
                                                                }
                                                            ?>
                                                            <?php endforeach; ?>
                                                        <?php endif; ?>
                                                   <?php endforeach; ?>
                                                <?php endif; ?>
                                            <?php endforeach; ?>
                                        </td>
                                        <?php endforeach; ?> <!-- end subject_detail_result -->

                                <?php endif; ?>
                            <?php endforeach; ?>

                            <td class="text-center vmiddle td">
                                <?php 
                                    $final_average =  round( ($average / ($average_divider)), 3);
                                    echo number_format($final_average, 3);
                                ?>
                            </td>

                            <td class="text-center vmiddle td ">
                                    <?= round($final_average);?>
                            </td>

                            <td class="text-center vmiddle td" >
                                <?php 
                                    if(!empty($sub_grades)){
                                        $min_grade  = 0;
                                        $min        = min($sub_grades);
                                        $min_grade  = $min;
                                        echo $min_grade;
                                    }
                                ?>
                            </td>

                            <td class="vmiddle text-center ">
                                <small class="text-primary">
                                <?php 
                                                        $award = '---';
                                                        $ave = floor($final_average);

                                                        /*if( ($ave >=98 && $ave <=100) && ($min_grade >= 97) ){
                                                            $award = 'With Highest Honors';                                                                                         
                                                        }else if( ($ave >=95 && $ave <=97) && ($min_grade >= 94) ){
                                                            $award = 'With High Honors';
                                                        }else if( ($ave >=90 && $ave <=94) && ($min_grade >= 90) ) {
                                                            $award = 'With Honors';
                                                        }else{
                                                            $award = $award;
                                                        }*/

                                                        if($ave >=98 && $ave <=100 ){
                                                            if($min_grade >= 97){
                                                                $award = 'With Highest Honors';  
                                                            }else if($min_grade >= 94){
                                                                $award = 'With High Honors';
                                                            }else if ($min_grade >= 90){
                                                                $award = 'With Honors';
                                                            }                                                                                             
                                                        }else if($ave >=95 && $ave <=97){
                                                            if($min_grade >= 97){
                                                                $award = 'With Highest Honors';  
                                                            }else if($min_grade >= 94){
                                                                $award = 'With High Honors';
                                                            }else if ($min_grade >= 90){
                                                                $award = 'With Honors';
                                                            }  
                                                        }else if($ave >=90 && $ave <=94) {
                                                            if($min_grade >= 97){
                                                                $award = 'With Highest Honors';  
                                                            }else if($min_grade >= 94){
                                                                $award = 'With High Honors';
                                                            }else if ($min_grade >= 90){
                                                                $award = 'With Honors';
                                                            }  
                                                        }else{
                                                            $award = $award;
                                                        }

                                                        echo $award;
                                                    ?>
                                </small>
                            </td>

                        </tr>

                        <?php endforeach; ?>
                   
                    
                </tbody>
            </table>
            <br/>
            <div class="row">
                <div class="col-md-6">
                    
                     <small>Isidore de Seville Integrated School | S.Y. <?= $this->module->get_active_sy_name()?></small>
                </div>
                <div class="col-md-6 text-right">
                    <p class=" m-0">
                        <small>Prepared by:</small>
                        <strong>
                        <?=$this->session->userdata('usr_firstname').' '.$this->session->userdata('usr_lastname')?> </strong> <small> | <?=$this->session->userdata('usr_type')?></small>
                    </p>
                    <small><?php 
                        date_default_timezone_set("Asia/Manila");
                        echo date('l, M d, Y h:i a')?></small>
                </div>
            </div>
	</div>

</div>
<script type="text/javascript">
	var base_url = "<?php echo base_url(); ?>"; 

 function goback(){
	 window.location.href = base_url+'grading';
 	//window.location.replace(base_url);
 }
</script>
</body>
</html>