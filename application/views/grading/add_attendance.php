<?php 

    
  $usr_name       = $this->session->userdata('usr_name');
  $usr_type       = $this->session->userdata('usr_type');
  $usr_firstname  = $this->session->userdata('usr_firstname');
  $usr_lastname   = $this->session->userdata('usr_lastname');
  $usr_is_login   = $this->session->userdata('usr_is_login');
  $tch_id         = $this->session->userdata('tch_id');
  $sy_id          = $this->module->get_active_sy();

  $where           = 'tch_id = "'.$tch_id.'"  AND sy_id = "'.$sy_id.'" ';

  if( ($usr_type <> 'Faculty') || empty($tch_id) ){
    header('Location: '.base_url());
  }

?>


<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <title><?= $title;?></title>

    <?= $this->load->view('inc/css')?>

</head>
<body class="page-body gray">

<div class="page-container  horizontal-menu sidebar-collapsed"><!-- add class "sidebar-collapsed" to close sidebar by default, "chat-visible" to make chat appear always -->
    <header class="navbar navbar-fixed-top"><!-- set fixed position by adding class "navbar-fixed-top" -->
        
        <div class="navbar-inner">
            <?=$this->load->view('inc/topbar');?>
        </div>
    </header>


     <?php 
            $subj_id        = ''; 
            $lvl_id         = '';  
            $sec_id         = '';  
            $tch_id         = '';  
            $sy_id          = ''; 
            $sub_id         = '';  
            $subj_det_id    = '';  
            $lvl_name       = ''; 
            $lvl_color      = '';      
            $sec_name       = '';   
            $dept_name      = '';          
            $sub_name       = '';

            $sec_id            = $this->uri->segment(3);
            $sy_id             = $this->module->get_active_sy();

            $subj_assignment = $this->module->table_where('v_subject_teacher_assignment', array('sec_id' => $sec_id, 'sy_id' => $sy_id)); 

            foreach ($subj_assignment->result() as $r) {
                $subj_id        = $r->subj_id ; 
                $lvl_id         = $r->lvl_id ;   
                $tch_id         = $r->tch_id ;  
                $sy_id          = $r->sy_id ; 
                $sub_id         = $r->sub_id ;  
                $subj_det_id    = $r->subj_det_id ;  
                $lvl_name       = $r->lvl_name ; 
                $lvl_color      = $r->lvl_color ;      
                $sec_name       = $r->sec_name ;   
                $dept_name      = $r->dept_name ;  
            }  

              $student = $this->module->get_query("SELECT * FROM v_student_section_class_list WHERE  sy_id = ".$sy_id." AND sec_id = ".$sec_id." ORDER BY stud_lastname, stud_firstname");
              $count  = intval($student->num_rows());


        ?>

    <div class="main-content">
        <div class="row">
         <div class="col-md-8 col-md-offset-2">
            <div class="panel panel-primary panel-shadow">
              <div class="panel-heading p-20" >
                  <div class="row">
                    <div class="col-md-8 col-sm-6 col-xs-6">
                        <h2 class="m-0">Attendance Sheet </h2>
                        
                    </div>

                    <div class="col-md-4 col-sm-6 col-xs-6 text-right">
                      <h4> <small>School Year</small>  <?=$this->module->get_active_sy_name()?> </h4>
                    </div>
                </div> 
              </div>

              <div class="panel-body">
                  <form method="post" id="frmSubmit" action="<?=base_url()?>grading/add_attendance" >
                    <table class="table table-condensed stud_table">
                        <thead>
                            <tr>
                              <th colspan="2">
                                
                                <h2 class="m-0 "> <strong><?= $lvl_name .' - '.$sec_name?></strong> </h2>
                                <p><?= $dept_name?> Department</p>
                              </th>
                              <th>
                                <div class="form-group">
                                  <label >Month of </label>
                                    <select class="form-control month" name="athdr_id"  required="">
                                        <option selected="" disabled="">SELECT MONTH</option>
                                        <?php foreach($attendance_hdr->result() as $r):?>
                                          <option value="<?=$r->athdr_id?>" data-days="<?=$r->athdr_total_days?>" data-month = "<?=$r->athdr_month?>"><?=$r->athdr_month.' ('.$r->athdr_total_days.')'?></option>
                                        <?php endforeach; ?> 
                                    </select>
                                    <input type="hidden" name="athdr_month" id="athdr_month">
                                    <input type="hidden" name="athdr_total_days" id="athdr_total_days">
                                    <input type="hidden" name="sec_id" id="sec_id" value="<?=$sec_id?>">
                                </div>
                              </th>
                            </tr>
                            <tr>
                              <th class=" text-center bold"  style="width:2%">No</th>
                              <th class="bold">Learners Name</th>
                              <th class="bold col-md-3 col-sm-4 col-xs-5 text-right" >No. of days present</th>
                            </tr>
                        </thead>
                        <tbody id="tbl_attendance">
                          <!-- BOYS -->
                          <?php 
                            $cnt = 1;
                            if($student->num_rows() > 0):
                              foreach($student->result() as $m):
                                $stud_gender = $m->stud_gender;

                                if($stud_gender == 'Male' ):
                          ?>
                            <tr>
                              <td class="text-center vmiddle boys" > <?=$cnt?></td>
                              <td class="vmiddle">
                                <h5 class="m-0">
                                   <strong ><?=$m->stud_lastname.'</strong>, '.$m->stud_firstname.' '.substr($m->stud_middlename,0, 1) ?><?= !empty($m->stud_middlename)?'.':''?> <?= $m->stud_suffix?>
                                </h5>
                              </td>
                              <td class="text-right vmiddle">
                                  <div class="raw_score" >
                                      <input type="hidden" name="attendance<?=$cnt?>[stud_id]" class="form-control" value="<?=$m->stud_id; ?>">
                                      <input class="form-control num input-sm text-right input-12" type="text" name="attendance<?=$cnt?>[att_present]" autofocus="" placeholder="0" autocomplete="off" required="" tabindex="<?=$cnt?>">
                                  </div>
                              </td>
                            </tr>

                          <?php 
                              $cnt++;
                              endif; 
                             endforeach; 
                            endif;

                          ?>

                          <?php 
                            $cnt = $cnt;
                            if($student->num_rows() > 0):
                              foreach($student->result() as $f):
                                $stud_gender = $f->stud_gender;

                                if($stud_gender == 'Female' ):
                          ?>


                            <tr>
                              <td class="text-center vmiddle girls" > <?=$cnt?></td>
                              <td class="vmiddle">
                                <h5 class="m-0">
                                   <strong ><?=$f->stud_lastname.'</strong>, '.$f->stud_firstname.' '.substr($f->stud_middlename,0, 1) ?><?= !empty($f->stud_middlename)?'.':''?><?= $m->stud_suffix?>
                                </h5>
                              </td>
                              <td class="text-right vmiddle">
                                  <div class="raw_score" >
                                      <input type="hidden" name="attendance<?=$cnt?>[stud_id]" class="form-control" value="<?=$f->stud_id; ?>">
                                      <input class="form-control num input-sm text-right input-12" type="text" name="attendance<?=$cnt?>[att_present]" autofocus="" placeholder="0" autocomplete="off" required="" tabindex="<?=$cnt?>">
                                  </div>
                              </td>

                            </tr>

                          <?php 
                              $cnt++;
                                endif; 
                              endforeach; 
                            endif;  ?>

                        </tbody>
                    </table>

                    <hr/>

                    <div class="row">
                        <div class="col-md-8">
                          <div class="msg"></div>
                        </div>
                        <div class="col-md-4 text-right">
                          <button class="btn btn-success bold" type="submit"> <i class="fa fa-save"></i> Submit Attendace </button>
                          <button class="btn btn-default" type="reset"> Clear </button>
                        </div>
                    </div>

                  </form>

              </div>
            </div>
          </div>

        </div>
    </div>

    
    
</div> <!-- end of body container -->


<?= $this->load->view('inc/js')?>
<script type="text/javascript" charset="utf-8">
  $(document).ready(function() {

      $(document.body).on('blur','.num',function(){

           var days     = parseInt($('.month').find(':selected').data('days'));
           var tr       = $(this).closest('tr');
           var num      = parseInt(tr.find('.num').val());  


           if( num <= days ){
                $('.msg').empty();
                tr.find('.raw_score').removeClass('has-error');
                tr.css('background-color', '#bdedbc');
           }else{
                $(this).val('');
                $('.msg').html(alert_error('<strong>Days present </strong> must be less than to the total number of days '));
                tr.find('.raw_score').addClass('has-error').focus();
                tr.css('background-color', '#ffc9c9');
           }

      });

      $(document.body).on('focus','.num',function(){
          var tr = $(this).closest('tr').css('background-color', '#eee');
          //console.log('me');
      });

      $('.month').on('change', function(){

          sec_id    = $('#sec_id').val();
          athdr_id  = $(this).val();
          

          var athdr_month = $(this).find(':selected').data('month');
          var athdr_total_days = $(this).find(':selected').data('days');

          $('#athdr_month').val(athdr_month);
          $('#athdr_total_days').val(athdr_total_days);

          //('.num').val('');
          
          $('#tbl_attendance').load(base_url+'grading/get_attendance/'+athdr_id+'/'+sec_id);
      });


      $('.btn_clear').click(function(){
          $('.num').val('');
      });


      $('#frmSubmit').submit(function(e){
          e.preventDefault(); 


          var base    = $(this);
          var msg     = $(".msg");
          var btn     = base.find("button");
          var subj_id = $('.subj_id').val();

          sec_id    = $('#sec_id').val();
          athdr_id  = $(this).val();

          
          $.ajax({
                type:base.attr("method"),//get/post
                data:base.serialize(),
                url:base.attr("action"),//location for the url
                beforeSend:function(){
                  msg.empty().html(alert_minimal('Processing . . .'));
                  btn.prop("disabled",true);
                },
                success:function(rrdata){

                  btn.prop("disabled",false);
                  var rdata = $.parseJSON(rrdata);
                  if(rdata.stat){
                  msg.empty().html(alert_success(rdata.msg));
                   $('.counter').load(base_url+'grading/get_counter/'+subj_id);
                   $('.stud_table tr').css('background-color', '#fff');
                   $('.raw_score').removeClass('has-error');

                   //$('#tbl_attendance').load(base_url+'grading/get_attendance/'+athdr_id+'/'+sec_id);

                   //$('#frmSubmit')[0].reset();
                  }
                  else{   
                    msg.empty().html(alert_error(rdata.msg));
                  }
                  
                },
                error:function(rdata){
                  btn.prop("disabled",false);
                  msg.empty().html(alert_error('An error occured, please try again later'));
                }
          });

      });

  });
</script>
</body>
</html>